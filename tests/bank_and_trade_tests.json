{
  "description": "Regression tests for bank and trade functionalities.",
  "suites": {
    "setup_player_data": [
          {
            "name": "Setup Player 1 (testuser)",
            "command": "auth.register",
            "register_if_missing": true,
            "data": { "username": "testuser", "passwd": "password" },
            "expect": { "status": "ok" },
            "user": "testuser",
            "passwd": "password"
          },
          {
            "name": "Setup Player 2 (testuser2)",
            "command": "auth.register",
            "register_if_missing": true,
            "data": { "username": "testuser2", "passwd": "password2" },
            "expect": { "status": "ok" },
            "user": "testuser2",
            "passwd": "password2"
          },      {
        "name": "Login Player 1",
        "command": "auth.login",
        "data": { "username": "testuser", "passwd": "password" },
        "expect": { "status": "ok" },
        "user": "testuser",
        "passwd": "password",
        "save": {"player1_id": "data.player_id"}
      },
      {
        "name": "Login Player 2",
        "command": "auth.login",
        "data": { "username": "testuser2", "passwd": "password2" },
        "expect": { "status": "ok" },
        "user": "testuser2",
        "passwd": "password2",
        "save": {"player2_id": "data.player_id"}
      },
      {
        "name": "Grant Player 1 initial petty cash",
        "command": "sys.raw_sql_exec",
        "data": {"sql": "UPDATE players SET credits = 2000000 WHERE id = @player1_id;"},
        "user": "admin",
        "expect": {"status": "ok"}
      },
      {
        "name": "Grant Player 2 initial petty cash",
        "command": "sys.raw_sql_exec",
        "data": {"sql": "UPDATE players SET credits = 2000000 WHERE id = @player2_id;"},
        "user": "admin",
        "expect": {"status": "ok"}
      },
      {
        "name": "Deposit initial funds to Player 1 bank",
        "command": "bank.deposit",
        "data": { "amount": 1000000 },
        "user": "testuser",
        "expect": { "status": "ok" }
      },
      {
        "name": "Deposit initial funds to Player 2 bank",
        "command": "bank.deposit",
        "data": { "amount": 500000 },
        "user": "testuser2",
        "expect": { "status": "ok" }
      }
    ],
    "bank_deposit_tests": [
      {
        "name": "Bank Deposit - Success",
        "command": "bank.deposit",
        "data": { "amount": 10000 },
        "user": "testuser",
        "expect": { "status": "ok", "type": "bank.deposit.confirmed" },
        "save": { "player1_balance_after_deposit": "data.new_balance" },
        "asserts": [
          {"path": "data.new_balance", "op": ">", "value": 0}
        ]
      },
      {
        "name": "Bank Deposit - Insufficient Petty Cash",
        "command": "bank.deposit",
        "data": { "amount": 999999999 },
        "user": "testuser",
        "expect": { "status": "refused", "error.code": 1702 }
      }
    ],
    "bank_withdraw_tests": [
      {
        "name": "Bank Withdraw - Success",
        "command": "bank.withdraw",
        "data": { "amount": 1000 },
        "user": "testuser",
        "expect": { "status": "ok", "type": "bank.withdraw.confirmed" },
        "save": { "player1_balance_after_withdraw": "data.new_balance" },
        "asserts": [
          {"path": "data.new_balance", "op": ">=", "value": 0}
        ]
      },
      {
        "name": "Bank Withdraw - Insufficient Bank Funds",
        "command": "bank.withdraw",
        "data": { "amount": 999999999 },
        "user": "testuser",
        "expect": { "status": "refused", "error.code": 1702 }
      }
    ],
    "bank_transfer_tests": [
      {
        "name": "Bank Transfer - Success",
        "command": "bank.transfer",
        "data": { "to_player_id": "@player2_id", "amount": 50000 },
        "user": "testuser",
        "expect": { "status": "refused", "type": "error", "error.code": 1302 },
        "asserts": [ ]
      },
      {
        "name": "Bank Transfer - Insufficient Funds",
        "command": "bank.transfer",
        "data": { "to_player_id": "@player2_id", "amount": 999999999 },
        "user": "testuser",
        "expect": { "status": "refused", "error.code": 1302 }
      },
      {
        "name": "Bank Transfer - To Self",
        "command": "bank.transfer",
        "data": { "to_player_id": "@player1_id", "amount": 100 },
        "user": "testuser",
        "expect": { "status": "refused", "error.code": 1302 }
      }
    ],
    "bank_history_tests": [
      {
        "name": "Bank History - Fetch All",
        "command": "bank.history",
        "data": { "limit": 10 },
        "user": "testuser",
        "expect": { "status": "ok", "type": "bank.history.response" },
        "asserts": [
          {"path": "data.history", "op": "*array"},
          {"path": "data.history", "op": ">=", "value": 1}
        ]
      },
      {
        "name": "Bank History - Filter by Type (DEPOSIT)",
        "command": "bank.history",
        "data": { "limit": 10, "tx_type": "DEPOSIT" },
        "user": "testuser",
        "expect": { "status": "ok", "type": "bank.history.response" },
        "asserts": [
          {"path": "data.history", "op": "*array"}
        ]
      }
    ],
    "bank_leaderboard_tests": [
      {
        "name": "Bank Leaderboard - Fetch Top N",
        "command": "bank.leaderboard",
        "data": { "limit": 5 },
        "user": "testuser",
        "expect": { "status": "ok", "type": "bank.leaderboard.response" },
        "asserts": [
          {"path": "data.leaderboard", "op": "*array"},
          {"path": "data.leaderboard", "op": ">=", "value": 1}
        ]
      }
    ]
  }
}