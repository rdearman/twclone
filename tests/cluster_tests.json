{
  "description": "Regression tests for cluster economy, alignment, and illegal commodities.",
  "suites": {
    "setup_cluster_data": [
      {
        "name": "Clear Idempotency Table",
        "command": "sys.raw_sql_exec",
        "data": { "sql": "DELETE FROM trade_idempotency;" },
        "user": "admin",
        "expect": { "status": "ok" }
      },
      {
              "name": "Setup Good Player (goodguy)",
              "command": "auth.register",
              "data": { "username": "goodguy", "passwd": "password" },
              "expect": { "status": "ok" },        "user": "goodguy",
        "passwd": "password",
        "register_if_missing": true
      },
      {
        "name": "Setup Evil Player (badguy)",
        "command": "auth.register",
      "data": { "username": "badguy", "passwd": "password" },
        "expect": { "status": "ok" },
        "user": "badguy",
        "passwd": "password",
        "register_if_missing": true
      },
      {
        "name": "Setup Admin Player (admin)",
        "command": "auth.register",
      "data": { "username": "admin", "passwd": "password" },
      "expect": { "status": "ok" },
        "user": "admin",
        "passwd": "password",
        "register_if_missing": true
      },
      {
              "name": "Login Good Player",
              "command": "auth.login",
              "data": { "username": "goodguy", "passwd": "password" },
              "expect": { "status": "ok" },        "user": "goodguy",
        "passwd": "password",
        "save": {"goodguy_id": "data.player_id", "goodguy_session": "data.session"}
      },
      {
        "name": "Login Evil Player",
        "command": "auth.login",
        "data": { "username": "badguy", "passwd": "password" },
        "expect": { "status": "ok" },
        "user": "badguy",
        "passwd": "password",
        "save": {"badguy_id": "data.player_id", "badguy_session": "data.session"}
      },
      {
        "name": "Login Admin Player",
        "command": "auth.login",
        "data": { "username": "admin", "passwd": "password" },
        "expect": { "status": "ok" },
        "user": "admin",
        "passwd": "password",
        "save": {"admin_id": "data.player_id", "admin_session": "data.session"}
      },
      {
        "name": "Set Admin Player to SysOp Type",
        "command": "sys.raw_sql_exec",
        "data": { "sql": "UPDATE players SET type = 3 WHERE name = 'admin';" },
        "user": "admin",
        "expect": { "status": "ok" }
      },
      {
        "name": "Cleanup Old Clusters",
        "command": "sys.raw_sql_exec",
        "data": { "sql": "DELETE FROM clusters; DELETE FROM cluster_sectors; DELETE FROM cluster_commodity_index; DELETE FROM cluster_player_status;" },
        "user": "admin",
        "expect": { "status": "ok" }
      },
      {
        "name": "Force Cluster Init",
        "command": "sys.cluster.init",
        "data": {},
        "user": "admin",
        "expect": { "status": "ok" }
      },
      {
        "name": "Ensure Sector 100 Exists",
        "command": "sys.raw_sql_exec",
        "data": { "sql": "INSERT OR IGNORE INTO sectors (id, name) VALUES (100, 'Deep Space 100');" },
        "user": "admin",
        "expect": { "status": "ok" }
      },
      {
        "name": "Create Evil Cluster (ID 2)",
        "command": "sys.raw_sql_exec",
        "data": { "sql": "INSERT OR REPLACE INTO clusters (id, name, role, kind, center_sector, alignment) VALUES (2, 'Manual Evil', 'ORION', 'FACTION', 100, -100);" },
        "user": "admin",
        "expect": { "status": "ok" }
      },
      {
        "name": "Link Sector 100 to Evil Cluster",
        "command": "sys.raw_sql_exec",
        "data": { "sql": "INSERT OR REPLACE INTO cluster_sectors (cluster_id, sector_id) VALUES (2, 100);" },
        "user": "admin",
        "expect": { "status": "ok" }
      },
      {
        "name": "Ensure Port Exists in Sector 100",
        "command": "sys.raw_sql_exec",
        "data": { "sql": "INSERT OR IGNORE INTO ports (name, sector, size, techlevel, type) VALUES ('Evil Port 100', 100, 5, 8, 2);" },
        "user": "admin",
        "expect": { "status": "ok" }
      },
      {
        "name": "Get Evil Port ID",
        "command": "sys.raw_sql_exec",
        "data": { "sql": "SELECT id FROM ports WHERE name = 'Evil Port 100';" },
        "user": "admin",
        "expect": { "status": "ok" },
        "save": { "evil_port_id": "data.rows.0.0" }
      },
      {
        "name": "Create Bank Account for Evil Port",
        "command": "sys.raw_sql_exec",
        "data": { "sql": "INSERT OR IGNORE INTO bank_accounts (owner_type, owner_id, currency, balance) VALUES ('port', @evil_port_id, 'CRD', 10000000);" },
        "user": "admin",
        "expect": { "status": "ok" }
      },
      {
        "name": "Ensure Illegal Commodities Exist",
        "comment": "Define SLV, WPN, DRG in the commodities table",
        "command": "sys.raw_sql_exec",
        "data": { "sql": "INSERT OR IGNORE INTO commodities (id, code, name, illegal, base_price) VALUES (4, 'SLV', 'Slaves', 1, 1000); INSERT OR IGNORE INTO commodities (id, code, name, illegal, base_price) VALUES (5, 'WPN', 'Weapons', 1, 2000); INSERT OR IGNORE INTO commodities (id, code, name, illegal, base_price) VALUES (6, 'DRG', 'Drugs', 1, 5000);" },
        "user": "admin",
        "expect": { "status": "ok" }
      },
      {
        "name": "Stock Evil Port with Illegal Goods",
        "comment": "Add initial stock of illegal goods to Evil Port 100 in entity_stock",
        "command": "sys.raw_sql_exec",
        "data": { "sql": "INSERT OR REPLACE INTO entity_stock (entity_type, entity_id, commodity_code, quantity) VALUES ('port', @evil_port_id, 'SLV', 100); INSERT OR REPLACE INTO entity_stock (entity_type, entity_id, commodity_code, quantity) VALUES ('port', @evil_port_id, 'WPN', 100); INSERT OR REPLACE INTO entity_stock (entity_type, entity_id, commodity_code, quantity) VALUES ('port', @evil_port_id, 'DRG', 100);" },
        "user": "admin",
        "expect": { "status": "ok" }
      },
      {
        "name": "DEBUG: Verify Evil Port Stock",
        "command": "sys.raw_sql_exec",
        "data": { "sql": "SELECT commodity_code, quantity FROM entity_stock WHERE entity_type = 'port' AND entity_id = @evil_port_id;" },
        "user": "admin",
        "expect": { "status": "ok", "data.rows.0.0": "DRG", "data.rows.0.1": 100, "data.rows.1.0": "SLV", "data.rows.1.1": 100, "data.rows.2.0": "WPN", "data.rows.2.1": 100 }
      },
      {
        "name": "DEBUG: Dump Clusters Table",
        "command": "sys.raw_sql_exec",
        "data": { "sql": "SELECT * FROM clusters;" },
        "user": "admin",
        "expect": { "status": "ok" }
      },
      {
        "name": "DEBUG: Dump Cluster Sectors Table",
        "command": "sys.raw_sql_exec",
        "data": { "sql": "SELECT * FROM cluster_sectors;" },
        "user": "admin",
        "expect": { "status": "ok" }
      },
      {
        "name": "Seed Illegal Goods for Custom Cluster",
        "command": "sys.cluster.seed_illegal_goods",
        "data": {},
        "user": "admin",
        "expect": { "status": "ok" }
      },
      {
        "name": "Manually set Evil Player alignment to -200 (Evil)",
        "command": "sys.raw_sql_exec",
        "data": { "sql": "UPDATE players SET alignment = -200 WHERE name = 'badguy';" },
        "user": "admin",
        "expect": { "status": "ok" }
      },
      {
        "name": "Grant Badguy Starting Credits",
        "command": "sys.raw_sql_exec",
        "data": { "sql": "UPDATE players SET credits = 1000000 WHERE name = 'badguy';" },
        "user": "admin",
        "expect": { "status": "ok" }
      },
      {
        "name": "Manually set Good Player alignment to 100 (Good)",
        "command": "sys.raw_sql_exec",
        "data": { "sql": "UPDATE players SET alignment = 100 WHERE name = 'goodguy';" },
        "user": "admin",
        "expect": { "status": "ok" }
      },
      {
        "name": "Grant Goodguy Starting Credits",
        "command": "sys.raw_sql_exec",
        "data": { "sql": "UPDATE players SET credits = 100000000 WHERE name = 'goodguy';" },
        "user": "admin",
        "expect": { "status": "ok" }
      },
      {
        "name": "Move Good Player to Sector 100",
        "command": "sys.raw_sql_exec",
        "data": { "sql": "UPDATE players SET sector = 100 WHERE name = 'goodguy';" },
        "user": "admin",
        "expect": { "status": "ok" }
      },
      {
        "name": "Move Evil Player to Sector 100",
        "command": "sys.raw_sql_exec",
        "data": { "sql": "UPDATE players SET sector = 100 WHERE name = 'badguy';" },
        "user": "admin",
        "expect": { "status": "ok" }
      }
    ],
    "illegal_trade_tests": [
      {
        "name": "Evil Player checks Evil Port (Should SEE illegal goods)",
        "command": "port.info",
        "data": { "sector_id": 100 },
        "user": "badguy",
        "expect": { "status": "ok" },
        "save": { "evil_port_id": "data.port.id" },
        "asserts": [
          {"path": "data.port.stock.*[commodity_code=SLV].quantity", "op": ">", "value": 0},
          {"path": "data.port.stock.*[commodity_code=WPN].quantity", "op": ">", "value": 0},
          {"path": "data.port.stock.*[commodity_code=DRG].quantity", "op": ">", "value": 0}
        ]
      },
      {
        "name": "Good Player checks Evil Port (Should NOT see illegal goods)",
        "command": "port.info",
        "data": { "sector_id": 100 },
        "user": "goodguy",
        "expect": { "status": "ok" },
        "asserts": [
          {"op": "undefined", "path": "data.port.stock.*[commodity_code=SLV]"},
          {"op": "undefined", "path": "data.port.stock.*[commodity_code=WPN]"},
          {"op": "undefined", "path": "data.port.stock.*[commodity_code=DRG]"}
        ]
      },
      {
        "name": "DEBUG: Good Player current credits check",
        "command": "player.my_info",
        "user": "goodguy",
        "expect": { "status": "ok" },
        "save": { "goodguy_credits_before_trade": "data.player.credits" }
      },
      {
              "name": "Good Player attempts to buy Drugs (Refused)",
              "command": "trade.buy",
              "data": {
                  "sector_id": 100,
                  "port_id": "@evil_port_id",
                  "items": [{"commodity": "DRG", "quantity": 1}],
                  "account": 0,
                  "idempotency_key": "good_player_refused_drug_buy"
              },
              "user": "goodguy",
              "expect": { "status": "refused", "error.code": 1406 }
            },
            {
        "name": "Evil Player buys Drugs (Success)",
        "command": "trade.buy",
        "data": {
            "sector_id": 100,
            "port_id": "@evil_port_id",
            "items": [{"commodity": "DRG", "quantity": 1}],
            "idempotency_key": "evil_player_buys_drugs_success"
        },
        "expect": { "status": "ok" }
    }
    ]
  }
}