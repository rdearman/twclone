{
  "description": "Regression tests for cluster economy, alignment, and illegal commodities.",
  "suites": {
    "setup_cluster_data": [
      {
        "name": "Clear Idempotency Table",
        "command": "sys.raw_sql_exec",
        "data": { "sql": "DELETE FROM trade_idempotency;" },
        "user": "admin",
        "expect": { "status": "ok" }
      },
      {
        "name": "Setup Good Player (goodguy)",
        "command": "auth.register",
        "data": { "user_name": "goodguy", "password": "password" },
        "expect": { "status": "ok" },
        "user": "goodguy",
        "passwd": "password",
        "register_if_missing": true
      },
      {
        "name": "Setup Evil Player (badguy)",
        "command": "auth.register",
        "data": { "user_name": "badguy", "password": "password" },
        "expect": { "status": "ok" },
        "user": "badguy",
        "passwd": "password",
        "register_if_missing": true
      },
      {
        "name": "Setup Admin Player (admin)",
        "command": "auth.register",
        "data": { "user_name": "admin", "password": "password" },
        "expect": { "status": "ok" },
        "user": "admin",
        "passwd": "password",
        "register_if_missing": true
      },
      {
        "name": "Login Good Player",
        "command": "auth.login",
        "data": { "user_name": "goodguy", "password": "password" },
        "expect": { "status": "ok" },
        "user": "goodguy",
        "passwd": "password",
        "save": {"goodguy_id": "data.player_id", "goodguy_session": "data.session"}
      },
      {
        "name": "Login Evil Player",
        "command": "auth.login",
        "data": { "user_name": "badguy", "password": "password" },
        "expect": { "status": "ok" },
        "user": "badguy",
        "passwd": "password",
        "save": {"badguy_id": "data.player_id", "badguy_session": "data.session"}
      },
      {
        "name": "Login Admin Player",
        "command": "auth.login",
        "data": { "user_name": "admin", "password": "password" },
        "expect": { "status": "ok" },
        "user": "admin",
        "passwd": "password",
        "save": {"admin_id": "data.player_id", "admin_session": "data.session"}
      },
      {
        "name": "Set Admin Player to SysOp Type",
        "command": "sys.raw_sql_exec",
        "data": { "sql": "UPDATE players SET type = 3 WHERE name = 'admin';" },
        "user": "admin",
        "expect": { "status": "ok" }
      },
      {
        "name": "Cleanup Old Clusters",
        "command": "sys.raw_sql_exec",
        "data": { "sql": "DELETE FROM clusters; DELETE FROM cluster_sectors; DELETE FROM cluster_commodity_index; DELETE FROM cluster_player_status;" },
        "user": "admin",
        "expect": { "status": "ok" }
      },
      {
        "name": "Force Cluster Init",
        "command": "sys.cluster.init",
        "data": {},
        "user": "admin",
        "expect": { "status": "ok" }
      },
      {
        "name": "Ensure Sector 100 Exists",
        "command": "sys.raw_sql_exec",
        "data": { "sql": "INSERT OR IGNORE INTO sectors (id, name) VALUES (100, 'Deep Space 100');" },
        "user": "admin",
        "expect": { "status": "ok" }
      },
      {
        "name": "Create Evil Cluster (ID 2)",
        "command": "sys.raw_sql_exec",
        "data": { "sql": "INSERT OR REPLACE INTO clusters (id, name, role, kind, center_sector, alignment) VALUES (2, 'Manual Evil', 'ORION', 'FACTION', 100, -100);" },
        "user": "admin",
        "expect": { "status": "ok" }
      },
      {
        "name": "Link Sector 100 to Evil Cluster",
        "command": "sys.raw_sql_exec",
        "data": { "sql": "INSERT OR REPLACE INTO cluster_sectors (cluster_id, sector_id) VALUES (2, 100);" },
        "user": "admin",
        "expect": { "status": "ok" }
      },
      {
        "name": "Ensure Port Exists in Sector 100",
        "command": "sys.raw_sql_exec",
        "data": { "sql": "INSERT OR IGNORE INTO ports (name, sector, size, techlevel, type) VALUES ('Evil Port 100', 100, 5, 8, 2);" },
        "user": "admin",
        "expect": { "status": "ok" }
      },
      {
        "name": "Get Evil Port ID",
        "command": "sys.raw_sql_exec",
        "data": { "sql": "SELECT id FROM ports WHERE name = 'Evil Port 100';" },
        "user": "admin",
        "expect": { "status": "ok" },
        "save": { "evil_port_id": "data.rows.0.0" }
      },
      {
        "name": "Create Bank Account for Evil Port",
        "command": "sys.raw_sql_exec",
        "data": { "sql": "INSERT OR IGNORE INTO bank_accounts (owner_type, owner_id, currency, balance) VALUES ('port', @evil_port_id, 'CRD', 10000000);" },
        "user": "admin",
        "expect": { "status": "ok" }
      },
      {
        "name": "DEBUG: Dump Clusters Table",
        "command": "sys.raw_sql_exec",
        "data": { "sql": "SELECT * FROM clusters;" },
        "user": "admin",
        "expect": { "status": "ok" }
      },
      {
        "name": "DEBUG: Dump Cluster Sectors Table",
        "command": "sys.raw_sql_exec",
        "data": { "sql": "SELECT * FROM cluster_sectors;" },
        "user": "admin",
        "expect": { "status": "ok" }
      },
      {
        "name": "Seed Illegal Goods for Custom Cluster",
        "command": "sys.cluster.seed_illegal_goods",
        "data": {},
        "user": "admin",
        "expect": { "status": "ok" }
      },
      {
        "name": "Manually set Evil Player alignment to -200 (Evil)",
        "command": "sys.raw_sql_exec",
        "data": { "sql": "UPDATE players SET alignment = -200 WHERE name = 'badguy';" },
        "user": "admin",
        "expect": { "status": "ok" }
      },
      {
        "name": "Grant Badguy Starting Credits",
        "command": "sys.raw_sql_exec",
        "data": { "sql": "UPDATE players SET credits = 1000000 WHERE name = 'badguy';" },
        "user": "admin",
        "expect": { "status": "ok" }
      },
      {
        "name": "Manually set Good Player alignment to 100 (Good)",
        "command": "sys.raw_sql_exec",
        "data": { "sql": "UPDATE players SET alignment = 100 WHERE name = 'goodguy';" },
        "user": "admin",
        "expect": { "status": "ok" }
      },
      {
        "name": "Grant Goodguy Starting Credits",
        "command": "sys.raw_sql_exec",
        "data": { "sql": "UPDATE players SET credits = 1000000 WHERE name = 'goodguy';" },
        "user": "admin",
        "expect": { "status": "ok" }
      },
      {
        "name": "Move Good Player to Sector 100",
        "command": "sys.raw_sql_exec",
        "data": { "sql": "UPDATE players SET sector = 100 WHERE name = 'goodguy';" },
        "user": "admin",
        "expect": { "status": "ok" }
      },
      {
        "name": "Move Evil Player to Sector 100",
        "command": "sys.raw_sql_exec",
        "data": { "sql": "UPDATE players SET sector = 100 WHERE name = 'badguy';" },
        "user": "admin",
        "expect": { "status": "ok" }
      }
    ],
    "illegal_trade_tests": [
      {
        "name": "Evil Player checks Evil Port (Should SEE illegal goods)",
        "command": "port.info",
        "data": { "sector_id": 100 },
        "user": "badguy",
        "expect": { "status": "ok" },
        "save": { "evil_port_id": "data.port.id" },
        "asserts": [
          {"op": "defined", "path": "data.port.slaves_on_hand"},
          {"op": "defined", "path": "data.port.weapons_on_hand"},
          {"op": "defined", "path": "data.port.drugs_on_hand"}
        ]
      },
      {
        "name": "Good Player checks Evil Port (Should NOT see illegal goods)",
        "command": "port.info",
        "data": { "sector_id": 100 },
        "user": "goodguy",
        "expect": { "status": "ok" },
        "asserts": [
          {"op": "undefined", "path": "data.port.slaves_on_hand"},
          {"op": "undefined", "path": "data.port.weapons_on_hand"},
          {"op": "undefined", "path": "data.port.drugs_on_hand"}
        ]
      },
            {
              "name": "Good Player attempts to buy Drugs (Refused)",
              "command": "trade.buy",
              "data": {
                  "sector_id": 100,
                  "port_id": "@evil_port_id",
                  "items": [{"commodity": "DRG", "quantity": 1}],
                  "idempotency_key": "good_player_refused_drug_buy"
              },
              "user": "goodguy",
              "expect": { "status": "refused", "error.code": 1406 }
            },      {
        "name": "Evil Player buys Drugs (Success)",
        "command": "trade.buy",
        "data": { 
            "sector_id": 100,
            "port_id": "@evil_port_id",
            "items": [{"commodity": "DRG", "quantity": 1}],
            "idempotency_key": "evil_player_drug_buy_success"
        },
        "user": "badguy",
        "expect": { "status": "ok" }
      }
    ]
  }
}