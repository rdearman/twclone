[
  {
    "name": "Register Admin for Ferengi Tests",
    "command": "auth.register",
    "data": {
      "username": "ferengi_admin",
      "passwd": "password"
    },
    "save_vars": {
      "admin_id": "id",
      "admin_session": "session"
    }
  },
  {
    "name": "Login Admin for Ferengi Tests",
    "command": "auth.login",
    "data": {
      "username": "ferengi_admin",
      "passwd": "password"
    },
    "save_vars": {
      "admin_session": "session"
    }
  },
  {
    "name": "Set Admin to SysOp",
    "command": "sys.raw_sql_exec",
    "data": {
      "sql": "UPDATE players SET type = 3 WHERE name = 'ferengi_admin';"
    },
    "auth": {
      "session": "@admin_session"
    }
  },
  {
    "name": "Cleanup: Remove Old Ferengi Data",
    "command": "sys.raw_sql_exec",
    "data": {
      "sql": "DELETE FROM players WHERE name='FerengiCEO'; DELETE FROM corporations WHERE tag='FENG';"
    },
    "auth": {
      "session": "@admin_session"
    }
  },
  {
    "name": "Setup: Create Ferengi CEO and Corp",
    "command": "sys.raw_sql_exec",
    "data": {
      "sql": "INSERT OR IGNORE INTO players (name, passwd, type) VALUES ('FerengiCEO', 'password', 0); INSERT OR IGNORE INTO corporations (name, tag, owner_id) SELECT 'Ferengi Alliance', 'FENG', id FROM players WHERE name='FerengiCEO';"
    },
    "auth": {
      "session": "@admin_session"
    }
  },
  {
    "name": "Setup: Get IDs",
    "command": "sys.raw_sql_exec",
    "data": {
      "sql": "SELECT id FROM players WHERE name='FerengiCEO'; SELECT id FROM corporations WHERE tag='FENG';"
    },
    "auth": {
      "session": "@admin_session"
    },
    "save_vars": {
      "ceo_id": "data.0.0",
      "corp_id": "data.1.0"
    }
  },
  {
    "name": "Setup: Create Ferengi Corp Bank Account",
    "command": "sys.raw_sql_exec",
    "data": {
      "sql": "INSERT OR IGNORE INTO bank_accounts (owner_type, owner_id, balance) VALUES ('corp', @corp_id, 10000000); UPDATE bank_accounts SET balance = 10000000 WHERE owner_type='corp' AND owner_id=@corp_id;"
    },
    "auth": {
      "session": "@admin_session"
    }
  },
  {
    "name": "Setup: Create/Reset Ferengi Ship",
    "command": "sys.raw_sql_exec",
    "data": {
      "sql": "DELETE FROM ships WHERE id IN (SELECT ship_id FROM ship_ownership WHERE player_id = @ceo_id); DELETE FROM ship_ownership WHERE player_id = @ceo_id; INSERT INTO ships (name, sector, type_id, holds, ore, organics, equipment) VALUES ('Ferengi Trader 1', 1, 1, 100, 0, 0, 0); INSERT INTO ship_ownership (ship_id, player_id, role_id, is_primary) VALUES (last_insert_rowid(), @ceo_id, 1, 1);"
    },
    "auth": {
      "session": "@admin_session"
    }
  },
  {
    "name": "Setup: Initialize Port 1 (Cheap ORE)",
    "command": "sys.raw_sql_exec",
    "data": {
      "sql": "DELETE FROM commodity_orders; DELETE FROM entity_stock WHERE entity_type='port' AND entity_id=1; UPDATE ports SET size=100, type=1 WHERE id=1; INSERT INTO entity_stock (entity_type, entity_id, commodity_code, quantity) VALUES ('port', 1, 'ORE', 90000); INSERT INTO entity_stock (entity_type, entity_id, commodity_code, quantity) VALUES ('port', 1, 'ORG', 10000);"
    },
    "auth": {
      "session": "@admin_session"
    }
  },
  {
    "name": "Setup: Initialize Port 1 Bank Account",
    "command": "sys.raw_sql_exec",
    "data": {
      "sql": "INSERT OR IGNORE INTO bank_accounts (owner_type, owner_id, balance) VALUES ('port', 1, 1000000); UPDATE bank_accounts SET balance=1000000 WHERE owner_type='port' AND owner_id=1;"
    },
    "auth": {
      "session": "@admin_session"
    }
  },
  {
    "name": "Test 1: Ferengi Buys Cheap ORE",
    "command": "sys.npc.ferengi_tick_once",
    "data": {},
    "auth": {
      "session": "@admin_session"
    },
    "assert": {
      "success": true
    }
  },
  {
    "name": "Verify Test 1: Ship Cargo Increased",
    "command": "sys.raw_sql_exec",
    "data": {
      "sql": "SELECT ore FROM ships WHERE id IN (SELECT ship_id FROM ship_ownership WHERE player_id = @ceo_id);"
    },
    "auth": {
      "session": "@admin_session"
    },
    "assert": {
      "success": true,
      "data.0.0": { "gt": 0 }
    }
  },
  {
    "name": "Verify Test 1: Port Stock Decreased",
    "command": "sys.econ.port_status",
    "data": {
      "port_id": 1
    },
    "auth": {
      "session": "@admin_session"
    },
    "assert": {
      "success": true,
      "data.stock.0.quantity": { "lt": 90000 }
    }
  },
  {
    "name": "Verify Test 1: Corp Balance Decreased",
    "command": "sys.raw_sql_exec",
    "data": {
      "sql": "SELECT balance FROM bank_accounts WHERE owner_type='corp' AND owner_id=@corp_id;"
    },
    "auth": {
      "session": "@admin_session"
    },
    "assert": {
      "success": true,
      "data.0.0": { "lt": 10000000 }
    }
  },
  {
    "name": "Setup: Initialize Port 1 (Expensive ORE - Demand)",
    "command": "sys.raw_sql_exec",
    "data": {
      "sql": "UPDATE entity_stock SET quantity = 0 WHERE entity_type='port' AND entity_id=1 AND commodity_code='ORE'; UPDATE ships SET ore=50 WHERE id IN (SELECT ship_id FROM ship_ownership WHERE player_id = @ceo_id);"
    },
    "auth": {
      "session": "@admin_session"
    }
  },
  {
    "name": "Test 2: Ferengi Sells Expensive ORE",
    "command": "sys.npc.ferengi_tick_once",
    "data": {},
    "auth": {
      "session": "@admin_session"
    },
    "assert": {
      "success": true
    }
  },
  {
    "name": "Verify Test 2: Ship Cargo Decreased",
    "command": "sys.raw_sql_exec",
    "data": {
      "sql": "SELECT ore FROM ships WHERE id IN (SELECT ship_id FROM ship_ownership WHERE player_id = @ceo_id);"
    },
    "auth": {
      "session": "@admin_session"
    },
    "assert": {
      "success": true,
      "data.0.0": { "lt": 50 }
    }
  },
  {
    "name": "Verify Test 2: Port Stock Increased",
    "command": "sys.econ.port_status",
    "data": {
      "port_id": 1
    },
    "auth": {
      "session": "@admin_session"
    },
    "assert": {
      "success": true,
      "data.stock.0.quantity": { "gt": 0 }
    }
  },
  {
    "name": "Verify Test 2: Corp Balance Increased",
    "command": "sys.raw_sql_exec",
    "data": {
      "sql": "SELECT balance FROM bank_accounts WHERE owner_type='corp' AND owner_id=@corp_id;"
    },
    "auth": {
      "session": "@admin_session"
    },
    "assert": {
      "success": true,
      "data.0.0": { "gt": 9000000 }
    }
  }
]