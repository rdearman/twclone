[
  {
    "name": "hello/capabilities",
    "command": { "command": "system.hello", "data": { "client": "tw-tests", "version": "0.1" } },
    "expect": { "status": "ok", "type": "session.hello" }
  },
  {
    "name": "auth/register (fresh user)",
    "command": { "command": "auth.register", "data": { "user_name": "UT_SubUser_1", "password": "secret" } },
    "expect": { "status": "ok", "type": "auth.session" }
  },
  {
    "name": "subscribe.add system.notice (idempotent #1)",
    "command": { "command": "subscribe.add", "data": { "topic": "system.notice" } },
    "expect": { "status": "ok" }
  },
  {
    "name": "subscribe.add system.notice (idempotent #2, no error)",
    "command": { "command": "subscribe.add", "data": { "topic": "system.notice" } },
    "expect": { "status": "ok" }
  },
  {
    "name": "subscribe.add sector.42",
    "command": { "command": "subscribe.add", "data": { "topic": "sector.42" } },
    "expect": { "status": "ok" }
  },
  {
    "name": "subscribe.add sector.*",
    "command": { "command": "subscribe.add", "data": { "topic": "sector.*" } },
    "expect": { "status": "ok" }
  },
  {
    "name": "subscribe.list (after adds)",
    "command": { "command": "subscribe.list" },
    "expect": { "status": "ok", "type": "subscribe.list_v1" }
  },
  {
    "name": "subscribe.remove sector.42",
    "command": { "command": "subscribe.remove", "data": { "topic": "sector.42" } },
    "expect": { "status": "ok" }
  },
  {
    "name": "subscribe.list (after remove)",
    "command": { "command": "subscribe.list" },
    "expect": { "status": "ok", "type": "subscribe.list_v1" }
  },
  {
    "name": "subscribe.add invalid topic â†’ refused 1403",
    "command": { "command": "subscribe.add", "data": { "topic": "nonsense.topic" } },
    "expect": { "status": "refused", "code": 1403 }
  }
,
{
  "name": "player.set_prefs (two items)",
  "command": {
    "command": "player.set_prefs",
    "data": {
      "items": [
        { "key": "ui.locale", "type": "string", "value": "en-GB" },
        { "key": "ui.clock_24h", "type": "bool",  "value": "true" }
      ]
    }
  },
  "expect": { "status": "ok", "type": "player.pref.ack_v1" }
},
{
  "name": "player.get_prefs (verify round-trip)",
  "command": { "command": "player.get_prefs" },
  "expect": { "status": "ok", "type": "player.prefs_v1" }
}

,
{
  "name": "hello has ISO ts",
  "command": { "command": "system.hello", "data": { "client": "tw-tests", "version": "0.1" } },
  "expect": { "status": "ok", "type": "session.hello", "ts_regex": "^[0-9]{4}-[0-9]{2}-[0-9]{2}T[0-9]{2}:[0-9]{2}:[0-9]{2}Z$" }
},
{
  "name": "prefs.set with ANSI value (should be sanitized on read)",
  "command": {
    "command": "player.set_prefs",
    "data": {
      "items": [
        { "key": "ui.banner", "type": "string", "value": "X \u001b[31mRED\u001b[0m Y" }
      ]
    }
  },
  "expect": { "status": "ok", "type": "player.pref.ack_v1" }
},
{
  "name": "prefs.get shows sanitized value (no ANSI)",
  "command": { "command": "player.get_prefs" },
  "expect": {
    "status": "ok",
    "type": "player.prefs_v1",
    "assert_prefs": [
      { "key": "ui.banner", "type": "string", "value": "X RED Y" }
    ]
  }
}

,
{
  "name": "hello has ISO ts",
  "command": { "command": "system.hello", "data": { "client": "tw-tests", "version": "0.1" } },
  "expect": {
    "status": "ok",
    "type": "session.hello",
    "ts_regex": "^[0-9]{4}-[0-9]{2}-[0-9]{2}T[0-9]{2}:[0-9]{2}:[0-9]{2}Z$"
  }
},
{
  "name": "prefs.set with ANSI value (should be sanitized on read)",
  "command": {
    "command": "player.set_prefs",
    "data": {
      "items": [
        { "key": "ui.banner", "type": "string", "value": "X \u001b[31mRED\u001b[0m Y" }
      ]
    }
  },
  "expect": { "status": "ok", "type": "player.pref.ack_v1" }
},
{
  "name": "prefs.get shows sanitized value (no ANSI)",
  "command": { "command": "player.get_prefs" },
  "expect": {
    "status": "ok",
    "type": "player.prefs_v1",
    "assert_prefs": [
      { "key": "ui.banner", "type": "string", "value": "X RED Y" }
    ]
  }
}


    ,
{
  "name": "auth/register fresh user (hydration happens)",
  "command": { "command": "auth.register", "data": { "user_name": "UT_SubUser_1", "password": "secret" } },
  "expect": { "status": "ok", "type": "auth.session" }
},
{
  "name": "subscribe.list contains locked system.notice after login",
  "command": { "command": "subscribe.list" },
  "expect": { "status": "ok", "type": "subscribe.list_v1" }
},
{
  "name": "unsubscribe locked topic is refused",
  "command": { "command": "subscribe.remove", "data": { "topic": "system.notice" } },
  "expect": { "status": "refused", "code": 1405 }
},
{
  "name": "prefs exist after login (defaults seeded)",
  "command": { "command": "player.get_prefs" },
  "expect": {
    "status": "ok",
    "type": "player.prefs_v1",
    "assert_prefs": [
      { "key": "ui.ansi", "type": "bool", "value": "true" },
      { "key": "ui.clock_24h", "type": "bool", "value": "true" },
      { "key": "ui.locale", "type": "string", "value": "en-GB" },
      { "key": "ui.page_length", "type": "int", "value": "20" },
      { "key": "privacy.dm_allowed", "type": "bool", "value": "true" }
    ]
  }
}

,
{
  "name": "bookmark.add A=42",
  "command": { "command": "nav.bookmark.add", "data": { "name": "A", "sector_id": 42 } },
  "expect": { "status": "ok", "type": "nav.bookmark.ack_v1" }
},
{
  "name": "bookmark.add A=42 idempotent",
  "command": { "command": "nav.bookmark.add", "data": { "name": "A", "sector_id": 42 } },
  "expect": { "status": "ok", "type": "nav.bookmark.ack_v1" }
},
{
  "name": "bookmark.add A=77 (update)",
  "command": { "command": "nav.bookmark.add", "data": { "name": "A", "sector_id": 77 } },
  "expect": { "status": "ok", "type": "nav.bookmark.ack_v1" }
},
{
  "name": "bookmark.list",
  "command": { "command": "nav.bookmark.list" },
  "expect": { "status": "ok", "type": "nav.bookmark.list_v1" }
},
{
  "name": "bookmark.remove A",
  "command": { "command": "nav.bookmark.remove", "data": { "name": "A" } },
  "expect": { "status": "ok", "type": "nav.bookmark.ack_v1" }
},
{
  "name": "bookmark.list (after remove)",
  "command": { "command": "nav.bookmark.list" },
  "expect": { "status": "ok", "type": "nav.bookmark.list_v1" }
},
{
  "name": "avoid.add 99",
  "command": { "command": "nav.avoid.add", "data": { "sector_id": 99 } },
  "expect": { "status": "ok", "type": "nav.avoid.ack_v1" }
},
{
  "name": "avoid.add 99 idempotent",
  "command": { "command": "nav.avoid.add", "data": { "sector_id": 99 } },
  "expect": { "status": "ok", "type": "nav.avoid.ack_v1" }
},
{
  "name": "avoid.list (after add)",
  "command": { "command": "nav.avoid.list" },
  "expect": { "status": "ok", "type": "nav.avoid.list_v1" }
},
{
  "name": "avoid.remove 99",
  "command": { "command": "nav.avoid.remove", "data": { "sector_id": 99 } },
  "expect": { "status": "ok", "type": "nav.avoid.ack_v1" }
},
{
  "name": "avoid.list (after remove)",
  "command": { "command": "nav.avoid.list" },
  "expect": { "status": "ok", "type": "nav.avoid.list_v1" }
}
    
]
