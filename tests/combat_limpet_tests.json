[
  {
    "name": "Register Admin",
    "command": "auth.register",
    "data": {
      "username": "limpet_admin",
      "passwd": "password"
    },
    "save_vars": {
      "admin_id": "id",
      "admin_session": "session"
    }
  },
  {
    "name": "Login Admin",
    "command": "auth.login",
    "data": {
      "username": "limpet_admin",
      "passwd": "password"
    },
    "save_vars": {
      "admin_session": "session"
    }
  },
  {
    "name": "Set Admin to SysOp",
    "command": "sys.raw_sql_exec",
    "data": {
      "sql": "UPDATE players SET type = 3 WHERE name = 'limpet_admin';"
    },
    "auth": {
      "session": "@admin_session"
    }
  },
  {
    "name": "Register Limpet Owner (Player A)",
    "command": "auth.register",
    "data": {
      "username": "limpet_owner",
      "passwd": "password",
      "ship_name": "Layer Ship"
    },
    "save_vars": {
      "owner_id": "id",
      "owner_session": "session"
    }
  },
  {
    "name": "Register Victim (Player B)",
    "command": "auth.register",
    "data": {
      "username": "limpet_victim",
      "passwd": "password",
      "ship_name": "Target Ship"
    },
    "save_vars": {
      "victim_id": "id",
      "victim_session": "session"
    }
  },
  {
    "name": "Login Victim",
    "command": "auth.login",
    "data": {
      "username": "limpet_victim",
      "passwd": "password"
    },
    "save_vars": {
      "victim_session": "session"
    }
  },
  {
    "name": "Setup: Initialize Sector 210",
    "command": "sys.raw_sql_exec",
    "data": {
      "sql": "INSERT OR IGNORE INTO sectors (id, name) VALUES (210, 'Limpet Field'); INSERT OR IGNORE INTO sector_warps (from_sector, to_sector) VALUES (1, 210), (210, 1);"
    },
    "auth": {
      "session": "@admin_session"
    }
  },
  {
    "name": "Setup: Clear Assets & Attachments",
    "command": "sys.raw_sql_exec",
    "data": {
      "sql": "DELETE FROM sector_assets WHERE sector=210; DELETE FROM limpet_attached;"
    },
    "auth": {
      "session": "@admin_session"
    }
  },
  {
    "name": "Test 1: Deploy Limpets (10)",
    "command": "sys.raw_sql_exec",
    "data": {
      "sql": "INSERT INTO sector_assets (sector, player, asset_type, quantity, offensive_setting, deployed_at) VALUES (210, @owner_id, 4, 10, 1, strftime('%s','now'));"
    },
    "auth": {
      "session": "@admin_session"
    }
  },
  {
    "name": "Reset Victim State",
    "command": "sys.raw_sql_exec",
    "data": {
      "sql": "UPDATE players SET sector=1 WHERE id=@victim_id; UPDATE ships SET sector=1 WHERE id IN (SELECT ship_id FROM ship_ownership WHERE player_id=@victim_id);"
    },
    "auth": {
      "session": "@admin_session"
    }
  },
  {
    "name": "Sync Victim Context (Warp to 1)",
    "command": "move.warp",
    "data": {
      "to_sector_id": 1
    },
    "auth": {
      "session": "@victim_session"
    },
    "assert": {
      "success": true
    }
  },
  {
    "name": "Test 1: Victim Enters Sector 210 (Attach)",
    "command": "move.warp",
    "data": {
      "to_sector_id": 210
    },
    "auth": {
      "session": "@victim_session"
    },
    "assert": {
      "success": true
    }
  },
  {
    "name": "Test 1: Verify Limpet Consumed (Should be 9)",
    "command": "sys.raw_sql_exec",
    "data": {
      "sql": "SELECT quantity FROM sector_assets WHERE sector=210 AND asset_type=4;"
    },
    "auth": {
      "session": "@admin_session"
    },
    "assert": {
      "success": true,
      "data.0.0": 9
    }
  },
  {
    "name": "Test 1: Verify Attachment",
    "command": "sys.raw_sql_exec",
    "data": {
      "sql": "SELECT count(*) FROM limpet_attached WHERE owner_player_id=@owner_id AND ship_id IN (SELECT ship_id FROM ship_ownership WHERE player_id=@victim_id);"
    },
    "auth": {
      "session": "@admin_session"
    },
    "assert": {
      "success": true,
      "data.0.0": 1
    }
  },
  {
    "name": "Reset Victim (Warp to 1)",
    "command": "move.warp",
    "data": {
      "to_sector_id": 1
    },
    "auth": {
      "session": "@victim_session"
    },
    "assert": {
      "success": true
    }
  },
  {
    "name": "Test 2: Victim Enters 210 Again (Refresh/Idempotency)",
    "command": "move.warp",
    "data": {
      "to_sector_id": 210
    },
    "auth": {
      "session": "@victim_session"
    },
    "assert": {
      "success": true
    }
  },
  {
    "name": "Test 2: Verify Limpet NOT Consumed (Already Attached)",
    "command": "sys.raw_sql_exec",
    "data": {
      "sql": "SELECT quantity FROM sector_assets WHERE sector=210 AND asset_type=4;"
    },
    "auth": {
      "session": "@admin_session"
    },
    "assert": {
      "success": true,
      "data.0.0": 9
    }
  },
  {
    "name": "Test 2: Verify Attachment Count Still 1",
    "command": "sys.raw_sql_exec",
    "data": {
      "sql": "SELECT count(*) FROM limpet_attached WHERE owner_player_id=@owner_id AND ship_id IN (SELECT ship_id FROM ship_ownership WHERE player_id=@victim_id);"
    },
    "auth": {
      "session": "@admin_session"
    },
    "assert": {
      "success": true,
      "data.0.0": 1
    }
  },
  {
    "name": "Reset Victim (Warp to 1)",
    "command": "move.warp",
    "data": {
      "to_sector_id": 1
    },
    "auth": {
      "session": "@victim_session"
    },
    "assert": {
      "success": true
    }
  },
  {
    "name": "Test 3: Friendly Entry (Owner enters)",
    "command": "sys.raw_sql_exec",
    "data": {
      "sql": "UPDATE players SET sector=1 WHERE id=@owner_id; UPDATE ships SET sector=1 WHERE id IN (SELECT ship_id FROM ship_ownership WHERE player_id=@owner_id);"
    },
    "auth": {
      "session": "@admin_session"
    }
  },
  {
    "name": "Login Owner",
    "command": "auth.login",
    "data": {
      "username": "limpet_owner",
      "passwd": "password"
    },
    "save_vars": {
      "owner_session": "session"
    }
  },
  {
    "name": "Sync Owner Context",
    "command": "move.warp",
    "data": {
      "to_sector_id": 1
    },
    "auth": {
      "session": "@owner_session"
    },
    "assert": {
      "success": true
    }
  },
  {
    "name": "Test 3: Owner Enters 210",
    "command": "move.warp",
    "data": {
      "to_sector_id": 210
    },
    "auth": {
      "session": "@owner_session"
    },
    "assert": {
      "success": true
    }
  },
  {
    "name": "Test 3: Verify No Consumption (Friendly)",
    "command": "sys.raw_sql_exec",
    "data": {
      "sql": "SELECT quantity FROM sector_assets WHERE sector=210 AND asset_type=4;"
    },
    "auth": {
      "session": "@admin_session"
    },
    "assert": {
      "success": true,
      "data.0.0": 9
    }
  },
  {
    "name": "Test 3: Verify No Self-Attachment",
    "command": "sys.raw_sql_exec",
    "data": {
      "sql": "SELECT count(*) FROM limpet_attached WHERE owner_player_id=@owner_id AND ship_id IN (SELECT ship_id FROM ship_ownership WHERE player_id=@owner_id);"
    },
    "auth": {
      "session": "@admin_session"
    },
    "assert": {
      "success": true,
      "data.0.0": 0
    }
  }
]
