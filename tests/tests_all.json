{
    "tests":
    [

    {
      "name": "auth.register (new user)",
      "cmd": "auth.register",
      "data": {
        "user_name": "test_user_tbd",
        "password": "password123"
      },
      "expect": {
        "status": "error",
        "type": "error",
        "error": {
          "code": 1210,
          "message": "Username already exists"
        }
      }
    },

	{
	    "name": "player.my_info",
	    "cmd": "player.my_info",
	    "expect": {
		"status": "ok",
		"type": "player.info",
		"data": { "player": "*", "ship": "*" }
	    },
	    "capture": {
		"my_id": "data.player.id",
		"my_name": "data.player.name", 
		"curSector": "data.ship.location.sector_id"
	    }
	},
      {
      "name": "sector.search (by text)",
      "cmd": "sector.search",
      "data": {
        "q": "Federation"
      },
      "expect": {
        "status": "ok",
        "type": "sector.search_results_v1",
        "data": {
          "items": "*array"
        }
      }
      },
	
	{
	    "name": "mail.send",
	    "cmd": "mail.send",
	    "data": {
		"to": "@my_name", 
		"subject": "Hello",
		"body": "Test"
	    },
	    "expect": {
		"status": "ok",
		"type": "mail.sent",
		"data": {
		    "id": "*" 
		}
	    }
	},

	{
	    "name": "mail.inbox",
	    "cmd": "mail.inbox",
	    "data": {
		"limit": 5
	    },
	    "expect": {
		"status": "ok",
		"type": "mail.inbox_v1",
		"data": {
		    "items": "*array"
		}
	    }
	},
	{
	    "name": "mail.delete (ids array)",
	    "cmd": "mail.delete",
	    "data": {
		"ids": [
		    1
		]
	    },
	    "expect": {
		"status": "ok",
		"type": "mail.deleted"
	    }
	},
	
    {
      "name": "auth.login",
      "cmd": "auth.login",
      "data": {
        "user_name": "@user",
        "password": "@passwd"
      },
      "expect": {
        "status": "error",
        "type": "error",
        "error": {
          "code": 1220,
          "message": "Invalid credentials"
        }
      }
    },
      {
	  "name": "system.hello",
	  "cmd": "system.hello",
	  "expect": {
	      "id": "srv-ok",
	      "ts": "*",
	      "status": "ok",
	      "type": "session.hello",
	      "data": {
		  "protocol_version": "*",
		  "server_time_unix": "*",
		  "authenticated": true,
		  "player_id": "*",
		  "current_sector": "*",
		  "server_time": "*"
	      },
	      "error": null,
	      "meta": "*"
	  },
	  "capture": { "curSector": "data.current_sector" }
      },
      {
	  "name": "sector.info (current)",
	  "cmd": "move.describe_sector",
	  "data": { "sector_id": "@curSector" },
	  "expect": {
	      "id": "srv-ok",
	      "ts": "*",
	      "status": "ok",
	      "type": "sector.info",
	      "data": {
		  "sector_id": "*",
		  "ports": "*array"
	      },
	      "meta": "*"
	  },
	  "asserts": [
	      { "path": "data.sector_id", "op": ">", "value": 0 }
	  ],
	  "capture": {
	      "portId": "data.ports.0.id"
	  }
      },
      {
	  "name": "system.capabilities",
	  "cmd": "system.capabilities",
	  "expect": {
	      "id": "srv-ok",
	      "ts": "*",
	      "status": "ok",
	      "type": "system.capabilities",
	      "data": {
		  "limits": {
		      "max_bulk": "*",
		      "max_page_size": "*",
		      "max_beacon_len": "*"
		  },
		  "features": {
		      "auth": "*",
		      "warp": "*",
		      "sector.describe": "*",
		      "trade.buy": "*",
		      "server_autopilot": "*"
		  },
		  "version": "*"
	      },
	      "error": null,
	      "meta": "*"
	  }
      },
      {
	  "name": "player.my_info",
	  "cmd": "player.my_info",
	  "expect": {
	      "id": "srv-ok",
	      "ts": "*",
	      "status": "ok",
	      "type": "player.info",
	      "data": { "player": "*", "ship": "*" },
	      "error": null,
	      "meta": "*"
	  },
	  "capture": {
	      "my_id": "data.player.id",
	      "curSector": "data.ship.location.sector_id"
	  }
      },
      {
	  "name": "ship.info",
	  "cmd": "ship.info",
	  "expect": {
	      "id": "srv-ok",
	      "ts": "*",
	      "status": "ok",
              "type": "ship.status",
              "data": {
		  "ship": "*"
	      },
	      "error": null,
	      "meta": "*"

	  }
      },
      {
      "name": "move.autopilot.status (NIY)",
      "cmd": "move.autopilot.status",
      "expect": {
        "status": "error",
        "type": "error",
        "error": {
          "code": 1101
        }
      }
    },

      {
          "name": "move.autopilot.start (ok)",
          "cmd": "move.autopilot.start",
          "data": {
              "to": 10 
          },
          "expect": {
              "status": "ok",
              "type": "move.path_v1"
          },
          "asserts": [
              { "path": "data.total_cost", "op": "==", "value": 8 },
              { "path": "data.steps.0", "op": "==", "value": 155 }
          ]
      },
      {
      "name": "move.autopilot.stop (NIY)",
      "cmd": "move.autopilot.stop",
      "expect": {
        "status": "error",
        "type": "error",
        "error": {
          "code": 1101
        }
      }
    },
      {
	  "name": "Set Test Beacon",
	  "command": "sector.set_beacon",
	  "data": {
	      "sector_id": "@curSector",
	      "text": "TESTING!"
	  }
      },

      {
	  "name": "system.describe_schema (system)",
	  "cmd": "system.describe_schema",
	  "data": {
	      "name": "auth.login" 
	  },
	  "expect": {
	      "status": "ok",
	      "type": "system.describe_schema",
	      "data": {
	          "name": "auth.login",
	          "messages": "*array"
	      }
	  }
      },

      
      {
	  "name": "move.pathfind RRD CHECKS",
	  "cmd": "move.pathfind",
	  "data": {
	      "from": 1,
	      "to": 10
	  },
	  "expect": {
	      "status": "ok",
	      "type": "move.path_v1",
	      "data": "*",
	      "meta": "*"
	  }
      },


      {
	  "name": "move.warp (Sector 2)",
	  "cmd": "move.warp",
	  "data": {
	      "from_sector_id": "@curSector",
	      "to_sector_id": 2
	  },
	  "expect": {
	      "status": "refused",
	      "type": "error",
	      "error": { "code": "*" },
	      "meta": "*"
	  }
      },
      

      
    {
      "name": "move.warp refused: to current sector",
      "cmd": "move.warp",
      "data": {
        "from": "@curSector",
        "to_sector_id": "@curSector"
      },
      "expect": {
        "status": "refused",
        "error": {
          "code": "*any"
        }
      }
    },

      {
      "name": "trade.history (no next_cursor required)",
      "cmd": "trade.history",
      "data": {
          "limit": 5,
        "player_id": "@my_id"	  
      },
      "expect": {
        "status": "ok",
          "type": "trade.history",
        "data": {
          "history": "*array"
        }
      }
      },

	{
      "name": "combat.deploy_fighters ok",
      "cmd": "combat.deploy_fighters",
      "idempotency_key": "test-fighters-deploy-1762338651-2237",
      "data": {
        "amount": 1,
	  "to_sector": "@curSector",
          "offense": 2
      },
      "expect": {
        "status": "ok",
        "type": "combat.fighters.deployed"
      }
    },

	{
      "name": "deploy.fighters.list (current sector)",
      "cmd": "deploy.fighters.list",
      "data": {
        "sector_id": 51
      },
      "expect": {
        "status": "ok",
        "type": "Deploy.fighters.list_v1",
        "data": {
          "total": "*",
          "entries": [
            {
              "sector_id": "*",
              "count": "*",
              "offense_mode": "*",
              "player_id": "*",
              "player_name": "*",
              "corp_id": "*",
              "corp_tag": "*",
              "type": "*"
            }
          ]
        }
      }
	},

	{
	    "name": "combat.lay_mines ok",
	    "cmd": "combat.lay_mines",
	    "idempotency_key": "test-mines-deploy-1762338651-2237",
	    "data": {
		"amount": 1,
		"mine_type": 4 
	    },
	    "expect": {
		"status": "ok",
		"type": "combat.mines.deployed" 
	    }
	},
	{
	    "name": "deploy.mines.list (current sector)",
	    "cmd": "deploy.mines.list",
	    "data": {
		"sector_id": 51
	    },
	    "expect": {
		"status": "ok",
		"type": "deploy.mines.list_v1",
		"data": {
		    "total": "*",
		    "entries": "*array"
		}
            }
	},
    {
      "name": "notice.create (system)",
      "cmd": "sys.notice.create",
      "data": {
        "title": "Test notice",
        "body": "This is a test notice",
        "severity": "info"
      },
      "expect": {
        "status": "ok",
        "type": "announce.created",
        "data": {
          "id": "*",
          "title": "*",
          "body": "*",
          "severity": "info"
        }
      }
    },
    {
      "name": "notice.list (no next_cursor required)",
      "cmd": "notice.list",
      "data": {
        "limit": 5
      },
      "expect": {
        "status": "ok",
        "type": "notice.list_v1",
        "data": {
          "items": "*array"
        }
      }
    },
	{
	    "name": "TRADE.BUY ( FORCE ID)",
	    "cmd": "trade.buy",
	    "idempotency_key": "test-buy-single-1762338651-2594",
	    "data": {
		"port_id": "@portId",
        "account": 0,
        "items": [
            {
                "commodity": "ore",
                "quantity": 1
            }
        ]
	    },
	    "expect": {
		"status": "ok",
		"type": "trade.buy_receipt_v1"
	    }
	},

	{
	    "name": "trade.buy ok (items list)",
	    "cmd": "trade.buy",
	    "data": {
		"port_id": "@portId",
        "account": 0,
		"items": [
		    {
			"commodity": "ore",
			"quantity": 1
		    }
		]
	    },
	    "expect": {
		"status": "ok",
		"type": "trade.buy_receipt_v1"
	    }
	},
	{
	    "name": "trade.buy idempotent replay",
	    "cmd": "trade.buy",
	    "idempotency_key": "@prev_idempotency_key",
	    "data": {
		"port_id": "@portId",
        "account": 0,
		"items": [
		    {
			"commodity": "ore",
			"quantity": 1
		    }
		]
	    },
	    "expect": {
		"status": "ok",
		"type": "trade.buy_receipt_v1"
	    }
	},
	{
	    "name": "trade.sell refused invalid commodity",
	    "cmd": "trade.sell",
	    "idempotency_key": "test-sell-invalid-1762338651-4283",
	    "data": {
		"port_id": "@portId",
		"sector_id": "@curSector",
        "account": 0,
		"items": [
		    {
			"commodity": "invalid_thing",
			"quantity": 1
		    }
		]
	    },
	    "expect": {
		"status": "refused",
		"error": {
		    "code": "*"
		}
	    }
	},
	{
	    "name": "trade.port_info (by port_id)",
	    "cmd": "trade.port_info",
	    "data": {
		"sector_id": "@curSector",
		"port_id": "@portId"
	    },
	    "expect": {
		"status": "ok",
		"type": "trade.port_info",
		"data": "*"
	    }
	},
        {
            "name": "trade.quote (ore)",
            "cmd": "trade.quote",
            "data": {
                "port_id": "@portId",
                "commodity": "ore",
                "quantity": 10
            },
            "expect": {
                "status": "ok",
                "type": "trade.quote",
                "data": {
                    "port_id": 64,
                    "commodity": "ore",
                    "quantity": 10,
                    "buy_price": "*float",
                    "sell_price": "*float",
                    "total_buy_price": "*int",
                    "total_sell_price": "*int"
                }
            },
            "asserts": [
                { "path": "data.buy_price", "op": ">", "value": 0 },
                { "path": "data.sell_price", "op": ">", "value": 0 },
                { "path": "data.total_buy_price", "op": ">", "value": 0 },
                { "path": "data.total_sell_price", "op": ">", "value": 0 }
            ]
        },
        {
            "name": "trade.quote (organics)",
            "cmd": "trade.quote",
            "data": {
                "port_id": "@portId",
                "commodity": "organics",
                "quantity": 5
            },
            "expect": {
                "status": "ok",
                "type": "trade.quote",
                "data": {
                    "port_id": 64,
                    "commodity": "organics",
                    "quantity": 5,
                    "buy_price": "*float",
                    "sell_price": "*float",
                    "total_buy_price": "*int",
                    "total_sell_price": "*int"
                }
            },
            "asserts": [
                { "path": "data.buy_price", "op": ">", "value": 0 },
                { "path": "data.sell_price", "op": ">", "value": 0 },
                { "path": "data.total_buy_price", "op": ">", "value": 0 },
                { "path": "data.total_sell_price", "op": ">", "value": 0 }
            ]
        },
        {
            "name": "trade.quote (invalid commodity)",
            "cmd": "trade.quote",
            "data": {
                "port_id": "@portId",
                "commodity": "invalid_item",
                "quantity": 1
            },
            "expect": {
                "status": "error",
                "error": {
                    "code": 400
                }
            }
        },
        {
            "name": "trade.quote (zero quantity)",
            "cmd": "trade.quote",
            "data": {
                "port_id": "@portId",
                "commodity": "ore",
                "quantity": 0
            },
            "expect": {
                "status": "error",
                "error": {
                    "code": 400
                }
            }
        },
        {
            "name": "bank.deposit (initial credits for testing)",
            "cmd": "bank.deposit",
            "data": {
                "amount": 1000000
            },
            "expect": {
                "status": "ok",
                "type": "bank.deposited",
                "data": {
                    "new_balance": "*int"
                }
            },
            "asserts": [
                { "path": "data.new_balance", "op": ">=", "value": 1000000 }
            ]
        },
        {
            "name": "ship.jettison (ore - acquire cargo first)",
            "cmd": "trade.buy",
            "idempotency_key": "test-jettison-acquire-ore-1",
            "data": {
                "port_id": "@portId",
                "items": [
                    {
                        "commodity": "ore",
                        "quantity": 5
                    }
                ]
            },
            "expect": {
                "status": "ok",
                "type": "bank.deposited"
            }
        },
        {
            "name": "ship.jettison (ore - successful jettison)",
            "cmd": "ship.jettison",
            "data": {
                "commodity": "ore",
                "quantity": 2
            },
            "expect": {
                "status": "ok",
                "type": "ship.jettisoned",
                "data": {
                    "remaining_cargo": [
                        { "commodity": "ore", "quantity": 3 }
                    ]
                }
            }
        },
        {
            "name": "ship.jettison (insufficient cargo)",
            "cmd": "ship.jettison",
            "data": {
                "commodity": "ore",
                "quantity": 99999
            },
            "expect": {
                "status": "refused",
                "error": {
                    "code": 1402
                }
            }
        },
        {
            "name": "ship.jettison (invalid commodity)",
            "cmd": "ship.jettison",
            "data": {
                "commodity": "invalid_item",
                "quantity": 1
            },
            "expect": {
                "status": "refused",
                "error": {
                    "code": 1402
                }
            }
        },
        {
            "name": "combat.deploy_fighters (deploy 10 fighters)",
            "cmd": "combat.deploy_fighters",
            "idempotency_key": "test-deploy-fighters-1",
            "data": {
                "amount": 10,
                "offense": 2
            },
            "expect": {
                "status": "ok",
                "type": "combat.fighters.deployed",
                "data": {
                    "asset_id": "*int",
                    "sector_id": "*int",
                    "owner_player_id": "*int",
                    "owner_corp_id": "*null_or_int",
                    "amount": 10,
                    "offense": 2,
                    "sector_total_after": "*int"
                }
            },
            "capture": {
                "deployedFighterAssetId": "data.asset_id"
            },
            "asserts": [
                { "path": "data.asset_id", "op": ">", "value": 0 },
                { "path": "data.sector_id", "op": ">", "value": 0 },
                { "path": "data.owner_player_id", "op": ">", "value": 0 },
                { "path": "data.sector_total_after", "op": ">=", "value": 10 }
            ]
        },
        {
            "name": "deploy.fighters.list (verify deployed fighters)",
            "cmd": "deploy.fighters.list",
            "data": {},
            "expect": {
                "status": "ok",
                "type": "Deploy.fighters.list_v1",
                "data": {
                    "total": "*int",
                    "entries": [
                        {
                            "sector_id": "*int",
                            "count": "*int",
                            "offense_mode": "*int",
                            "player_id": "*int",
                            "player_name": "*string",
                            "corp_id": "*int",
                            "corp_tag": "*string",
                            "type": 2
                        }
                    ]
                }
            },
            "asserts": [
                { "path": "data.total", "op": ">=", "value": 1 },
                { "path": "data.entries.0.sector_id", "op": ">", "value": 0 },
                { "path": "data.entries.0.count", "op": ">=", "value": 10 },
                { "path": "data.entries.0.offense_mode", "op": "==", "value": 2 },
                { "path": "data.entries.0.player_id", "op": ">", "value": 0 },
                { "path": "data.entries.0.type", "op": "==", "value": 2 }
            ]
        },
        {
            "name": "fighters.recall (recall 5 fighters)",
            "cmd": "fighters.recall",
            "data": {
                "sector_id": "@curSector",
                "asset_id": "@deployedFighterAssetId"
            },
            "expect": {
                "status": "ok",
                "type": "fighters.recalled",
                "data": {
                    "sector_id": "@curSector",
                    "asset_id": "@deployedFighterAssetId",
                    "recalled": 10,
                    "remaining_in_sector": 0,
                    "mode": "*string"
                }
            },
            "asserts": [
                { "path": "data.recalled", "op": "==", "value": 10 },
                { "path": "data.remaining_in_sector", "op": "==", "value": 0 }
            ]
        },
        {
            "name": "deploy.fighters.list (verify no deployed fighters after recall)",
            "cmd": "deploy.fighters.list",
            "data": {},
            "expect": {
                "status": "ok",
                "type": "Deploy.fighters.list_v1",
                "data": {
                    "total": 0,
                    "entries": []
                }
            },
            "asserts": [
                { "path": "data.total", "op": "==", "value": 0 }
            ]
        }
	
    ]
}
