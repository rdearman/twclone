[
  {
    "name": "Register Admin",
    "command": "auth.register",
    "register_if_missing": true,
    "data": {
      "username": "combat_pvp_admin",
      "passwd": "password"
    },
    "user": "combat_pvp_admin",
    "passwd": "password",
    "save": {
      "admin_player_id": "data.player_id"
    }
  },
  {
    "name": "Login Admin",
    "command": "auth.login",
    "data": {
      "username": "combat_pvp_admin",
      "passwd": "password"
    },
    "user": "combat_pvp_admin",
    "passwd": "password",
    "save": {
      "admin_session": "data.session",
      "admin_player_id": "data.player_id"
    }
  },
  {
    "name": "Cleanup Old Test Players and Ships",
    "command": "sys.raw_sql_exec",
    "data": {
      "sql": "DELETE FROM ship_ownership WHERE player_id IN (SELECT id FROM players WHERE name IN ('combat_pvp_admin', 'attacker', 'defender')); DELETE FROM ships WHERE id IN (SELECT ship FROM players WHERE name IN ('combat_pvp_admin', 'attacker', 'defender')); DELETE FROM players WHERE name IN ('combat_pvp_admin', 'attacker', 'defender');"
    },
    "auth": {
      "session": "@admin_session"
    },
    "user": "combat_pvp_admin",
    "passwd": "password"
  },
  {
    "name": "Set Admin to SysOp",
    "command": "sys.raw_sql_exec",
    "data": {
      "sql": "UPDATE players SET type = 3 WHERE name = 'combat_pvp_admin';"
    },
    "auth": {
      "session": "@admin_session"
    },
    "user": "combat_pvp_admin",
    "passwd": "password"
  },
  {
    "name": "Setup: Shiptypes",
    "command": "sys.raw_sql_exec",
    "data": {
      "sql": "UPDATE shiptypes SET maxattack=50, offense=120, defense=50 WHERE id=2;"
    },
    "auth": {
      "session": "@admin_session"
    },
    "user": "combat_pvp_admin",
    "passwd": "password"
  },
  {
    "name": "Register Attacker",
    "command": "auth.register",
    "register_if_missing": true,
    "data": {
      "username": "attacker",
      "passwd": "password",
      "ship_name": "Attacker Ship"
    },
    "user": "attacker",
    "passwd": "password",
    "save": {
      "attacker_id": "data.player_id"
    }
  },
  {
    "name": "Login Attacker",
    "command": "auth.login",
    "data": {
      "username": "attacker",
      "passwd": "password"
    },
    "user": "attacker",
    "passwd": "password",
    "save": {
      "attacker_session": "data.session"
    }
  },
  {
    "name": "Register Defender",
    "command": "auth.register",
    "register_if_missing": true,
    "data": {
      "username": "defender",
      "passwd": "password",
      "ship_name": "Defender Ship"
    },
    "user": "defender",
    "passwd": "password",
    "save": {
      "defender_id": "data.player_id"
    }
  },
  {
    "name": "Login Defender",
    "command": "auth.login",
    "data": {
      "username": "defender",
      "passwd": "password"
    },
    "user": "defender",
    "passwd": "password",
    "save": {
      "defender_session": "data.session"
    }
  },
  {
    "name": "Get Defender Ship ID",
    "command": "sys.raw_sql_exec",
    "data": {
      "sql": "SELECT ship FROM players WHERE id=@defender_id"
    },
    "auth": {
      "session": "@admin_session"
    },
    "user": "combat_pvp_admin",
    "passwd": "password",
    "save": {
      "defender_ship_id": "data.rows.0.0"
    }
  },
  {
    "name": "DEBUG: Verify Ship Ownership for Attacker/Defender",
    "command": "sys.raw_sql_exec",
    "data": {
      "sql": "SELECT ship_id, player_id, is_primary FROM ship_ownership WHERE player_id IN (@attacker_id, @defender_id);"
    },
    "auth": {
      "session": "@admin_session"
    },
    "user": "combat_pvp_admin",
    "passwd": "password",
    "save": {
      "attacker_owned_ship": "data.rows.0.0",
      "defender_owned_ship": "data.rows.1.0"
    }
  },
  {
    "name": "Setup: Sector 300",
    "command": "sys.raw_sql_exec",
    "data": {
      "sql": "INSERT OR IGNORE INTO sectors (id, name) VALUES (300, 'Battle Arena');"
    },
    "auth": {
      "session": "@admin_session"
    },
    "user": "combat_pvp_admin",
    "passwd": "password"
  },
  {
    "name": "Setup: Move Ships to 300",
    "command": "sys.raw_sql_exec",
    "data": {
      "sql": "UPDATE ships SET sector=300 WHERE id IN (@attacker_owned_ship, @defender_owned_ship); UPDATE players SET sector=300 WHERE id IN (@attacker_id, @defender_id);"
    },
    "auth": {
      "session": "@admin_session"
    },
    "user": "combat_pvp_admin",
    "passwd": "password"
  },
  {
    "name": "Test 1: Attack (Shield Damage)",
    "command": "combat.attack",
    "data": {
      "target_ship_id": "@defender_ship_id",
      "commit_fighters": 50
    },
            "auth": {
                "session": "@attacker_session"
            },
            "user": "attacker",
    "asserts": [
      {"path": "data.attacker_destroyed", "value": false},
      {"path": "data.defender_destroyed", "value": false}
    ]
  },
  {
    "name": "Test 1: Verify Damage (Shields Reduced)",
    "command": "sys.raw_sql_exec",
    "data": {
      "sql": "SELECT shields, hull FROM ships WHERE id=@defender_ship_id;"
    },
    "auth": {
      "session": "@admin_session"
    },
    "user": "combat_pvp_admin",
    "passwd": "password",
    "asserts": [
      {"path": "data.rows.0.0", "op": "<", "value": 100}
    ]
  },
  {
    "name": "Test 2: Attack (Hull Damage & Destroy)",
    "command": "combat.attack",
    "data": {
      "target_ship_id": "@defender_ship_id",
      "commit_fighters": 50
    },
            "auth": {
                "session": "@attacker_session"
            },
            "user": "attacker",
    "asserts": [
      {"path": "data.defender_destroyed", "value": true}
    ]
  },
  {
    "name": "Test 3: Verify Destruction",
    "command": "sys.raw_sql_exec",
    "data": {
      "sql": "SELECT count(*) FROM ships WHERE id=@defender_ship_id;"
    },
    "auth": {
      "session": "@admin_session"
    },
    "user": "combat_pvp_admin",
    "passwd": "password",
    "asserts": [
      {"path": "data.rows.0.0", "value": 0}
    ]
  }
]