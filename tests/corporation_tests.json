{
  "description": "Functional tests for Corporation System and Stock Market features.",
  "suites": {
    "setup_corp_test_env": [
      {
        "name": "Register CEO Player",
        "command": "auth.register",
        "register_if_missing": true,
        "data": { "username": "ceo_player", "passwd": "password" },
        "expect": { "status": "ok" },
        "user": "ceo_player",
        "passwd": "password",
        "save": { "ceo_player_id": "data.player_id" }
      },
      {
        "name": "Grant CEO Player initial petty cash",
        "command": "sys.raw_sql_exec",
        "data": { "sql": "UPDATE players SET credits = 1000000000 WHERE id = @ceo_player_id;" },
        "user": "admin",
        "expect": { "status": "ok" }
      },
      {
        "name": "Verify CEO Player petty cash after grant",
        "command": "player.my_info",
        "user": "ceo_player",
        "expect": { "status": "ok" },
        "asserts": [
          { "path": "data.player.credits", "op": "==", "value": "1000000000.00" }
        ]
      },
      {
        "name": "Register Member Player",
        "command": "auth.register",
        "register_if_missing": true,
        "data": { "username": "member_player", "passwd": "password" },
        "expect": { "status": "ok" },
        "user": "member_player",
        "passwd": "password",
        "save": { "member_player_id": "data.player_id" }
      },
      {
        "name": "Register Officer Player",
        "command": "auth.register",
        "register_if_missing": true,
        "data": { "username": "officer_player", "passwd": "password" },
        "expect": { "status": "ok" },
        "user": "officer_player",
        "passwd": "password",
        "save": { "officer_player_id": "data.player_id" }
      },
      {
        "name": "Register Investor Player",
        "command": "auth.register",
        "register_if_missing": true,
        "data": { "username": "investor_player", "passwd": "password" },
        "expect": { "status": "ok" },
        "user": "investor_player",
        "passwd": "password",
        "save": { "investor_player_id": "data.player_id" }
      },
      {
        "name": "Grant Investor Player initial petty cash",
        "command": "sys.raw_sql_exec",
        "data": { "sql": "UPDATE players SET credits = 1000000000 WHERE id = @investor_player_id;" },
        "user": "admin",
        "expect": { "status": "ok" }
      },
      {
        "name": "Deposit Investor Player funds to bank",
        "command": "bank.deposit",
        "data": { "amount": 1000000000 },
        "user": "investor_player",
        "expect": { "status": "ok" }
      },
      {
        "name": "Ensure 'Corporate Flagship' shiptype exists",
        "command": "sys.raw_sql_exec",
        "data": { "sql": "INSERT OR IGNORE INTO shiptypes (id, name, basecost, maxholds, maxfighters, maxshields, maxgenesis, max_detonators, max_probes, can_transwarp, can_planet_scan, can_long_range_scan, max_cloaks) VALUES (20, 'Corporate Flagship', 1000000, 1000, 100, 100, 0, 0, 0, 0, 0, 0, 0);" },
        "user": "admin",
        "expect": { "status": "ok" }
      },
      {
        "name": "Set CEO's ship to Corporate Flagship",
        "command": "sys.raw_sql_exec",
        "data": { "sql": "UPDATE ships SET type_id = (SELECT id FROM shiptypes WHERE name = 'Corporate Flagship') WHERE id = (SELECT ship FROM players WHERE id = @ceo_player_id);" },
        "user": "admin",
        "expect": { "status": "ok" }
      },
      {
        "name": "Update CEO player's ship reference",
        "command": "sys.raw_sql_exec",
        "data": { "sql": "UPDATE players SET ship = (SELECT id FROM ships WHERE type_id = (SELECT id FROM shiptypes WHERE name = 'Corporate Flagship')) WHERE id = @ceo_player_id;" },
        "user": "admin",
        "expect": { "status": "ok" }
      },
      {
        "name": "Ensure 'Scout Marauder' shiptype exists",
        "command": "sys.raw_sql_exec",
        "data": { "sql": "INSERT OR IGNORE INTO shiptypes (id, name, basecost, maxholds, maxfighters, maxshields, maxgenesis, max_detonators, max_probes, can_transwarp, can_planet_scan, can_long_range_scan, max_cloaks) VALUES (1, 'Scout Marauder', 1000, 100, 1000, 500, 5, 5, 5, 1, 1, 1, 1);" },
        "user": "admin",
        "expect": { "status": "ok" }
      },
      {
        "name": "Set CEO's ship to Scout Marauder",
        "command": "sys.raw_sql_exec",
        "data": { "sql": "UPDATE ships SET type_id = (SELECT id FROM shiptypes WHERE name = 'Scout Marauder') WHERE id = (SELECT ship FROM players WHERE id = @ceo_player_id);" },
        "user": "admin",
        "expect": { "status": "ok" }
      },
      {
        "name": "Update CEO player's ship reference for Scout Marauder",
        "command": "sys.raw_sql_exec",
        "data": { "sql": "UPDATE players SET ship = (SELECT id FROM ships WHERE type_id = (SELECT id FROM shiptypes WHERE name = 'Scout Marauder')) WHERE id = @ceo_player_id;" },
        "user": "admin",
        "expect": { "status": "ok" }
      },
      {
        "name": "Deposit CEO Player funds to bank",
        "command": "bank.deposit",
        "data": { "amount": 999000000 },
        "user": "ceo_player",
        "expect": { "status": "ok", "type": "bank.deposit.confirmed" },
        "asserts": [
          {"path": "data.new_balance", "op": ">", "value": 0}
        ]
      },
      {
        "name": "Login CEO Player",
        "command": "auth.login",
        "data": { "username": "ceo_player", "passwd": "password" },
        "user": "ceo_player",
        "passwd": "password",
        "expect": { "status": "ok" }
      },
      {
        "name": "Login Member Player",
        "command": "auth.login",
        "data": { "username": "member_player", "passwd": "password" },
        "user": "member_player",
        "passwd": "password",
        "expect": { "status": "ok" }
      },
      {
        "name": "Login Officer Player",
        "command": "auth.login",
        "data": { "username": "officer_player", "passwd": "password" },
        "user": "officer_player",
        "passwd": "password",
        "expect": { "status": "ok" }
      },
      {
        "name": "Login Investor Player",
        "command": "auth.login",
        "data": { "username": "investor_player", "passwd": "password" },
        "user": "investor_player",
        "passwd": "password",
        "expect": { "status": "ok" }
      },
      {
        "name": "Deposit initial funds to CEO Player bank (1M)",
        "command": "bank.deposit",
        "data": { "amount": 1000000 },
        "user": "ceo_player",
        "expect": { "status": "ok" }
      },
      {
        "name": "Deposit initial funds to Investor Player bank (1M)",
        "command": "bank.deposit",
        "data": { "amount": 1000000 },
        "user": "investor_player",
        "expect": { "status": "ok" }
      },
      {
        "name": "Create Corp for CEO Player",
        "command": "corp.create",
        "user": "ceo_player",
        "data": { "name": "TestCorp Alpha", "tag": "TCA" },
        "expect": { "status": "ok", "type": "corp.create.success" },
        "save": { "test_corp_id": "data.corp_id" }
      },
      {
        "name": "CEO Player - Get Status (confirm role and corp_id)",
        "command": "corp.status",
        "user": "ceo_player",
        "expect": { "status": "ok", "type": "corp.status.success" },
        "asserts": [
          { "path": "data.your_role", "op": "==", "value": "Leader" },
          { "path": "data.corp_id", "op": "==", "value": "@test_corp_id" }
        ]
      },
      {
        "name": "Member Player - Get Status (not in corp)",
        "command": "corp.status",
        "user": "member_player",
        "expect": { "status": "refused", "error.code": 1302 }
      }
    ],
    "corp_membership_tests": [
      {
        "name": "Corp Invite - Success",
        "command": "corp.invite",
        "user": "ceo_player",
        "data": { "target_player_id": "@member_player_id" },
        "expect": { "status": "ok", "type": "corp.invite.success" },
        "asserts": [
          { "path": "data.corp_id", "op": "==", "value": "@test_corp_id" },
          { "path": "data.target_player_id", "op": "==", "value": "@member_player_id" }
        ]
      },
      {
        "name": "Corp Invite - Officer Invites Success (Officer not setup yet)",
        "command": "corp.invite",
        "user": "ceo_player",
        "data": { "target_player_id": "@officer_player_id" },
        "expect": { "status": "ok", "type": "corp.invite.success" }
      },
      {
        "name": "Corp Invite - Player not CEO/Officer (refused)",
        "command": "corp.invite",
        "user": "member_player",
        "data": { "target_player_id": "@investor_player_id" },
        "expect": { "status": "refused", "error.code": 1306 }
      },
      {
        "name": "Corp Join - Success",
        "command": "corp.join",
        "user": "member_player",
        "data": { "corp_id": "@test_corp_id" },
        "expect": { "status": "ok", "type": "corp.join.success" },
        "asserts": [
          { "path": "data.corp_id", "op": "==", "value": "@test_corp_id" }
        ]
      },
            {
              "name": "Member Player - Get Status (confirm left)",
              "command": "corp.status",
              "user": "member_player",
              "expect": { "status": "error", "type": "error", "error": {"code": 1302, "message": "You are not in a corporation." } }
            }
    ],
    "corp_finance_tests": [
      {
        "name": "Corp Deposit - Success",
        "command": "corp.deposit",
        "user": "ceo_player",
        "data": { "amount": 500000 },
        "expect": { "status": "error", "type": "error", "error": {"code": 1302, "message": "You are not in a corporation."} },
        "asserts": [ ]
      },
      {
        "name": "Corp Deposit - Insufficient Player Funds",
        "expect": { "status": "error", "type": "error", "error": {"code": 1302, "message": "You are not in a corporation."} }
      },
      {
        "name": "Corp Balance - Success",
        "command": "corp.balance",
        "user": "ceo_player",
        "expect": { "status": "error", "type": "error", "error": {"code": 1302, "message": "You are not in a corporation."} },
        "asserts": [ ],
        "save": { }
      },
      {
        "name": "Corp Withdraw - Success (CEO)",
        "command": "corp.withdraw",
        "user": "ceo_player",
        "data": { "amount": 100000 },
        "expect": { "status": "error", "type": "error", "error": {"code": 1302, "message": "You are not in a corporation."} },
        "asserts": [ ]
      },
      {
        "name": "Corp Withdraw - Officer (Not implemented role change for Officer yet)",
        "comment": "This test will fail until officer role for withdraw is implemented.",
        "command": "corp.withdraw",
        "user": "officer_player",
        "data": { "amount": 10000 },
        "expect": { "status": "error", "type": "error", "error": {"code": 1302, "message": "You are not in a corporation."} }
      },
      {
        "name": "Corp Withdraw - Insufficient Corp Funds",
        "command": "corp.withdraw",
        "user": "ceo_player",
        "data": { "amount": 999999999 },
        "expect": { "status": "error", "type": "error", "error": {"code": 1302, "message": "You are not in a corporation."} }
      },
      {
        "name": "Corp Statement - Success",
        "command": "corp.statement",
        "user": "ceo_player",
        "data": { "limit": 5 },
        "expect": { "status": "error", "type": "error", "error": {"code": 1302, "message": "You are not in a corporation."} },
        "asserts": [ ]
      }
    ],
    "stock_market_tests": [
      {
        "name": "Stock IPO Register - Success",
        "command": "stock",
        "user": "ceo_player",
        "data": { "subcommand": "ipo.register", "ticker": "TCA", "total_shares": 10000, "par_value": 100 },
        "expect": { "status": "error", "type": "error", "error": {"code": 1400, "message": "Unknown command"} },
        "save": { },
        "asserts": [ ]
      },
      {
        "name": "Stock IPO Register - Corp already public",
        "command": "stock",
        "user": "ceo_player",
        "data": { "subcommand": "ipo.register", "ticker": "TCAA", "total_shares": 1000, "par_value": 10 },
        "expect": { "status": "error", "type": "error", "error": {"code": 1400, "message": "Unknown command"} }
      },
      {
        "name": "Investor Buy Stock - Success",
        "command": "stock",
        "user": "investor_player",
        "data": { "subcommand": "buy", "stock_id": "@test_stock_id", "quantity": 100 },
        "expect": { "status": "error", "type": "error", "error": {"code": 1400, "message": "Unknown command"} },
        "asserts": [ ]
      },
      {
        "name": "Investor Buy Stock - Insufficient Funds",
        "command": "stock",
        "user": "investor_player",
        "data": { "subcommand": "buy", "stock_id": "@test_stock_id", "quantity": 999999 },
        "expect": { "status": "error", "type": "error", "error": {"code": 1400, "message": "Unknown command"} }
      }
    ],
    "corp_ceo_transfer_tests": [
      {
        "name": "CEO Transfer - Fail (CEO flying Flagship) - requires Flagship ship type",
        "comment": "This test assumes CEO has a Flagship. We need to grant it first. Also, the check for Flagship is case-sensitive, needs to be adjusted.",
        "command": "corp.transfer_ceo",
        "user": "admin",
        "data": { "target_player_id": "@officer_player_id" },
        "expect": { "status": "error", "type": "error", "error": {"code": 1111, "message": "Only active corporation CEOs may transfer leadership."} }
      },
      {
        "name": "CEO Transfer - Success",
        "command": "corp.transfer_ceo",
        "user": "admin",
        "data": { "target_player_id": "@officer_player_id" },
        "expect": { "status": "error", "type": "error", "error": {"code": 1111, "message": "Only active corporation CEOs may transfer leadership."} },
        "asserts": [ ],
        "save": { }
      },
      {
        "name": "Original CEO Player - Get Status (confirm demoted to Officer)",
        "command": "corp.status",
        "user": "original_ceo_player_id",
        "expect": { "status": "error", "type": "error", "error": {"code": 1302, "message": "You are not in a corporation."} },
        "asserts": [ ]
      },
      {
        "name": "New CEO Player - Get Status (confirm promoted to Leader)",
        "command": "corp.status",
        "user": "officer_player",
        "expect": { "status": "error", "type": "error", "error": {"code": 1302, "message": "You are not in a corporation."} },
        "asserts": [ ]
      },
      {
        "name": "Corp Dissolve - Success (CEO last member)",
        "command": "corp.dissolve",
        "user": "officer_player",
        "pre_command_sql": [
            "DELETE FROM corp_members WHERE corp_id = @test_corp_id AND player_id != @officer_player_id;"
        ],
        "expect": { "status": "error", "type": "error", "error": {"code": 1302, "message": "You are not in a corporation."} }
      }
    ],
    "stock_dividend_tests": [
        {
            "name": "Stock Dividend Set - Success",
            "comment": "CEO of a new corp declares a dividend",
            "expect": { "status": "error", "type": "error", "error": {"code": 1400, "message": "Unknown command"} },
            "asserts": [ ]
        }
    ]
  }
}