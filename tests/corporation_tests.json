{
  "description": "Functional tests for Corporation System and Stock Market features.",
  "suites": {
    "setup_corp_test_env": [
      {
        "name": "Register CEO Player",
        "command": "auth.register",
        "register_if_missing": true,
        "data": { "username": "ceo_player", "passwd": "password" },
        "expect": { "status": "ok" },
        "user": "ceo_player",
        "passwd": "password",
        "save": { "ceo_player_id": "data.player_id" }
      },
      {
        "name": "Grant CEO Player initial petty cash",
        "command": "sys.raw_sql_exec",
        "data": { "sql": "UPDATE players SET credits = 1000000000 WHERE id = @ceo_player_id;" },
        "user": "ceo_player",
        "expect": { "status": "ok" }
      },
      {
        "name": "Verify CEO Player petty cash after grant",
        "command": "player.my_info",
        "user": "ceo_player",
        "expect": { "status": "ok" },
        "asserts": [
          { "path": "data.player.credits", "op": "==", "value": "1000000000.00" }
        ]
      },
      {
        "name": "Register Member Player",
        "command": "auth.register",
        "register_if_missing": true,
        "data": { "username": "member_player", "passwd": "password" },
        "expect": { "status": "ok" },
        "user": "member_player",
        "passwd": "password",
        "save": { "member_player_id": "data.player_id" }
      },
      {
        "name": "Register Officer Player",
        "command": "auth.register",
        "register_if_missing": true,
        "data": { "username": "officer_player", "passwd": "password" },
        "expect": { "status": "ok" },
        "user": "officer_player",
        "passwd": "password",
        "save": { "officer_player_id": "data.player_id" }
      },
      {
        "name": "Register Investor Player",
        "command": "auth.register",
        "register_if_missing": true,
        "data": { "username": "investor_player", "passwd": "password" },
        "expect": { "status": "ok" },
        "user": "investor_player",
        "passwd": "password",
        "save": { "investor_player_id": "data.player_id" }
      },
      {
        "name": "Grant Investor Player initial petty cash",
        "command": "sys.raw_sql_exec",
        "data": { "sql": "UPDATE players SET credits = 1000000000 WHERE id = @investor_player_id;" },
        "user": "investor_player",
        "expect": { "status": "ok" }
      },
      {
        "name": "Login CEO Player",
        "command": "auth.login",
        "data": { "username": "ceo_player", "passwd": "password" },
        "user": "ceo_player",
        "passwd": "password",
        "expect": { "status": "ok" }
      },
      {
        "name": "Login Member Player",
        "command": "auth.login",
        "data": { "username": "member_player", "passwd": "password" },
        "user": "member_player",
        "passwd": "password",
        "expect": { "status": "ok" }
      },
      {
        "name": "Login Officer Player",
        "command": "auth.login",
        "data": { "username": "officer_player", "passwd": "password" },
        "user": "officer_player",
        "passwd": "password",
        "expect": { "status": "ok" }
      },
      {
        "name": "Login Investor Player",
        "command": "auth.login",
        "data": { "username": "investor_player", "passwd": "password" },
        "user": "investor_player",
        "passwd": "password",
        "expect": { "status": "ok" }
      },
      {
        "name": "Deposit initial funds to CEO Player bank (1M)",
        "command": "bank.deposit",
        "data": { "amount": 1000000 },
        "user": "ceo_player",
        "expect": { "status": "ok" }
      },
      {
        "name": "Deposit initial funds to Investor Player bank (1M)",
        "command": "bank.deposit",
        "data": { "amount": 1000000 },
        "user": "investor_player",
        "expect": { "status": "ok" }
      },
      {
        "name": "Create Corp for CEO Player",
        "command": "corp.create",
        "user": "ceo_player",
        "data": { "name": "TestCorp Alpha", "tag": "TCA" },
        "expect": { "status": "ok", "type": "corp.create.success" },
        "save": { "test_corp_id": "data.corp_id" }
      },
      {
        "name": "CEO Player - Get Status (confirm role and corp_id)",
        "command": "corp.status",
        "user": "ceo_player",
        "expect": { "status": "ok", "type": "corp.status.success" },
        "asserts": [
          { "path": "data.your_role", "op": "==", "value": "Leader" },
          { "path": "data.corp_id", "op": "==", "value": "@test_corp_id" }
        ]
      },
      {
        "name": "Member Player - Get Status (not in corp)",
        "command": "corp.status",
        "user": "member_player",
        "expect": { "status": "refused", "error.code": 400 }
      }
    ],
    "corp_membership_tests": [
      {
        "name": "Corp Invite - Success",
        "command": "corp.invite",
        "user": "ceo_player",
        "data": { "target_player_id": "@member_player_id" },
        "expect": { "status": "ok", "type": "corp.invite.success" },
        "asserts": [
          { "path": "data.corp_id", "op": "==", "value": "@test_corp_id" },
          { "path": "data.target_player_id", "op": "==", "value": "@member_player_id" }
        ]
      },
      {
        "name": "Corp Invite - Officer Invites Success (Officer not setup yet)",
        "command": "corp.invite",
        "user": "ceo_player",
        "data": { "target_player_id": "@officer_player_id" },
        "expect": { "status": "ok", "type": "corp.invite.success" }
      },
      {
        "name": "Corp Invite - Player not CEO/Officer (refused)",
        "command": "corp.invite",
        "user": "member_player",
        "data": { "target_player_id": "@investor_player_id" },
        "expect": { "status": "refused", "error.code": 1403 }
      },
      {
        "name": "Corp Join - Success",
        "command": "corp.join",
        "user": "member_player",
        "data": { "corp_id": "@test_corp_id" },
        "expect": { "status": "ok", "type": "corp.join.success" },
        "asserts": [
          { "path": "data.corp_id", "op": "==", "value": "@test_corp_id" }
        ]
      },
      {
        "name": "Member Player - Get Status (confirm joined)",
        "command": "corp.status",
        "user": "member_player",
        "expect": { "status": "ok", "type": "corp.status.success" },
        "asserts": [
          { "path": "data.your_role", "op": "==", "value": "Member" },
          { "path": "data.corp_id", "op": "==", "value": "@test_corp_id" }
        ]
      },
      {
        "name": "CEO Player - List Roster (confirm new member)",
        "command": "corp.roster",
        "user": "ceo_player",
        "data": { "corp_id": "@test_corp_id" },
        "expect": { "status": "ok", "type": "corp.roster.success" },
        "asserts": [
          { "path": "data.roster", "op": "*array" },
          { "path": "data.roster.0.player_id", "op": "==", "value": "@ceo_player_id" },
          { "path": "data.roster.0.role", "op": "==", "value": "Leader" },
          { "path": "data.roster.1.player_id", "op": "==", "value": "@member_player_id" },
          { "path": "data.roster.1.role", "op": "==", "value": "Member" }
        ]
      },
      {
        "name": "Corp Leave - Member Leaves Success",
        "command": "corp.leave",
        "user": "member_player",
        "expect": { "status": "ok", "type": "corp.leave.success" }
      },
      {
        "name": "Member Player - Get Status (confirm left)",
        "command": "corp.status",
        "user": "member_player",
        "expect": { "status": "refused", "error.code": 400 }
      },
      {
        "name": "CEO Player - Kick Member (refused - member already left)",
        "command": "corp.kick",
        "user": "ceo_player",
        "data": { "target_player_id": "@member_player_id" },
        "expect": { "status": "refused", "error.code": 400 }
      },
      {
        "name": "Corp Dissolve - Refused (CEO not last member)",
        "command": "corp.dissolve",
        "user": "ceo_player",
        "expect": { "status": "refused", "error.code": 400 }
      }
    ],
    "corp_finance_tests": [
      {
        "name": "Corp Deposit - Success",
        "command": "corp.deposit",
        "user": "ceo_player",
        "data": { "amount": 500000 },
        "expect": { "status": "ok", "type": "corp.deposit.success" },
        "asserts": [
          { "path": "data.amount", "op": "==", "value": 1000000 }
        ]
      },
      {
        "name": "Corp Deposit - Insufficient Player Funds",
        "command": "corp.deposit",
        "user": "ceo_player",
        "data": { "amount": 999999999 },
        "expect": { "status": "refused", "error.code": 1702 }
      },
      {
        "name": "Corp Balance - Success",
        "command": "corp.balance",
        "user": "ceo_player",
        "expect": { "status": "ok", "type": "corp.balance.success" },
        "asserts": [
          { "path": "data.balance", "op": ">=", "value": 500000 }
        ],
        "save": { "corp_initial_balance": "data.balance" }
      },
      {
        "name": "Corp Withdraw - Success (CEO)",
        "command": "corp.withdraw",
        "user": "ceo_player",
        "data": { "amount": 100000 },
        "expect": { "status": "ok", "type": "corp.withdraw.success" },
        "asserts": [
          { "path": "data.amount", "op": "==", "value": 100000 }
        ]
      },
      {
        "name": "Corp Withdraw - Officer (Not implemented role change for Officer yet)",
        "comment": "This test will fail until officer role for withdraw is implemented.",
        "command": "corp.withdraw",
        "user": "officer_player",
        "data": { "amount": 10000 },
        "expect": { "status": "refused", "error.code": 1403 }
      },
      {
        "name": "Corp Withdraw - Insufficient Corp Funds",
        "command": "corp.withdraw",
        "user": "ceo_player",
        "data": { "amount": 999999999 },
        "expect": { "status": "refused", "error.code": 1702 }
      },
      {
        "name": "Corp Statement - Success",
        "command": "corp.statement",
        "user": "ceo_player",
        "data": { "limit": 5 },
        "expect": { "status": "ok", "type": "corp.statement.success" },
        "asserts": [
          { "path": "data.transactions", "op": "*array" },
          { "path": "data.transactions.length", "op": ">=", "value": 2 }
        ]
      }
    ],
    "stock_market_tests": [
      {
        "name": "Stock IPO Register - Success",
        "command": "stock",
        "user": "ceo_player",
        "data": { "subcommand": "ipo.register", "ticker": "TCA", "total_shares": 10000, "par_value": 100 },
        "expect": { "status": "ok", "type": "stock.ipo.register.success" },
        "save": { "test_stock_id": "data.stock_id" },
        "asserts": [
          { "path": "data.corp_id", "op": "==", "value": "@test_corp_id" },
          { "path": "data.ticker", "op": "==", "value": "TCA" }
        ]
      },
      {
        "name": "Stock IPO Register - Corp already public",
        "command": "stock",
        "user": "ceo_player",
        "data": { "subcommand": "ipo.register", "ticker": "TCAA", "total_shares": 1000, "par_value": 10 },
        "expect": { "status": "refused", "error.code": 400 }
      },
      {
        "name": "Investor Buy Stock - Success",
        "command": "stock",
        "user": "investor_player",
        "data": { "subcommand": "buy", "stock_id": "@test_stock_id", "quantity": 100 },
        "expect": { "status": "ok", "type": "stock.buy.success" },
        "asserts": [
          { "path": "data.stock_id", "op": "==", "value": "@test_stock_id" },
          { "path": "data.quantity", "op": "==", "value": 100 }
        ]
      },
      {
        "name": "Investor Buy Stock - Insufficient Funds",
        "command": "stock",
        "user": "investor_player",
        "data": { "subcommand": "buy", "stock_id": "@test_stock_id", "quantity": 999999 },
        "expect": { "status": "refused", "error.code": 1702 }
      }
    ],
    "corp_ceo_transfer_tests": [
      {
        "name": "CEO Transfer - Fail (CEO flying Flagship) - requires Flagship ship type",
        "comment": "This test assumes CEO has a Flagship. We need to grant it first. Also, the check for Flagship is case-sensitive, needs to be adjusted.",
        "pre_command_sql": [
          "UPDATE ships SET type_id = (SELECT id FROM shiptypes WHERE name = 'Corporate Flagship') WHERE id = (SELECT ship FROM players WHERE id = @ceo_player_id);",
          "UPDATE players SET ship = (SELECT id FROM ships WHERE type_id = (SELECT id FROM shiptypes WHERE name = 'Corporate Flagship')) WHERE id = @ceo_player_id;"
        ],
        "command": "corp.transfer_ceo",
        "user": "ceo_player",
        "data": { "target_player_id": "@officer_player_id" },
        "expect": { "status": "refused", "error.code": 1404 }
      },
      {
        "name": "CEO Transfer - Success",
        "pre_command_sql": [
          "UPDATE ships SET type_id = (SELECT id FROM shiptypes WHERE name = 'Scout Marauder') WHERE id = (SELECT ship FROM players WHERE id = @ceo_player_id);",
          "UPDATE players SET ship = (SELECT id FROM ships WHERE type_id = (SELECT id FROM shiptypes WHERE name = 'Scout Marauder')) WHERE id = @ceo_player_id;"
        ],
        "command": "corp.transfer_ceo",
        "user": "ceo_player",
        "data": { "target_player_id": "@officer_player_id" },
        "expect": { "status": "ok", "type": "corp.transfer_ceo.success" },
        "asserts": [
          { "path": "data.corp_id", "op": "==", "value": "@test_corp_id" },
          { "path": "data.new_ceo_player_id", "op": "==", "value": "@officer_player_id" }
        ],
        "save": { "original_ceo_player_id": "@ceo_player_id", "ceo_player_id": "@officer_player_id" }
      },
      {
        "name": "Original CEO Player - Get Status (confirm demoted to Officer)",
        "command": "corp.status",
        "user": "original_ceo_player_id",
        "expect": { "status": "ok", "type": "corp.status.success" },
        "asserts": [
          { "path": "data.your_role", "op": "==", "value": "Officer" }
        ]
      },
      {
        "name": "New CEO Player - Get Status (confirm promoted to Leader)",
        "command": "corp.status",
        "user": "officer_player",
        "expect": { "status": "ok", "type": "corp.status.success" },
        "asserts": [
          { "path": "data.your_role", "op": "==", "value": "Leader" }
        ]
      },
      {
        "name": "Corp Dissolve - Success (CEO last member)",
        "command": "corp.dissolve",
        "user": "officer_player",
        "pre_command_sql": [
            "DELETE FROM corp_members WHERE corp_id = @test_corp_id AND player_id != @officer_player_id;"
        ],
        "expect": { "status": "ok", "type": "corp.dissolve.success" }
      }
    ],
    "stock_dividend_tests": [
        {
            "name": "Stock Dividend Set - Success",
            "comment": "CEO of a new corp declares a dividend",
            "pre_command_sql": [
                "INSERT INTO players (id, name, passwd, sector, ship, credits) VALUES (90004, 'dividend_ceo', 'password', 1, 1, 10000000);",
                "INSERT INTO corporations (id, name, owner_id, tag) VALUES (9000, 'DividendCorp', 90004, 'DIV');",
                "INSERT INTO stocks (id, corp_id, ticker, total_shares, par_value, current_price) VALUES (9000, 9000, 'DIVS', 100000, 10, 10);"
            ],
            "command": "stock",
            "user": "dividend_ceo",
            "data": { "subcommand": "dividend.set", "stock_id": 9000, "amount_per_share": 1 },
            "expect": { "status": "ok", "type": "stock.dividend.set.success" },
            "asserts": [
                { "path": "data.total_payout", "op": "==", "value": 100000 }
            ]
        }
    ]
  }
}