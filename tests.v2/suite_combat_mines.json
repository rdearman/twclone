{
  "tests": [
    {
      "name": "Setup: mine_tester",
      "setup": "macro_auth_user",
      "username": "mine_tester",
      "password": "password"
    },
    {
      "name": "Rig: Move player to Sector 200",
      "command": "sys.raw_sql_exec",
      "data": { "sql": "UPDATE players SET sector_id = 200 WHERE player_id = @{mine_tester_player_id};" },
      "user": "admin",
      "expect": { "status": "ok" }
    },
    {
      "name": "Rig: Move ship to Sector 200",
      "command": "sys.raw_sql_exec",
      "data": { "sql": "UPDATE ships SET sector_id = 200 WHERE ship_id = (SELECT ship_id FROM players WHERE player_id = @{mine_tester_player_id});" },
      "user": "admin",
      "expect": { "status": "ok" }
    },
    {
      "name": "Rig: Seed Ship Mines",
      "command": "sys.raw_sql_exec",
      "data": { "sql": "UPDATE ships SET mines = 1000 WHERE ship_id = (SELECT ship_id FROM players WHERE player_id = @{mine_tester_player_id});" },
      "user": "admin",
      "expect": { "status": "ok" }
    },
    {
      "name": "Action: Lay Armid Mines",
      "command": "combat.lay_mines",
      "data": {
        "count": 50,
        "mine_type": "armid"
      },
      "user": "mine_tester",
      "expect": {
        "status": "ok",
        "count_added": 50
      }
    },
    {
      "name": "Verify: Inventory Decreased",
      "command": "sys.raw_sql_exec",
      "data": { "sql": "SELECT mines FROM ships WHERE ship_id = (SELECT ship_id FROM players WHERE player_id = @{mine_tester_player_id});" },
      "user": "admin",
      "expect": { "status": "ok" },
      "asserts": [
        { "path": "data.rows.0.0", "op": "==", "value": 950 }
      ]
    },
    {
      "name": "Verify: Sector Asset Created",
      "command": "sys.raw_sql_exec",
      "data": { "sql": "SELECT quantity FROM sector_assets WHERE sector_id = (SELECT sector_id FROM players WHERE player_id = @{mine_tester_player_id}) AND owner_id = @{mine_tester_player_id} AND asset_type = 1;" },
      "user": "admin",
      "expect": { "status": "ok" },
      "asserts": [
        { "path": "data.rows.0.0", "op": "==", "value": 50 }
      ]
    },
    {
      "name": "Action: Lay Negative Amount (Invalid Input)",
      "command": "combat.lay_mines",
      "data": { "count": -10, "mine_type": "armid" },
      "user": "mine_tester",
      "expect": { "status": "error", "error_code": 400 } 
    },
    {
      "name": "Setup: Reset for Sweep (Clear)",
      "command": "sys.raw_sql_exec",
      "data": { "sql": "DELETE FROM sector_assets WHERE sector_id=200;" },
      "user": "admin",
      "expect": { "status": "ok" }
    },
    {
      "name": "Setup: Reset for Sweep (Seed)",
      "command": "sys.raw_sql_exec",
      "data": { "sql": "INSERT INTO sector_assets (sector_id, owner_id, asset_type, quantity, deployed_at) VALUES (1, 1, 1, 10, now());" },
      "user": "admin",
      "expect": { "status": "ok" }
    },
    {
      "name": "Action: Sweep Mines",
      "command": "combat.sweep_mines",
      "data": {
        "from_sector_id": 200,
        "target_sector_id": 200,
        "fighters_committed": 100,
        "mine_type": "armid"
      },
      "user": "mine_tester",
      "expect": { "status": "ok", "data": { "success": true } }
    }
  ]
}
