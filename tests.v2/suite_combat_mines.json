{
  "tests": [
    {
      "name": "Setup: mine_tester",
      "setup": "macro_auth_user",
      "username": "mine_tester",
      "password": "password"
    },
    {
      "name": "Action: Lay Armid Mines",
      "command": "combat.lay_mines",
      "data": {
        "count": 50,
        "offense_mode": 3,
        "owner_mode": "personal",
        "mine_type": "armid"
      },
      "user": "mine_tester",
      "expect": {
        "status": "ok",
        "data": {
          "count_added": 50,
          "total_now": 50
        }
      }
    },
    {
      "name": "Verify: Inventory Decreased",
      "command": "sys.raw_sql_exec",
      "data": { "sql": "SELECT mines FROM ships WHERE ship_id=1015;" },
      "user": "admin",
      "expect": { "status": "ok", "data": { "rows": [[950]] } }
    },
    {
      "name": "Verify: Sector Asset Created",
      "command": "sys.raw_sql_exec",
      "data": { "sql": "SELECT quantity FROM sector_assets WHERE sector_id=200 AND owner_id=@mine_tester_player_id AND asset_type=1;" },
      "user": "admin",
      "expect": { "status": "ok", "data": { "rows": [[50]] } }
    },
    {
      "name": "Action: Lay Negative Amount (Invalid Input)",
      "command": "combat.lay_mines",
      "data": { "count": -10, "offense_mode": 3, "owner_mode": "personal", "mine_type": "armid" },
      "user": "mine_tester",
      "expect": { "status": "error", "error": { "code": 1302 } } 
    },
    {
      "name": "Setup: Reset for Sweep (Clear)",
      "command": "sys.raw_sql_exec",
      "data": { "sql": "DELETE FROM sector_assets WHERE sector_id=200;" },
      "user": "admin",
      "expect": { "status": "ok" }
    },
    {
      "name": "Setup: Reset for Sweep (Seed)",
      "command": "sys.raw_sql_exec",
      "data": { "sql": "INSERT INTO sector_assets (sector_id, owner_id, asset_type, quantity, offensive_setting, deployed_at) VALUES (200, 0, 1, 50, 3, to_timestamp(0)) ON CONFLICT DO NOTHING;" },
      "user": "admin",
      "expect": { "status": "ok" }
    },
    {
      "name": "Action: Sweep Mines",
      "command": "combat.sweep_mines",
      "data": {
        "from_sector_id": 200,
        "target_sector_id": 200,
        "fighters_committed": 100,
        "mine_type": "armid"
      },
      "user": "mine_tester",
      "expect": { "status": "ok", "data": { "success": true } }
    }
  ]
}
