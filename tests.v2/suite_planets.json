{
  "tests": [
    {
      "name": "Unnamed",
      "setup": "macro_auth_user",
      "username": "planet_tester_1",
      "password": "password"
    },
    {
      "name": "Give Credits",
      "command": "sys.raw_sql_exec",
      "data": { "sql": "UPDATE players SET credits = 1000000 WHERE id = @planet_tester_1_player_id;" },
      "user": "admin",
      "expect": { "status": "ok" }
    },
    {
      "name": "Setup: Genesis Enabled",
      "command": "sys.raw_sql_exec",
      "data": { "sql": "INSERT INTO config (key, value, type) VALUES ('genesis_enabled', '1', 'int') ON CONFLICT (key) DO UPDATE SET value = EXCLUDED.value;" },
      "user": "admin",
      "expect": { "status": "ok" }
    },
    {
      "name": "Setup: Genesis Weight",
      "command": "sys.raw_sql_exec",
      "data": { "sql": "UPDATE planettypes SET genesis_weight = 100 WHERE id = 1;" },
      "user": "admin",
      "expect": { "status": "ok" }
    },
    {
      "name": "Setup: Genesis Sector",
      "command": "sys.raw_sql_exec",
      "data": { "sql": "INSERT INTO sectors (id, name) VALUES (500, 'Genesis Sector') ON CONFLICT (id) DO NOTHING;" },
      "user": "admin",
      "expect": { "status": "ok" }
    },
    {
      "name": "Delete Old Ship",
      "command": "sys.raw_sql_exec",
      "data": { "sql": "DELETE FROM ships WHERE id = @planet_tester_1_player_id;" },
      "user": "admin",
      "expect": { "status": "ok" }
    },
    {
      "name": "Create Ship with Genesis",
      "command": "sys.raw_sql_exec",
      "data": { "sql": "INSERT INTO ships (id, type_id, name, holds, sector, ported, genesis) VALUES (@planet_tester_1_player_id, 1, 'PlanetTestShip', 100, 1, 0, 1) ON CONFLICT (id) DO NOTHING;" },
      "user": "admin",
      "expect": { "status": "ok" }
    },
    {
      "name": "Assign Ship to Player",
      "command": "sys.raw_sql_exec",
      "data": { "sql": "UPDATE players SET ship = @planet_tester_1_player_id, sector = 1 WHERE id = @planet_tester_1_player_id;" },
      "user": "admin",
      "expect": { "status": "ok" }
    },
    {
      "name": "Refresh Player Info after ship update",
      "command": "player.my_info",
      "user": "planet_tester_1",
      "expect": { "status": "ok" }
    },
    {
      "name": "DEBUG: Check Genesis Torpedoes",
      "command": "sys.raw_sql_exec",
      "data": { "sql": "SELECT genesis FROM ships WHERE id = @planet_tester_1_player_id;" },
      "user": "admin",
      "expect": { "status": "ok" },
      "asserts": [ { "path": "data.rows.0.0", "op": "==", "value": 1 } ]
    },
    {
      "name": "Create Planet (T2-01)",
      "command": "planet.genesis_create",
      "data": { "sector_id": 500, "name": "T201_Planet", "owner_entity_type": "player" },
      "user": "planet_tester_1",
      "save": { "t201_planet_id": "data.planet_id" },
      "expect": { "status": "ok" }
    },
    {
      "name": "Insert Citadel (T2-01)",
      "command": "sys.raw_sql_exec",
      "data": { "sql": "INSERT INTO citadels (planet_id, level, treasury, owner) VALUES (@t201_planet_id, 1, 0, @planet_tester_1_player_id) ON CONFLICT DO NOTHING;" },
      "user": "admin",
      "expect": { "status": "ok" }
    },
    {
      "name": "Deposit Funds (T2-01)",
      "command": "planet.deposit",
      "data": { "planet_id": "@t201_planet_id", "amount": 10000 },
      "user": "planet_tester_1",
      "expect": { "status": "ok" }
    },
    {
      "name": "Set Citadel Level 0 (T2-01)",
      "command": "sys.raw_sql_exec",
      "data": { "sql": "UPDATE citadels SET level = 0 WHERE planet_id = @t201_planet_id;" },
      "user": "admin",
      "expect": { "status": "ok" }
    },
    {
      "name": "Verify Treasury No Interest (T2-01)",
      "command": "sys.raw_sql_exec",
      "data": { "sql": "SELECT treasury FROM citadels WHERE planet_id = @t201_planet_id;" },
      "user": "admin",
      "expect": { "status": "ok" },
      "asserts": [ { "path": "data.rows.0.0", "op": "==", "value": 10000 } ]
    },
    
    {
      "name": "Set Citadel Level 1 (T2-02)",
      "command": "sys.raw_sql_exec",
      "data": { "sql": "UPDATE citadels SET level = 1 WHERE planet_id = @t201_planet_id;" },
      "user": "admin",
      "expect": { "status": "ok" }
    },
    {
      "name": "Set Interest Rate (T2-02)",
      "command": "sys.raw_sql_exec",
      "data": { "sql": "INSERT INTO config (key, value, type) VALUES ('planet_treasury_interest_rate_bps', '100', 'int') ON CONFLICT (key) DO UPDATE SET value = EXCLUDED.value;" },
      "user": "admin",
      "expect": { "status": "ok" }
    },
    {
      "name": "Verify Treasury With Interest (T2-02)",
      "command": "sys.raw_sql_exec",
      "data": { "sql": "SELECT treasury FROM citadels WHERE planet_id = @t201_planet_id;" },
      "user": "admin",
      "expect": { "status": "ok" },
      "asserts": [ { "path": "data.rows.0.0", "op": "==", "value": 10100 } ]
    }
  ]
}