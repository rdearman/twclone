{
  "name": "Combat Toll Fighters Regression",
  "version": "2.0.0",
  "protocol_category": "23_Combat",
  "description": "Regression tests for toll fighter mechanics (offensive_setting=3)",
  "tests": [
    {
      "name": "Setup: Toll Collector",
      "setup": "macro_auth_user",
      "username": "toll_collector",
      "password": "password123"
    },
    {
      "name": "Setup: Victim",
      "setup": "macro_auth_user",
      "username": "toll_victim",
      "password": "password123"
    },
    {
      "name": "Rig: Create Warp Links",
      "command": "sys.raw_sql_exec",
      "user": "admin",
      "data": {
        "sql": "INSERT INTO sector_warps (from_sector, to_sector) VALUES (1, 2), (2, 1) ON CONFLICT DO NOTHING;"
      },
      "expect": { "status": "ok" }
    },
    {
      "name": "Rig: Position toll_victim player at Sector 1",
      "command": "sys.raw_sql_exec",
      "user": "admin",
      "data": {
        "sql": "UPDATE players SET sector_id = 1 WHERE name = 'toll_victim';"
      },
      "expect": { "status": "ok" }
    },
    {
      "name": "Rig: Position toll_victim ship at Sector 1",
      "command": "sys.raw_sql_exec",
      "user": "admin",
      "data": {
        "sql": "UPDATE ships SET sector_id = 1 WHERE ship_id = (SELECT ship_id FROM players WHERE name = 'toll_victim');"
      },
      "expect": { "status": "ok" }
    },
    {
      "name": "Victim Warps to Toll Sector (Should Auto-Pay)",
      "command": "move.warp",
      "data": { "sector_id": 2 },
      "user": "toll_victim",
      "expect": { "status": "ok" },
      "asserts": [
        { "path": "data.sector_id", "op": "==", "value": 2 }
      ]
    },
    {
      "name": "Verify Toll Was Collected",
      "command": "sys.raw_sql_exec",
      "data": { "sql": "SELECT credits FROM players WHERE name = 'toll_victim';" },
      "user": "admin",
      "expect": { "status": "ok" },
      "asserts": [
        { "path": "data.rows.0.0", "op": "<", "value": 100000 }
      ]
    },
    {
      "name": "Verify Toll Receiver Got Credits",
      "command": "sys.raw_sql_exec",
      "data": { "sql": "SELECT credits FROM players WHERE name = 'toll_collector';" },
      "user": "admin",
      "expect": { "status": "ok" },
      "asserts": [
        { "path": "data.rows.0.0", "op": ">", "value": 1000000 }
      ]
    }
  ]
}
