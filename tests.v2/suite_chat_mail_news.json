{
  "name": "Chat, Mail & News Regression",
  "version": "2.0.0",
  "protocol_category": "22_Comm",
  "description": "Coverage for chat, mail, news, and notifications",
  "tests": [
    {
      "name": "Rig: Ensure Admin Sysop",
      "command": "sys.raw_sql_exec",
      "data": { "sql": "UPDATE players SET type = 1 WHERE player_id = 1;" },
      "user": "admin",
      "expect": { "status": "ok" }
    },
    {
      "name": "Setup: User A",
      "setup": "macro_auth_user",
      "username": "comm_user_a",
      "password": "password"
    },
    {
      "name": "Setup: User B",
      "setup": "macro_auth_user",
      "username": "comm_user_b",
      "password": "password"
    },
    {
      "name": "Mail Send",
      "command": "mail.send",
      "data": { "recipient_id": "@comm_user_b_player_id", "subject": "Test", "body": "Body" },
      "user": "comm_user_a",
      "expect": { "status": "ok" }
    },
    {
      "name": "Mail Inbox",
      "command": "mail.inbox",
      "user": "comm_user_b",
      "expect": {
        "status": "ok",
        "items": { "type": "array" }
      },
      "save": { "mail_id": "data.items.0.id" }
    },
    {
      "name": "Mail Read",
      "command": "mail.read",
      "data": { "id": "@mail_id" },
      "user": "comm_user_b",
      "expect": {
        "status": "ok",
        "body": "Body"
      }
    },
    {
      "name": "Mail Delete",
      "command": "mail.delete",
      "data": { "ids": ["@mail_id"] },
      "user": "comm_user_b",
      "expect": { "status": "ok" }
    },
    {
      "name": "Setup: Seed News",
      "command": "sys.raw_sql_exec",
      "data": { "sql": "INSERT INTO news_feed (published_ts, news_category, article_text) VALUES (@{timestamp}, 'economy', 'HEADLINE: Market Crash\nBODY: Prices are falling!');" },
      "user": "admin",
      "expect": { "status": "ok" }
    },
    {
      "name": "News Feed",
      "command": "news.get_feed",
      "user": "comm_user_a",
      "expect": {
        "status": "ok",
        "articles": { "type": "array" }
      },
      "asserts": [
        { "path": "data.articles", "op": "contains", "value": "Market Crash" }
      ]
    },
    {
      "name": "News Read",
      "command": "news.read",
      "data": { "news_id": 1 },
      "user": "comm_user_a",
      "expect": { "status": "ok" }
    },
    {
      "name": "Rig: Clear Notes",
      "command": "sys.raw_sql_exec",
      "data": { "sql": "DELETE FROM player_notes WHERE player_id = @{comm_user_a_player_id} AND scope = 'sector' AND key = '1';" },
      "user": "admin",
      "expect": { "status": "ok" }
    },
    {
      "name": "Notes Set (Setup)",
      "command": "sys.raw_sql_exec",
      "data": { "sql": "INSERT INTO player_notes (player_id, scope, key, note) VALUES (@{comm_user_a_player_id}, 'sector', '1', 'Home');" },
      "user": "admin",
      "expect": { "status": "ok" }
    },
    {
      "name": "Notes List",
      "command": "notes.list",
      "user": "comm_user_a",
      "expect": {
        "status": "ok",
        "notes": { "type": "array" }
      },
      "asserts": [
        { "path": "data.notes.0.note", "op": "==", "value": "Home" }
      ]
    },
    {
      "name": "Setup: Insert Notice",
      "command": "sys.raw_sql_exec",
      "data": { "sql": "INSERT INTO system_notice (created_at, title, body, severity) VALUES (now(), 'Alert', 'Body', 'info');" },
      "user": "admin",
      "expect": { "status": "ok" }
    },
    {
      "name": "Setup: Get Notice ID",
      "command": "sys.raw_sql_exec",
      "data": { "sql": "SELECT system_notice_id FROM system_notice WHERE title = 'Alert' ORDER BY system_notice_id DESC LIMIT 1;" },
      "user": "admin",
      "expect": { "status": "ok" },
      "save": { "notice_id": "data.rows.0.0" }
    },
    {
      "name": "Notice List",
      "command": "notice.list",
      "user": "comm_user_a",
      "expect": { "status": "ok" },
      "asserts": [
        { "path": "data.items.0.title", "op": "==", "value": "Alert" }
      ]
    },
    {
      "name": "Notice Ack",
      "command": "notice.ack",
      "data": { "id": "@notice_id" },
      "user": "comm_user_a",
      "expect": { "status": "ok" }
    }
  ]
}
