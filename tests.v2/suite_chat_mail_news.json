{
  "name": "Chat, Mail & News Regression",
  "version": "2.0.0",
  "protocol_category": "28_Tavern",
  "description": "Coverage for communication and news systems",
  "tests": [
    {
      "name": "Setup: User A",
      "setup": "macro_auth_user",
      "username": "comm_user_a",
      "passwd": "password"
    },
    {
      "name": "Setup: User B",
      "setup": "macro_auth_user",
      "username": "comm_user_b",
      "passwd": "password"
    },
    {
      "name": "Setup: Admin User",
      "setup": "macro_sysop",
      "username": "comm_admin",
      "passwd": "password"
    },
    {
      "name": "Chat Send (Not Implemented)",
      "command": "chat.send",
      "data": { "message": "Hello World", "scope": "global" },
      "user": "comm_user_a",
      "expect": { "error_code": 1101, "message": "Not implemented: chat.send" }
    },
    {
      "name": "Chat History (Not Implemented)",
      "command": "chat.history",
      "data": { "limit": 10 },
      "user": "comm_user_a",
      "expect": { "error_code": 1101, "message": "Not implemented: chat.history" }
    },
    {
      "name": "Chat Broadcast (Normal User Fail - Not Implemented)",
      "command": "chat.broadcast",
      "data": { "message": "System Alert (Normal)" },
      "user": "comm_user_a",
      "expect": { "error_code": 1101, "message": "Not implemented: chat.broadcast" }
    },
    {
      "name": "Chat Broadcast (Admin Fail - Not Implemented)",
      "command": "chat.broadcast",
      "data": { "message": "System Alert (Admin)" },
      "user": "comm_admin",
      "expect": { "error_code": 1101, "message": "Not implemented: chat.broadcast" }
    },
    {
      "name": "Mail Send",
      "command": "mail.send",
      "data": { "recipient_id": "@comm_user_b_player_id", "subject": "Test", "body": "Body" },
      "user": "comm_user_a",
      "expect": { "status": "ok" }
    },
    {
      "name": "Mail Inbox",
      "command": "mail.inbox",
      "user": "comm_user_b",
      "expect": {
        "status": "ok",
        "messages": { "type": "array" }
      },
      "save": { "mail_id": "data.messages[0].id" }
    },
    {
      "name": "Mail Read",
      "command": "mail.read",
      "data": { "id": "@mail_id" },
      "user": "comm_user_b",
      "expect": {
        "status": "ok",
        "message": { "type": "object" }
      },
      "asserts": [
        { "path": "data.message.body", "op": "==", "value": "Body" }
      ]
    },
    {
      "name": "Mail Delete",
      "command": "mail.delete",
      "data": { "ids": ["@mail_id"] },
      "user": "comm_user_b",
      "expect": { "status": "ok" }
    },
    {
      "name": "Setup: Seed News",
      "command": "sys.raw_sql_exec",
      "data": { "sql": "INSERT INTO news_feed (published_ts, news_category, article_text) VALUES (strftime('%s','now'), 'economy', 'Market Crash');" },
      "user": "admin",
      "expect": { "status": "ok" }
    },
    {
      "name": "News Feed",
      "command": "news.get_feed",
      "user": "comm_user_a",
      "expect": {
        "status": "ok",
        "items": { "type": "array" }
      },
      "asserts": [
        { "path": "data.items.*.article_text", "op": "contains", "value": "Market Crash" }
      ]
    },
    {
      "name": "News Read",
      "command": "news.read",
      "data": { "news_id": 1 },
      "user": "comm_user_a",
      "expect": { "status": "ok" }
    },
    {
      "name": "News Mark Read",
      "command": "news.mark_feed_read",
      "user": "comm_user_a",
      "expect": { "status": "ok" }
    },
    {
      "name": "Notes Set (Setup)",
      "command": "sys.raw_sql_exec",
      "data": { "sql": "INSERT INTO player_notes (player_id, scope, key, note) VALUES (@comm_user_a_player_id, 'sector', '1', 'Home');" },
      "user": "admin",
      "expect": { "status": "ok" }
    },
    {
      "name": "Notes List",
      "command": "notes.list",
      "user": "comm_user_a",
      "expect": {
        "status": "ok",
        "notes": { "type": "array" }
      },
      "asserts": [
        { "path": "data.notes.*.note", "op": "==", "value": "Home" }
      ]
    },
    {
      "name": "Setup: Seed Notice",
      "command": "sys.raw_sql_exec",
      "data": { "sql": "INSERT INTO system_notice (created_at, title, body, severity, expires_at) VALUES (strftime('%s','now'), 'Alert', 'Body', 'info', strftime('%s','now')+3600);" },
      "user": "admin",
      "expect": { "status": "ok" },
      "save": { "notice_id": "sqlite_last_insert_rowid()" }
    },
    {
      "name": "Notice List",
      "command": "notice.list",
      "user": "comm_user_a",
      "expect": { "status": "ok" },
      "asserts": [
        { "path": "data.notices.*.title", "op": "==", "value": "Alert" }
      ]
    },
    {
      "name": "Notice Ack",
      "command": "notice.ack",
      "data": { "id": "@notice_id" },
      "user": "comm_user_a",
      "expect": { "status": "ok" }
    }
  ]
}