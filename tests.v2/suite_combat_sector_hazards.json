{
  "name": "Combat Sector Entry Hazards Regression",
  "version": "2.0.0",
  "protocol_category": "23_Combat",
  "description": "Regression tests for all sector entry hazards (mines, fighters, quasars)",
  "tests": [
    {
      "name": "Setup: Hazard Master User",
      "setup": "macro_auth_user",
      "username": "hazard_master",
      "password": "password123"
    },
    {
      "name": "Setup: Victim User",
      "setup": "macro_auth_user",
      "username": "hazard_victim",
      "password": "password"
    },
    {
      "name": "Rig: Create Warp Links",
      "command": "sys.raw_sql_exec",
      "user": "admin",
      "data": {
        "sql": "INSERT INTO sector_warps (from_sector, to_sector) VALUES (1, 555), (555, 1) ON CONFLICT DO NOTHING;"
      },
      "expect": { "status": "ok" }
    },
    {
      "name": "Rig: Position players at Sector 1",
      "command": "sys.raw_sql_exec",
      "user": "admin",
      "data": {
        "sql": "UPDATE players SET sector_id = 1 WHERE name IN ('hazard_victim', 'hazard_master');"
      },
      "expect": { "status": "ok" }
    },
    {
      "name": "Rig: Position ships at Sector 1",
      "command": "sys.raw_sql_exec",
      "user": "admin",
      "data": {
        "sql": "UPDATE ships SET sector_id = 1 WHERE ship_id IN (SELECT ship_id FROM players WHERE name IN ('hazard_victim', 'hazard_master'));"
      },
      "expect": { "status": "ok" }
    },
    {
      "name": "Victim Status Before Entry",
      "command": "combat.status",
      "user": "hazard_victim",
      "expect": { "status": "ok" },
      "save": { "hull_initial": "data.hull" }
    },
    {
      "name": "Victim Warps to Hazard Sector (Multi-Hazard Entry)",
      "command": "move.warp",
      "data": { "to_sector_id": 555 },
      "user": "hazard_victim",
      "expect": { "status": "ok" },
      "asserts": [
        { "path": "data.sector_id", "op": "==", "value": 555 }
      ]
    },
    {
      "name": "Victim Status After Entry (Multiple Hazards)",
      "command": "combat.status",
      "user": "hazard_victim",
      "expect": { "status": "ok" },
      "asserts": [
        { "path": "data.hull", "op": "<", "value": "@hull_initial" }
      ]
    },
    {
      "name": "Verify Multiple Damage Sources",
      "command": "sys.raw_sql_exec",
      "data": { "sql": "SELECT COUNT(DISTINCT type) as hazard_types FROM engine_events WHERE actor_player_id = @{hazard_victim_player_id} AND type LIKE 'combat.hit%';" },
      "user": "admin",
      "expect": { "status": "ok" },
      "asserts": [
        { "path": "data.rows.0.0", "op": ">=", "value": 1 }
      ]
    },
    {
      "name": "Rig: Give Transwarp and Heal Ship",
      "command": "sys.raw_sql_exec",
      "user": "admin",
      "data": {
        "sql": "UPDATE ships SET has_transwarp = TRUE, hull = 100, shields = 50 WHERE ship_id = (SELECT ship_id FROM players WHERE name = 'hazard_victim');"
      },
      "expect": { "status": "ok" }
    },
    {
      "name": "Victim Transwarps to Hazard Sector",
      "command": "move.transwarp",
      "data": { "to_sector_id": 555 },
      "user": "hazard_victim",
      "expect": { "status": "ok" }
    },
    {
      "name": "Victim Status After Transwarp",
      "command": "combat.status",
      "user": "hazard_victim",
      "expect": { "status": "ok" },
      "asserts": [
        { "path": "data.hull", "op": "<", "value": 100 }
      ]
    },
    {
      "name": "Master Warps to Hazard Sector (Owner/Friendly)",
      "command": "move.warp",
      "data": { "to_sector_id": 555 },
      "user": "hazard_master",
      "expect": { "status": "ok" }
    },
    {
      "name": "Master Status After Entry (Should be No Damage)",
      "command": "combat.status",
      "user": "hazard_master",
      "expect": { "status": "ok" },
      "asserts": [
        { "path": "data.hull", "op": "==", "value": 100 }
      ]
    }
  ]
}
