{
  "tests": [
    {
      "name": "Setup: CEO User",
      "setup": "macro_rich_user",
      "username": "ceo_user",
      "password": "password",
      "credits": 100000
    },
    {
      "name": "Setup: Officer User",
      "setup": "macro_auth_user",
      "username": "officer_user",
      "password": "password"
    },
    {
      "name": "Setup: Member User",
      "setup": "macro_auth_user",
      "username": "member_user",
      "password": "password"
    },
    {
      "name": "Setup: Outsider User",
      "setup": "macro_auth_user",
      "username": "outsider_user",
      "password": "password"
    },
    {
      "name": "Setup: Create Corporation (CEO)",
      "command": "corp.create",
      "data": { "name": "PermsCorp" },
      "user": "ceo_user",
      "save": { "corp_id": "data.corp_id" },
      "expect": { "status": "ok" }
    },
    {
      "name": "Setup: Add Members via SQL (Bypass Invite Flow)",
      "command": "sys.raw_sql_exec",
      "data": { "sql": "INSERT OR IGNORE INTO corp_members (corp_id, player_id, role) VALUES (@corp_id, @officer_user_player_id, 'Officer'), (@corp_id, @member_user_player_id, 'Member');" },
      "user": "admin",
      "expect": { "status": "ok" }
    },
    {
      "name": "Guard: Unauthorized Kick (Member kicks Officer)",
      "command": "corp.kick",
      "data": { "target_player_id": "@officer_user_player_id" },
      "user": "member_user",
      "expect": { 
        "status": "refused", 
        "error": { "code": 1111, "message": "Insufficient permissions" }
      }
    },
    {
      "name": "Guard: Unauthorized Kick (Outsider kicks Member)",
      "command": "corp.kick",
      "data": { "target_player_id": "@member_user_player_id" },
      "user": "outsider_user",
      "expect": { 
        "status": "error", 
        "error": { "code": 1302, "message": "You are not in a corporation." }
      }
    },
    {
      "name": "Guard: Kick Non-Member",
      "command": "corp.kick",
      "data": { "target_player_id": "@outsider_user_player_id" },
      "user": "ceo_user",
      "expect": { 
        "status": "error", 
        "error": { "code": 1302, "message": "Target player is not a member of your corporation." } 
      }
    },
    {
      "name": "Action: CEO Kicks Member (Success)",
      "command": "corp.kick",
      "data": { "target_player_id": "@member_user_player_id" },
      "user": "ceo_user",
      "expect": { 
        "status": "ok",
        "data": { "kicked_player_id": "@member_user_player_id" }
      }
    },
    {
      "name": "Verify: Member Removed",
      "command": "sys.raw_sql_exec",
      "data": { "sql": "SELECT COUNT(*) FROM corp_members WHERE player_id = @member_user_player_id AND corp_id = @corp_id;" },
      "user": "admin",
      "expect": { "status": "ok", "data": { "rows": [[0]] } }
    },
    {
      "name": "Guard: Transfer CEO (Non-CEO attempts)",
      "command": "corp.transfer_ceo",
      "data": { "target_player_id": "@ceo_user_player_id" },
      "user": "officer_user",
      "expect": { 
        "status": "error", 
        "error": { "code": 1111, "message": "Only active corporation CEOs may transfer leadership." } 
      }
    },
    {
      "name": "Action: Transfer CEO to Officer (Success)",
      "command": "corp.transfer_ceo",
      "data": { "target_player_id": "@officer_user_player_id" },
      "user": "ceo_user",
      "expect": { 
        "status": "ok",
        "data": { "new_ceo_player_id": "@officer_user_player_id" }
      }
    },
    {
      "name": "Verify: Roles Swapped",
      "command": "sys.raw_sql_exec",
      "data": { "sql": "SELECT role FROM corp_members WHERE player_id = @officer_user_player_id UNION ALL SELECT role FROM corp_members WHERE player_id = @ceo_user_player_id;" },
      "user": "admin",
      "expect": { 
        "status": "ok", 
        "data": { "rows": [["Leader"], ["Officer"]] } 
      }
    },
    {
      "name": "Verify: Corp Owner Updated",
      "command": "sys.raw_sql_exec",
      "data": { "sql": "SELECT owner_id FROM corporations WHERE id = @corp_id;" },
      "user": "admin",
      "expect": { 
        "status": "ok", 
        "data": { "rows": [["@officer_user_player_id"]] } 
      }
    }
  ]
}