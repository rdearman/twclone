{
  "tests": [
    {
      "name": "Setup: Attacker",
      "setup": "macro_auth_user",
      "username": "attacker_player",
      "password": "password"
    },
    {
      "name": "Setup: Defender",
      "setup": "macro_auth_user",
      "username": "defender_player",
      "password": "password"
    },
    {
      "name": "Action: Valid Attack in Sector 300",
      "command": "combat.attack",
      "data": { "target_ship_id": 1013, "commit_fighters": 10 },
      "user": "attacker_player",
      "expect": { 
        "status": "ok",
        "data": {
            "attacker_destroyed": false,
            "defender_destroyed": false
        }
      }
    },
    {
      "name": "Verify: Defender Damage Persistence",
      "command": "sys.raw_sql_exec",
      "data": { "sql": "SELECT 1 FROM ships WHERE ship_id = 1013 AND (hull < 500 OR shields < 500);" },
      "user": "admin",
      "expect": { 
         "status": "ok", 
         "data": { "rows": [[1]] } 
      }
    },
    {
      "name": "Setup: Move Players to FedSpace (Sector 1)",
      "command": "sys.raw_sql_exec",
      "data": { "sql": "UPDATE players SET sector_id = 1 WHERE player_id IN (@{attacker_player_player_id}, @{defender_player_player_id});" },
      "user": "admin"
    },
    {
      "name": "Setup: Move Ships to FedSpace (Sector 1)",
      "command": "sys.raw_sql_exec",
      "data": { "sql": "UPDATE ships SET sector_id = 1 WHERE ship_id IN (1012, 1013);" },
      "user": "admin"
    },
    {
      "name": "Guard: Attack in FedSpace (Should Fail)",
      "command": "combat.attack",
      "data": { "target_ship_id": 1013 },
      "user": "attacker_player",
      "expect": { "status": "ok" } 
    }
  ]
}