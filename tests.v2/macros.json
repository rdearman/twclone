{
  "macro_bootstrap_admin": [
    {
      "name": "Macro: Bootstrap Admin",
      "command": "auth.login",
      "data": { "username": "System", "passwd": "BOT" },
      "user": "admin",
      "save": { "session": "data.session", "admin_player_id": "data.player_id" },
      "stop_on_fail": true
    }
  ],
  "macro_auth_user": [
    {
      "setup": "macro_bootstrap_admin"
    },
    {
      "name": "Macro: Register User",
      "command": "auth.register",
      "data": { "username": "@username", "passwd": "@password" },
      "register_if_missing": true
    },
    {
      "name": "Macro: Login User",
      "command": "auth.login",
      "data": { "username": "@username", "passwd": "@password" },
      "user": "@username",
      "save": { "session": "data.session", "@username_player_id": "data.player_id" },
      "stop_on_fail": true
    }
  ],
  "macro_sysop": [
    {
      "setup": "macro_auth_user",
      "username": "@username",
      "password": "@password"
    },
    {
      "name": "Macro: Promote Sysop",
      "command": "sys.raw_sql_exec",
      "data": { "sql": "UPDATE players SET type = 1 WHERE name = '@username';" },
      "user": "admin",
      "expect": { "status": "ok" },
      "stop_on_fail": true
    }
  ],
    "macro_fund_player": [
      {
        "name": "Macro: Fund Player (Petty)",
        "command": "sys.raw_sql_exec",
        "data": { "sql": "UPDATE players SET credits = @amount WHERE name = '@username';" },
        "user": "admin"
      },
      {
        "name": "Macro: Fund Player (Bank)",
        "command": "sys.raw_sql_exec",
        "data": { "sql": "INSERT INTO bank_accounts (owner_type, owner_id, balance, currency, is_active) SELECT 'player', id, @amount, 'CRD', 1 FROM players WHERE name = '@username' ON CONFLICT (owner_type, owner_id, currency) DO UPDATE SET balance = @amount;" },
        "user": "admin"
      }
    ],
    "macro_rich_user": [
      {
        "setup": "macro_auth_user",
        "username": "@username",
        "password": "@password"
      },
      {
        "setup": "macro_fund_player",
        "username": "@username",
        "amount": 1000000
      }
    ],
    "macro_user_in_sector": [
      {
        "setup": "macro_auth_user",
        "username": "@username",
        "password": "@password"
      },
      {
        "name": "Macro: Ensure Shiptype Exists",
        "command": "sys.raw_sql_exec",
        "data": { "sql": "INSERT INTO shiptypes (shiptypes_id, name, basecost, maxholds) VALUES (1, 'Scout', 1000, 100) ON CONFLICT (shiptypes_id) DO NOTHING;" },
        "user": "admin",
        "expect": { "status": "ok" }
      },
      {
        "name": "Macro: Create Ship for User",
        "command": "sys.raw_sql_exec",
        "data": { "sql": "INSERT INTO ships (type_id, name, sector_id, holds) SELECT 1, 'TestShip', 1, 100 WHERE NOT EXISTS (SELECT 1 FROM ships WHERE owner_id = (SELECT player_id FROM players WHERE name = '@username') LIMIT 1) RETURNING ship_id;" },
        "user": "admin",
        "expect": { "status": "ok" }
      },
      {
        "name": "Macro: Link Ship to Player",
        "command": "sys.raw_sql_exec",
        "data": { "sql": "INSERT INTO ship_ownership (ship_id, player_id, is_primary) SELECT (SELECT MAX(ship_id) FROM ships), player_id, TRUE FROM players WHERE name = '@username' ON CONFLICT DO NOTHING;" },
        "user": "admin",
        "expect": { "status": "ok" }
      },
      {
        "name": "Macro: Update Player Sector",
        "command": "sys.raw_sql_exec",
        "data": { "sql": "UPDATE players SET sector_id = 1 WHERE name = '@username';" },
        "user": "admin",
        "expect": { "status": "ok" },
        "stop_on_fail": true
      }
    ]
}
