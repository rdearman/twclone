â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                 COMMODITY EXTENSIBILITY - QUICK REFERENCE                      â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

SCENARIO: Add 2 new commodities (1 legal: WATER, 1 illegal: SPICE)

â”Œâ”€ CAN DO WITHOUT CODE CHANGES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                                 â”‚
â”‚  âœ… Add to commodities table
â”‚     INSERT INTO commodities VALUES ('WTR', 'Water', false, 80, 15);
â”‚     INSERT INTO commodities VALUES ('SPC', 'Spice', true, 1200, 80);
â”‚     [Immediate effect - works immediately]
â”‚
â”‚  âœ… Add to entity_stock (ports/planets)
â”‚     [Works automatically if commodity is in commodities table]
â”‚
â”‚  âœ… Enable planet market trading
â”‚     [Already works dynamically - checks commodities.illegal at runtime]
â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€ REQUIRES DATABASE SCHEMA MIGRATION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                                 â”‚
â”‚  âŒ Ship cargo trading
â”‚     Problem: Ships table has hardcoded columns (ore, organics, etc.)
â”‚     Fix needed: ALTER TABLE ships ADD COLUMN water BIGINT;
â”‚                 ALTER TABLE ships ADD COLUMN spice BIGINT;
â”‚     Impact: Schema migration (default values = 0 for all 10,000+ ships)
â”‚     Effort: ~10 lines SQL, but affects all ships
â”‚
â”‚  âŒ Cargo hold constraint  
â”‚     Problem: CHECK constraint explicitly sums all 7 commodities
â”‚     Fix needed: DROP CONSTRAINT check_current_cargo_limit;
â”‚                 ALTER TABLE ships ADD CONSTRAINT check_current_cargo_limit 
â”‚                   CHECK ((colonists+ore+organics+equipment+slaves+weapons+drugs+water+spice) <= holds);
â”‚     Impact: Constraint update
â”‚     Effort: ~5 lines SQL
â”‚
â”‚  âŒ Port trading support
â”‚     Problem: port_trade table has CHECK constraint limiting to 6 commodities
â”‚     Fix needed: ALTER TABLE port_trade DROP CONSTRAINT port_trade_commodity_check;
â”‚                 ALTER TABLE port_trade ADD CONSTRAINT port_trade_commodity_check
â”‚                   CHECK (commodity IN ('ORE','ORG','EQU','SLV','WPN','DRG','WTR','SPC'));
â”‚     Impact: Constraint update
â”‚     Effort: ~5 lines SQL
â”‚
â”‚  âŒ Planet goods support
â”‚     Problem: planet_goods has CHECK limiting to 5 commodities (no illegals)
â”‚     Fix needed: Similar constraint update
â”‚     Impact: Constraint update
â”‚     Effort: ~5 lines SQL
â”‚
â”‚  âš ï¸  Update schema files for future deployments
â”‚     - sql/pg/000_tables.sql (3 constraints)
â”‚     - sql/my/000_tables.sql (3 constraints)
â”‚     Effort: ~15 lines SQL across 2 files
â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€ REQUIRES SERVER CODE CHANGES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                                 â”‚
â”‚  âŒ Server cargo update support
â”‚     File: src/server_ships.c
â”‚     Function: h_update_ship_cargo() (lines 910-947)
â”‚     Problem: Hardcoded if/else chain for each commodity
â”‚     Fix needed: Add 2 new branches:
â”‚                 else if (strcasecmp(commodity_code, "WTR") == 0)
â”‚                   col_name = "water";
â”‚                 else if (strcasecmp(commodity_code, "SPC") == 0)
â”‚                   col_name = "spice";
â”‚     Impact: Server binary must be recompiled
â”‚     Effort: ~10 lines C, 1 rebuild
â”‚
â”‚  âŒ Database queries for ship cargo
â”‚     Files: Multiple (src/db/repo/repo_*.c, src/server_*.c)
â”‚     Problem: Every query selecting ship cargo explicitly lists all columns
â”‚     Fix needed: Search/replace all SELECT statements to include water, spice
â”‚     Impact: Could affect dozens of queries
â”‚     Effort: ~20 replacements
â”‚
â”‚  âœ… Port trading logic
â”‚     NO CHANGES NEEDED - uses commodity_code dynamically
â”‚
â”‚  âœ… Market trading logic
â”‚     NO CHANGES NEEDED - checks commodities.illegal at runtime
â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

EFFORT BREAKDOWN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Phase 1: Schema Changes (REQUIRED)
  Database constraints update:    ~20 lines SQL (5 mins)
  Schema file updates:             ~15 lines SQL (5 mins)
  Subtotal:                        ~10 minutes

Phase 2: Server Code (REQUIRED IF ships carry new commodities)
  h_update_ship_cargo() changes:   ~10 lines C (5 mins)
  Query updates:                   ~20 replacements (15 mins)
  Rebuild server:                  ~2 minutes
  Subtotal:                        ~25 minutes

Phase 3: Configuration (OPTIONAL)
  Add port_trade entries:          SQL script (5 mins)
  Update port generation:          ~10 lines SQL if new defaults (5 mins)
  Subtotal:                        ~10 minutes

TOTAL EFFORT: 45-60 minutes (for 2 new commodities)

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

KEY INSIGHTS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ”´ CRITICAL ISSUE: Denormalized Ship Cargo Storage
   The ships table uses one column per commodity. This is NOT extensible.
   
   Recommendation for future: Refactor to ship_cargo table
   (ship_id, commodity_code, quantity) - fully dynamic

ğŸŸ¡ MODERATE ISSUE: CHECK Constraints as Whitelists
   Port_trade and planet_goods use explicit commodity lists in CHECK
   
   Recommendation for future: Use foreign keys to commodities table
   This already works for entity_stock

ğŸŸ¢ GOOD AREAS:
   - Commodities table: fully flexible, no constraints
   - Entity stock: fully dynamic, works with any code
   - Market logic: checks illegal flag at runtime
   - Protocol: can accept any code if database allows

BOTTOM LINE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

âœ… CAN ADD: Commodities to trading without code (only database)
âŒ CAN'T DO: Ships can't carry new types without schema + code changes
âš ï¸  PARTIALLY: Port trading works with DB constraint fix only

For 3-5 new commodities, the effort is still manageable (~2 hours).
For 10+ new commodities, should consider architecture refactoring.

