# 07. Server to Server Protocol (S2S)

**Scope**: Defines the message exchange between the **Server** (player-facing) and the **Engine** (simulation).

## 1. Transport & Framing

*   **Protocol**: TCP (Server listens, Engine connects).
*   **Framing**: 4-byte big-endian length prefix + UTF-8 JSON envelope.
*   **Limits**: `frame_size_limit` (default 64 KiB).

## 2. Authentication

*   **Method**: HMAC-SHA256.
*   **Key Source**: `s2s_keys` database table.
*   **Mechanism**: `auth` field in envelope contains `key_id` and `sig` (signature). Signature is calculated over the canonicalized JSON (excluding `auth.sig`).

## 3. Envelope

```json
{
  "v": 1,
  "id": "01J93QXK...",
  "ts": 1737990000,
  "src": "engine|server",
  "dst": "server|engine",
  "type": "s2s.command.push",
  "auth": { "key_id": "k1", "sig": "..." },
  "payload": { ... }
}
```

## 4. Message Catalogue

### 4.1 Health & Lifecycle

**`s2s.health.check` (Server -> Engine)**
*   Purpose: Reachability and identity.
*   Response: `s2s.health.ack` `{ "role": "engine", "version": "0.1.0", "uptime_s": 120 }`

**`s2s.engine.shutdown` (Server -> Engine)**
*   Payload: `{ "grace_ms": 5000, "reason": "maintenance" }`
*   Effect: Graceful stop of engine.

**`s2s.engine.pause` (Server -> Engine)**
*   Payload: `{ "reason": "admin_pause" }`

### 4.2 Data Synchronization

**`s2s.broadcast.sweep` (Server -> Engine)**
*   Purpose: Request engine to publish pending broadcasts.
*   Payload: `{ "since_ts": 1737900000 }`
*   Response: `s2s.ack` `{ "ok": true, "since_ts": ... }`

**`s2s.command.push` (Engine -> Server)**
*   Purpose: Enqueue a server-side command (mutation) generated by the engine.
*   Payload:
    ```json
    {
      "cmd_type": "notice.publish",
      "idem_key": "uniq_key",
      "payload": { ... },
      "priority": 100
    }
    ```
*   Response: `s2s.ack` `{ "accepted": true, "duplicate": false, "cmd_id": 123 }`

**`s2s.config.bump` (Server -> Engine)**
*   Payload: `{ "version": 5 }`
*   Effect: Engine reloads configuration from DB.

### 4.3 Errors

**`s2s.error`**
*   Payload: `{ "code": "unsupported_type", "message": "...", "details": {} }`

## 5. Admin / Maintenance RPCs (Mapped via S2S or DB)

These operations are triggered by the Server (via Admin RPCs) and executed by the Engine (via DB commands or S2S).

*   **`admin.engine.force_tick.v1`**: Force specific jobs (`port_refresh`, `decay`).
*   **`admin.config.set.v1`**: Update game config.
*   **`world.set_sector_status.v1`**: Change sector rules (FedSpace, Neutral).
*   **`admin.player.update_all_ships.v1`**: Mass update of ship stats.
