
====


### SECTION A — FUNCTION PRESENCE MATRIX

| Original Name (org_database_market.c) | Refactored Name (database_market.c) | Present? | Defined? | Signature Compatible? | Status | Reason |
| --- | --- | --- | --- | --- | --- | --- |
| `db_insert_commodity_order` | `db_insert_commodity_order` | YES | YES | YES | PASS | Logic for parameters and execution preserved. |
| `db_update_commodity_order` | `db_update_commodity_order` | YES | YES | YES | PASS | Logic preserved; SQL matches. |
| `db_cancel_commodity_orders_for_actor_and_commodity` | `db_cancel_commodity_orders_for_actor_and_commodity` | YES | YES | YES | PASS | Logic preserved. |
| `db_cancel_commodity_orders_for_port_and_commodity` | `db_cancel_commodity_orders_for_port_and_commodity` | YES | YES | YES | PASS | Wrapper preserved. |
| `db_get_open_order` | `db_get_open_order` | YES | YES | YES | PASS | Logic preserved; return codes adapted to abstraction. |
| `db_get_open_order_for_port` | `db_get_open_order_for_port` | YES | YES | YES | PASS | Wrapper preserved. |
| `db_load_open_orders_for_commodity` | `db_load_open_orders_for_commodity` | YES | YES | YES | PASS | Implementation changed from 2-pass count to 1-pass realloc, but external behavior preserved. |
| `db_insert_commodity_trade` | `db_insert_commodity_trade` | YES | YES | YES | FAIL | Parameter binding order mismatch with SQL columns. |
| `db_list_actor_orders` | `db_list_actor_orders` | YES | YES | YES | PASS | Logic and JSON construction preserved. |
| `db_list_port_orders` | `db_list_port_orders` | YES | YES | YES | PASS | Wrapper preserved. |
| `db_orders_summary` | `db_orders_summary` | YES | YES | YES | PASS | Logic and JSON grouping preserved. |

### SECTION B — BEHAVIOUR PRESERVATION FLAGS

* **`db_insert_commodity_trade`**:
* **Change**: Parameter binding order is misaligned with the SQL column list.
* **Details**: The SQL explicitly lists columns: `... price, trade_at, buyer_actor_type ...`. The refactored code binds `params[4]` (which is `buyer_actor_type` text) to `$5` (which corresponds to `trade_at`). It binds `params[5]` (which is `now` timestamp) to `$6` (which corresponds to `buyer_actor_type`).
* **Evidence**:
* Original: `VALUES (?, ?, ?, ?, strftime('%s', 'now'), ?, ...)` (Hardcoded timestamp, next param is buyer_type).
* Refactor SQL: `VALUES ($1, ..., $5, $6, ...)`
* Refactor Bind: `params[4] = db_bind_text(buyer_actor_type);` (Mapped to $5/`trade_at`).


* **Impact**: Data corruption. The actor type string will be inserted into the timestamp column, and the timestamp integer will be inserted into the actor type text column.



### SECTION C — SUMMARY

* **Total functions in A**: 11
* **Missing in B**: 0
* **Suspected stubs in B**: 0
* **High-risk behavioural divergences (top 5)**:
1. `db_insert_commodity_trade`: Critical parameter misalignment causes data types to be swapped between `trade_at` and `buyer_actor_type` columns.


* **Overall verdict**: **FAIL**


=====

### SECTION A — FUNCTION PRESENCE MATRIX

| Original Function (org_) | Present in B? | Status | Reason |
| --- | --- | --- | --- |
| `prep` | NO | PASS | Internal helper, replaced by DB API. |
| `db_player_settings_init` | YES | PASS | Logic compatible (A sets global, B returns 0 as context passed explicitly). |
| `type_to_s` | NO | N/A | Internal helper. Absence causes logic loss in `db_prefs_set_one` (see below). |
| `db_prefs_set_one` | YES | FAIL | Logic loss. B explicitly ignores `type` parameter (`(void)t`) and does not store it. |
| `db_prefs_get_one` | YES | PASS | Signature and behavior compatible. |
| `db_prefs_get_all` | YES | FAIL | Logic loss. A selects `key, type, value`. B only selects `key, value`. |
| `db_get_player_pref_int` | YES | PASS | Signature and behavior compatible. |
| `db_get_player_pref_string` | YES | PASS | Signature and behavior compatible. |
| `db_subscribe_upsert` | YES | PASS | Signature and behavior compatible. |
| `db_subscribe_disable` | YES | FAIL | Return logic altered. A checks lock status and returns +1. B does not check and always sets `*locked_out = 0`. |
| `db_subscribe_list` | NO | FAIL | Function is missing in File B. |
| `db_bookmark_upsert` | YES | PASS | Signature and behavior compatible. |
| `db_bookmark_remove` | YES | PASS | Signature and behavior compatible. |
| `db_bookmark_list` | YES | PASS | Signature and behavior compatible. |
| `db_avoid_add` | YES | PASS | Signature and behavior compatible. |
| `db_avoid_remove` | YES | PASS | Signature and behavior compatible. |
| `db_avoid_list` | YES | PASS | Signature and behavior compatible. |
| `db_note_set` | YES | PASS | Signature and behavior compatible. |
| `db_note_delete` | YES | PASS | Signature and behavior compatible. |
| `db_note_list` | YES | PASS | Signature and behavior compatible. |
| `db_for_each_subscriber` | YES | FAIL | Logic loss. B removes wildcard/domain matching logic. |

### SECTION B — BEHAVIOUR PRESERVATION FLAGS

* **`db_prefs_set_one`**: Data loss.
* **Change**: A converts enum `t` to string and stores it in `type` column. B casts `t` to void and ignores it.
* **Evidence A**: `sqlite3_bind_text (st, 3, type_str, ...)`
* **Evidence B**: `(void)t; return 0;` (implicit in not binding/using `t` in SQL)


* **`db_prefs_get_all`**: Data loss.
* **Change**: A retrieves the `type` column. B does not.
* **Evidence A**: `SELECT key, type, value FROM player_prefs`
* **Evidence B**: `SELECT key, value FROM player_prefs`


* **`db_subscribe_disable`**: Return semantics changed / Feature broken.
* **Change**: A checks if a subscription is locked and returns `+1` if so, preventing the disable. B attempts update blindly and hardcodes the output status to 0.
* **Evidence A**: `if (locked) { return +1; }`
* **Evidence B**: `if (locked_out) *locked_out = 0; return 0;`


* **`db_for_each_subscriber`**: Logic removed.
* **Change**: A manually constructs a wildcard string (`domain.*`) and checks `(event_type = ?1 OR event_type = ?2)`. B only checks exact match.
* **Evidence A**: `snprintf (domain_star, ... "%s.*", domain);`
* **Evidence B**: `WHERE event_type = $1` (No wildcard generation or binding).



### SECTION C — SUMMARY

* **Total functions in A**: 21 (excluding `prep`)
* **Missing in B**: 1 (`db_subscribe_list`)
* **Suspected stubs in B**: 0 (Logic present but incorrect/simplified in flagged functions)
* **High-risk behavioural divergences (top 5)**:
1. `db_subscribe_list`: Missing entirely.
2. `db_for_each_subscriber`: Wildcard domain matching removed.
3. `db_subscribe_disable`: Lock check logic removed; return codes changed.
4. `db_prefs_set_one`: Type information discarded.
5. `db_prefs_get_all`: Type information not retrieved.



**Overall verdict: FAIL**

====



### SECTION A — FUNCTION PRESENCE MATRIX

| Original Name (org_engine_consumer.c) | Refactored Name (engine_consumer.c) | Present? | Defined? | Signature Compatible? | Status | Reason |
| --- | --- | --- | --- | --- | --- | --- |
| `get_now_epoch` | `get_now_epoch` | YES | YES | YES | PASS | Logic identical. |
| `csv_contains` | `csv_contains` | YES | YES | YES | PASS | Logic identical. |
| `load_watermark` | `load_watermark` | YES | YES | YES | PASS | Adapted to DB abstraction. |
| `save_watermark` | `save_watermark` | YES | YES | YES | PASS | Adapted to DB abstraction. |
| `fetch_max_event_id` | `fetch_max_event_id` | YES | YES | YES | PASS | Adapted to DB abstraction. |
| `quarantine` | `quarantine` | YES | YES | YES | FAIL | Logic broken due to column index mismatch (see Section B). |
| `handle_ship_self_destruct_initiated` | `handle_ship_self_destruct_initiated` | YES | YES | YES | PASS | Adapted to expanded query columns. |
| `engine_event_handler_player_trade_v1` | `engine_event_handler_player_trade_v1` | YES | YES | YES | PASS | Adapted to expanded query columns. |
| `handle_event` | `handle_event` | YES | YES | YES | PASS | Logic identical. |
| `engine_consume_tick` | `engine_consume_tick` | YES | YES | YES | PASS | Logic preserved, query expanded. |

### SECTION B — BEHAVIOUR PRESERVATION FLAGS

* **`quarantine`**
* **Changed**: The function reads column index 3 expecting the `payload`.
* **Why it matters**: In the refactored `engine_consume_tick`, the query was expanded to `SELECT id, ts, type, actor_player_id, sector_id, payload`. Index 3 is now `actor_player_id` (integer), and `payload` is at index 5. The handler functions were updated to use index 5, but `quarantine` was not.
* **Evidence**:
* Refactored Query: `snprintf(expanded_sql... "SELECT id, ts, type, actor_player_id, sector_id, payload ...")`
* Refactored `quarantine`: `const char *payload = db_res_col_text(row, 3, &err);` (Reads `actor_player_id` instead of `payload`).





### SECTION C — SUMMARY

* **Total functions in A**: 10
* **Missing in B**: 0
* **Suspected stubs in B**: 0
* **High-risk behavioural divergences (top 5)**:
1. `quarantine`: Saves the `actor_player_id` into the `payload` column of the deadletter table due to using the old column index (3) instead of the new one (5).


* **Overall verdict**: **FAIL**

====


### SECTION A — FUNCTION PRESENCE MATRIX

| Original Function (org_) | Present in B? | Status | Reason |
| --- | --- | --- | --- |
| (None) | N/A | PASS | File A contains only global variable definitions and initializations, no function definitions. |

### SECTION B — BEHAVIOUR PRESERVATION FLAGS

* **Global Variables Removed**
* **Change**: Numerous global arrays and variables defined in A are missing in B: `nameCollection`, `firstSyllable`, `middleSyllable`, `lastSyllable`, `client_sock`, `sectorcount`, `WARP_WAIT`, `g_begin_timeval`, `g_end_timeval`, `g_t_timeval`, `symbols`, `players`, `ships`, `planets`, `ports`, `sectors`, `configdata`, `shiptypes`, `planetTypes`, `nodes`, `portconversion`, `sell_base_prices`, `buy_base_prices`.
* **Why it matters**: These variables hold game state and configuration. Their removal implies data loss or link errors.
* **Evidence**: A defines `char *nameCollection[] = ...`, B does not. A defines `struct player **players;`, B does not.


* **Initialization Logic Changed**
* **Change**: `g_armid_config` is initialized with specific default values in A but zero-initialized in B.
* **Why it matters**: Game logic relying on these default mine settings will behave differently (e.g., probability 0.00 vs 0.02).
* **Evidence**: A: `.base_trigger_chance = 0.02`. B: `g_armid_config = {0}`.


* **Atomic Counters Removed**
* **Change**: `g_trades_executed`, `g_combat_rounds`, `g_failed_operations` are defined in A but missing in B.
* **Why it matters**: Metrics tracking provided by these globals will be lost.
* **Evidence**: A defines `atomic_int_fast64_t g_trades_executed = 0;`. B does not.



### SECTION C — SUMMARY

* **Total functions in A**: 0 (File contains only global variables).
* **Missing in B**: N/A
* **Suspected stubs in B**: N/A
* **High-risk behavioural divergences (top 5)**:
1. **Massive Global State Removal**: Core arrays like `nameCollection`, `players`, `ships`, `sectors` are gone.
2. **Configuration Reset**: `g_armid_config` lost its default tuning values (reset to 0).
3. **Metrics Loss**: Atomic counters for trades and combat are missing.
4. **Lookup Tables Missing**: `portconversion` and price arrays (`sell_base_prices`) are missing.
5. **Name Generation Data Missing**: Syllable arrays for name generation are missing.


* **Overall verdict**: **FAIL**

While no functions were removed (as there were none), the refactored file fails to define the majority of the global state present in the original file, which constitutes a functional failure for a direct translation.

===

Here is the consolidated audit report. I have updated the status of schema and seeding functions to **EXCUSED** based on your instruction that these are handled via external SQL scripts.

### **C CODE AUDIT REPORT**

**Target File:** `org_database.c` (Original)
**Refactored Files:** `game_db.c`, `database_cmd.c`
**Context:** Database creation and seeding have been offloaded to external SQL scripts (PostgreSQL migration).

---

### **SECTION A — FUNCTION PRESENCE MATRIX**

| Original Function (`org_database.c`) | Refactored Status | Notes |
| --- | --- | --- |
| **Schema & Seeding** |  |  |
| `db_create_tables` | **EXCUSED** | Handled by external SQL scripts. |
| `db_insert_defaults` | **EXCUSED** | Handled by external SQL scripts. |
| `db_seed_cron_tasks` | **EXCUSED** | Handled by external SQL scripts. |
| `db_ensure_auth_schema` | **EXCUSED** | Handled by external SQL scripts. |
| `db_ensure_idempotency_schema` | **EXCUSED** | Handled by external SQL scripts. |
| `db_seed_ai_qa_bot_bank_account...` | **EXCUSED** | Handled by external SQL scripts. |
| `db_check_legacy_schema` | **EXCUSED** | Not required for new DB. |
| **Connection & Config** |  |  |
| `db_init` | **CHANGED** | `game_db_init` only opens connection. Valid per new context. |
| `db_close` | **PASS** | `game_db_close` |
| `db_get_handle` | **PASS** | `game_db_get_handle` |
| `db_get_int_config` | **PASS** | `db_get_config_int` in `database_cmd.c`. |
| `db_load_ports` | **FAIL** | Logic to load specific port configurations into memory is missing. |
| **Session Management** |  |  |
| `db_session_create` | **PASS** | Re-implemented in `database_cmd.c`. |
| `db_session_lookup` | **PASS** | Re-implemented in `database_cmd.c`. |
| `db_session_revoke` | **FAIL** | **MISSING**. No mechanism to log out/invalidate tokens. |
| `db_session_refresh` | **FAIL** | **MISSING**. No mechanism to extend session TTL. |
| **Transactions & Concurrency** |  |  |
| `db_begin_transaction` | **FAIL** | **MISSING**. Original had retry logic for locking contention. New `db_api` lacks global retry wrapper. |
| `db_commit` | **FAIL** | **MISSING**. No direct equivalent exposed in `database_cmd.c`. |
| `db_safe_rollback` | **FAIL** | **MISSING**. Safety wrapper for rollback is gone. |
| `db_thread_safe_update_single_column` | **FAIL** | **MISSING**. Utility for thread-safe updates is gone. |
| **Game Logic & Idempotency** |  |  |
| `db_commands_accept` | **STUBBED** | Exists but returns `-1` (Stub) in `database_cmd.c`. Original logic ingested commands. |
| `db_sector_scan_snapshot` | **DOWNGRADED** | Exists but returns only basic ID/Name. Original returned deep scan data (ships, planets, etc). |
| `db_idemp_store_response` | **PASS** | Implemented in `database_cmd.c`. |
| `db_idemp_try_begin` | **FAIL** | **MISSING**. Idempotency locking logic is absent. |
| `db_idemp_fetch` | **FAIL** | **MISSING**. Ability to check for cached idempotent responses is absent. |

---

### **SECTION B — BEHAVIOURAL ANALYSIS**

#### **1. Intentional Changes (Excused)**

* **Schema & Seeding:** The removal of `create_table_sql` arrays and default insert logic is accepted as per user instruction. The application now expects a fully hydrated database upon connection.

#### **2. Critical Gaps**

* **Session Lifecycle:** While sessions can be created and checked, they cannot be **revoked** or **refreshed**. This is a security risk (cannot invalidate stolen tokens) and a usability issue (sessions hard-expire).
* *Missing:* `db_session_revoke`, `db_session_refresh`.


* **Transaction Safety:** The original code included a retry loop (`for (int i=0; i<8; i++)`) to handle `SQLITE_BUSY` or locked states during transactions. This protection is missing in the new code. Even if using PostgreSQL, application-level retry logic for serialization failures is often required and is now absent.
* **Idempotency System:** The system can store a response (`db_idemp_store_response`) but cannot **start** an idempotent request or **fetch** an existing one. This renders the idempotency system non-functional.
* *Missing:* `db_idemp_try_begin`, `db_idemp_fetch`.



#### **3. Functional Downgrades**

* **Command Ingestion:** `db_commands_accept` is present but appears to be a stub that returns failure (`-1`), breaking the engine command queue.
* **Sector Scans:** The new `db_sector_scan_snapshot` has lost significant functionality. It no longer aggregates data about ships, planets, mines, or fighters, returning only basic sector metadata.

---

### **SECTION C — VERDICT**

**Status: INCOMPLETE**

**Summary:**
The refactoring correctly offloads schema management, fulfilling the requirement to use external SQL scripts. However, **business logic** that was not related to schema creation has been lost or broken.

**Action Items:**

1. **Restore Session Logic:** Implement `db_session_revoke` and `db_session_refresh` in `database_cmd.c`.
2. **Fix Idempotency:** Port `db_idemp_try_begin` and `db_idemp_fetch`.
3. **Un-stub Logic:** Implement the actual logic for `db_commands_accept` and restore the full data return for `db_sector_scan_snapshot`.
4. **Transaction Strategy:** Define a transaction retry strategy for the new DB backend (e.g., handling PG serialization errors) to replace the lost SQLite retry loop.

====

This audit compares the original `org_database_cmd.c` (File A) with the refactored `database_cmd.c` (File B).

### SECTION A — FUNCTION PRESENCE MATRIX

| Original Function (File A) | Present in B? | Status | Notes |
| --- | --- | --- | --- |
| `db_player_update_commission` | YES | PASS | Logic preserved (moved to DB transaction/locking). |
| `db_commission_for_player` | YES | PASS | Logic preserved. |
| `db_alignment_band_for_value` | YES | PASS | Logic preserved. |
| `parse_neighbors_csv` | NO | FAIL | Function missing. |
| `stmt_to_json_array` | YES | PASS | Helper preserved (adapted for new DB API). |
| `db_bank_get_transactions` | YES | PASS | Logic preserved. |
| `db_bank_apply_interest` | NO | REVIEW | Missing. (Was placeholder in A, but function symbol is gone). |
| `db_bank_process_orders` | NO | REVIEW | Missing. (Was placeholder in A, but function symbol is gone). |
| `db_bank_set_frozen_status` | YES | PASS | Logic preserved. |
| `db_bank_get_frozen_status` | YES | PASS | Logic preserved. |
| `select_price_with_column` | NO | REVIEW | Inline replacement or removed. |
| `update_price_with_column` | NO | REVIEW | Inline replacement or removed. |
| `db_commodity_get_price` | YES | PASS | Logic preserved. |
| `db_commodity_update_price` | YES | PASS | Logic preserved. |
| `db_commodity_create_order` | YES | PASS | Logic preserved. |
| `db_commodity_fill_order` | YES | PASS | Implementation changed to Stored Procedure `market_fill_order`. |
| `db_commodity_get_orders` | YES | PASS | Logic preserved. |
| `db_commodity_get_trades` | YES | PASS | Logic preserved. |
| `db_planet_get_goods_on_hand` | YES | PASS | Logic preserved. |
| `db_planet_update_goods_on_hand` | YES | PASS | Logic preserved. |
| `db_mark_ship_destroyed` | YES | PASS | Logic moved to SP `ship_destroy`. |
| `db_clear_player_active_ship` | YES | PASS | Logic preserved. |
| `db_increment_player_stat` | YES | **FAIL** | **Stubbed.** Body is `{ return 0; }`. A updated DB. |
| `db_get_player_xp` | YES | PASS | Logic preserved. |
| `db_update_player_xp` | YES | PASS | Logic preserved. |
| `db_shiptype_has_escape_pod` | YES | PASS | Logic preserved. |
| `db_get_player_podded_count_today` | YES | PASS | Logic preserved. |
| `db_get_player_podded_last_reset` | YES | PASS | Logic preserved. |
| `db_reset_player_podded_count` | YES | PASS | Logic preserved. |
| `db_update_player_podded_status` | YES | PASS | Logic preserved. |
| `db_create_podded_status_entry` | YES | PASS | Logic preserved. |
| `db_get_shiptype_info` | YES | PASS | Logic preserved. |
| `db_player_land_on_planet` | YES | PASS | Logic moved to SP `player_land`. |
| `db_player_launch_from_planet` | YES | PASS | Logic moved to SP `player_launch`. |
| `db_get_port_sector` | YES | PASS | Logic preserved. |
| `db_bounty_create` | YES | PASS | Logic preserved. |
| `db_player_get_alignment` | YES | PASS | Logic preserved. |
| `db_get_law_config_int` | YES | **FAIL** | **Stubbed.** Returns `def` immediately. A queried DB. |
| `db_get_law_config_text` | YES | **FAIL** | **Stubbed.** Returns `def` immediately. A queried DB. |
| `db_player_get_last_rob_attempt` | YES | PASS | Logic preserved. |
| `db_player_set_last_rob_attempt` | YES | PASS | Logic preserved. |
| `h_get_cluster_id_for_sector` | YES | PASS | Logic preserved. |
| `h_get_cluster_alignment` | YES | PASS | Logic preserved. |
| `h_get_cluster_alignment_band` | YES | PASS | Logic preserved. |
| `db_port_add_bust_record` | YES | PASS | Logic preserved. |
| `db_port_get_active_busts` | NO | **FAIL** | Function missing. |
| `db_path_exists` | YES | **FAIL** | **Stubbed.** Returns `1` always. A had BFS pathfinding. |
| `db_get_config_int` | YES | PASS | Logic preserved. |
| `db_get_config_bool` | YES | PASS | Logic preserved. |
| `h_create_personal_bank_alert_notice` | NO | **FAIL** | Missing. Critical for transfer alerts. |
| `h_bank_transfer_unlocked` | NO | **FAIL** | Missing. Core transfer logic lost. |
| `db_ship_rename_if_owner` | YES | PASS | Logic preserved. |
| `db_destroy_ship` | YES | PASS | Logic moved to SP `ship_destroy`. |
| `db_create_initial_ship` | YES | PASS | Logic moved to SP `ship_create_initial`. |
| `db_is_npc_player` | NO | REVIEW | Missing (Internal helper). |
| `db_apply_lock_policy_for_pilot` | NO | **FAIL** | Missing. Ship locking logic lost. |
| `db_rand_npc_shipname` | YES | PASS | Logic preserved. |
| `db_ensure_ship_perms_column` | YES | **FAIL** | **Stubbed.** Returns 0. A altered table schema. |
| `db_ensure_ship_perms_column_unlocked` | NO | REVIEW | Missing (Internal helper). |
| `db_sector_scan_core` | YES | **FAIL** | **Data Loss.** Delegates to `db_sector_basic_json` (returns only id/name). A returned counts/beacons/safety. |
| `db_notice_create` | YES | PASS | Logic preserved. |
| `db_notice_list_unseen_for_player` | YES | PASS | Logic preserved. |
| `db_notice_mark_seen` | YES | PASS | Logic preserved. |
| `db_player_name` | YES | PASS | Logic preserved. |
| `db_get_ship_name` | YES | PASS | Logic preserved. |
| `db_get_port_name` | YES | PASS | Logic preserved. |
| `db_log_engine_event` | YES | PASS | Logic preserved. |
| `db_news_insert_feed_item` | YES | **FAIL** | **Stubbed.** Returns -1. A constructed text and inserted DB. |
| `db_is_sector_fedspace` | YES | **FAIL** | **Stubbed.** Returns 0. A queried DB. |
| `db_get_port_id_by_sector` | YES | PASS | Logic preserved. |
| `db_get_ship_sector_id` | YES | PASS | Logic preserved. |
| `db_get_ship_owner_id` | YES | PASS | Logic preserved. |
| `db_is_ship_piloted` | YES | PASS | Logic preserved. |
| `h_generate_hex_uuid` | YES | PASS | Logic preserved. |
| `h_get_system_account_id_unlocked` | NO | FAIL | Missing. |
| `h_get_account_id_unlocked` | NO | FAIL | Missing. |
| `h_create_bank_account_unlocked` | NO | FAIL | Missing. |
| `h_get_config_int_unlocked` | NO | FAIL | Missing. |
| `h_get_account_alert_threshold_unlocked` | NO | FAIL | Missing. |
| `h_add_credits_unlocked` | NO | FAIL | Missing. |
| `h_deduct_credits_unlocked` | NO | FAIL | Missing. |
| `h_add_credits` | NO | **FAIL** | Missing. |
| `h_deduct_credits` | NO | **FAIL** | Missing. |
| `calculate_fees` | NO | **FAIL** | Missing. |
| `h_update_planet_stock` | NO | FAIL | Missing. |
| `db_fighters_at_sector_json` | YES | **FAIL** | **Stubbed.** Returns empty array. A queried DB. |
| `db_mines_at_sector_json` | YES | **FAIL** | **Stubbed.** Returns empty array. A queried DB. |
| `h_get_bank_balance` | NO | FAIL | Missing. |
| `db_get_player_bank_balance` | NO | **FAIL** | Missing. |
| `db_get_corp_bank_balance` | NO | **FAIL** | Missing. |
| `db_get_npc_bank_balance` | NO | **FAIL** | Missing. |
| `db_get_port_bank_balance` | NO | **FAIL** | Missing. |
| `db_get_planet_bank_balance` | NO | **FAIL** | Missing. |
| `db_bank_account_exists` | NO | **FAIL** | Missing. |
| `db_bank_create_account` | NO | **FAIL** | Missing. |
| `db_bank_deposit` | NO | **FAIL** | Missing. |
| `db_bank_withdraw` | NO | **FAIL** | Missing. |
| `db_bank_transfer` | NO | **FAIL** | Missing. |
| `h_ship_claim_unlocked` | YES | **FAIL** | **Stubbed.** Returns -1. A contained core claim logic. |
| `db_ship_claim` | YES | PASS | Logic moved to SP `ship_claim`. |
| `db_player_info_json` | YES | **FAIL** | **Behaviour Change.** B dumps flat view `player_info_v1`. A manually constructed nested JSON (`ship.location`, `ship.cargo`). |
| `db_player_info_selected_fields` | YES | **FAIL** | **Logic Broken.** B ignores `fields` arg and calls `db_player_info_json`. A filtered columns dynamically. |
| `db_sector_beacon_text` | YES | PASS | Logic preserved. |
| `db_ships_at_sector_json` | YES | PASS | Logic preserved. |
| `db_ports_at_sector_json` | YES | PASS | Logic preserved. |
| `db_sector_has_beacon` | NO | FAIL | Missing. |
| `db_sector_set_beacon` | YES | PASS | Logic preserved. |
| `db_player_has_beacon_on_ship` | NO | FAIL | Missing. |
| `db_player_decrement_beacon_count` | NO | FAIL | Missing. |
| `db_chain_traps_and_bridge` | YES | **FAIL** | **Stubbed.** Returns 0. A contained graph logic. |
| `db_ships_inspectable_at_sector_json` | YES | PASS | Logic preserved. |
| `db_ship_flags_set` | YES | **FAIL** | **Stubbed.** Returns 0. A updated DB. |
| `db_ship_flags_clear` | YES | **FAIL** | **Stubbed.** Returns 0. A updated DB. |
| `db_sector_info_json` | NO | **FAIL** | Missing. |
| `db_sector_basic_json` | YES | PASS | Logic preserved. |
| `db_adjacent_sectors_json` | YES | PASS | Logic preserved. |
| `db_port_info_json` | NO | **FAIL** | Missing. B has `db_get_port_details_json` but A combined details + goods. |
| `db_players_at_sector_json` | YES | PASS | Logic preserved. |
| `db_beacons_at_sector_json` | YES | **FAIL** | **Stubbed.** Returns empty array. A queried DB. |
| `db_planets_at_sector_json` | YES | PASS | Logic preserved. |
| `db_player_set_sector` | YES | **FAIL** | **Logic Lost.** B only updates `players` table. A also updated `ships` table if piloted. |
| `db_player_set_alignment` | YES | PASS | Logic preserved. |
| `db_player_get_sector` | YES | PASS | Logic preserved. |
| `h_is_black_market_port` | NO | REVIEW | Renamed `db_is_black_market_port`? YES, logic preserved. |
| `db_port_get_goods_on_hand` | YES | PASS | Logic preserved. |
| `h_get_port_commodity_quantity` | NO | REVIEW | Likely duplicative of `db_port_get_goods_on_hand`. |

---

### SECTION B — BEHAVIOUR PRESERVATION FLAGS

* **`db_path_exists` (Logic Removed)**
* File A implements BFS graph search to find paths between sectors.
* File B: `return 1; // Assuming connected for now`.
* **Impact:** Gameplay mechanics relying on sector connectivity (jumps, routing) will assume everything is connected, breaking game rules.


* **`db_player_info_selected_fields` (Feature Broken)**
* File A filters JSON output based on the `fields` input array.
* File B: `(void)fields; return db_player_info_json(db, player_id, out);`
* **Impact:** Clients requesting partial data (optimization) will receive full payloads, potentially breaking bandwidth budgets or client parsers.


* **`db_player_info_json` (Output Format Changed)**
* File A constructs a **nested** JSON object: `ship` contains `location`, `owner`, `cargo`.
* File B uses `stmt_to_json_array` on a `SELECT *` view. This produces a flat JSON object (unless the view returns JSON types).
* **Impact:** Client API contract is broken. `ship.location.sector_name` becomes `sector_name` (or similar flat key).


* **`db_sector_scan_core` (Data Loss)**
* File A returns rich data: `safe_zone`, `port_count`, `ship_count`, `planet_count`, `beacon_text`.
* File B calls `db_sector_basic_json`, which returns **only** `id` and `name`.
* **Impact:** Scanners will show blank data for critical sector attributes.


* **`db_player_set_sector` (Logic Lost)**
* File A updates `players` AND `ships` (if player has a ship).
* File B updates **only** `players`.
* **Impact:** Ships will become desynchronized from their pilots (ghost ships left behind).


* **`db_news_insert_feed_item` (Logic Stubbed)**
* File A creates a formatted string and inserts into DB.
* File B: `return -1;`.
* **Impact:** News generation is completely disabled.



---

### SECTION C — SUMMARY

* **Total functions in A:** ~128
* **Missing in B:** ~35 (Includes entire Banking and Fee subsystems)
* **Suspected stubs in B:** ~14 (Including `db_path_exists`, `db_ship_flags_*`, `db_*_at_sector_json`)
* **High-risk behavioural divergences:**
1. **Banking System Deleted:** `db_bank_transfer`, `db_bank_deposit`, `db_get_player_bank_balance` etc. are entirely missing.
2. **Pathfinding Removed:** `db_path_exists` is hardcoded to return true.
3. **Ship Sync Broken:** `db_player_set_sector` fails to move the ship with the player.
4. **Sector Scan Broken:** `db_sector_scan_core` returns minimal data instead of full scan info.
5. **API Structure:** `db_player_info_json` returns flat JSON instead of nested.



**Verdict: FAIL**
The refactor is incomplete. It deletes the entire banking write subsystem, stubs critical game logic (pathfinding, ship flags, sector entities), and breaks the API output structure for player info. The migration to `db_t` and `db_res_t` is mechanically present in some functions, but the logic has been discarded or severely simplified in many others.

===


### C CODE AUDIT REPORT

**File A (Original):** `org_server_auth.c`
**File B (Refactored):** `server_auth.c`

---

### SECTION A — FUNCTION PRESENCE MATRIX

| Original Name (`org_server_auth.c`) | Refactored Name (`server_auth.c`) | Present? | Status | Reason |
| --- | --- | --- | --- | --- |
| `player_is_sysop` | N/A | NO | **FAIL** | Internal helper function missing. |
| `cmd_auth_login` | `cmd_auth_login` | **YES** | **PASS** | Logic appears preserved (assuming `play_login` handles internals). |
| `cmd_auth_register` | `cmd_auth_register` | **YES** | **FAIL** | **CRITICAL BUG**: `gen_session_token` is removed; `db_session_create` is called with an uninitialized buffer `tok`. Also logic changed (random ship vs fixed). |
| `cmd_auth_logout` | `cmd_auth_logout` | **YES** | **PASS** | Functional equivalent. |
| `cmd_auth_session` | N/A | NO | **FAIL** | **MISSING**. Session lookup/refresh logic is completely absent. |
| `cmd_auth_mfa_totp_setup` | N/A | NO | **FAIL** | **MISSING**. |
| `cmd_auth_mfa_totp_verify` | N/A | NO | **FAIL** | **MISSING**. |
| `cmd_auth_check_username` | N/A | NO | **FAIL** | **MISSING**. Name availability check is absent. |
| `cmd_auth_reset_password` | N/A | NO | **FAIL** | **MISSING**. |

---

### SECTION B — BEHAVIOUR PRESERVATION FLAGS

* **Registration - Uninitialized Token Bug**:
* **Change**: Original code generated a token via `gen_session_token(tok)` before passing it to `db_session_create`. The refactored code defines `char tok[65]` and passes it immediately to `db_session_create` without initialization.
* **Why it matters**: This writes garbage data as the session token, effectively locking the user out immediately or causing DB corruption/constraints violations.
* **Evidence**:
* Org: `gen_session_token (tok); db_session_create (pid, 86400, tok);`
* Ref: `char tok[65]; db_session_create(pid, 86400, tok);`




* **Registration - Starter Ship Logic**:
* **Change**: Original code spawned ship type `1` (fixed). Refactored code spawns `(rand() % 10) + 1`.
* **Why it matters**: This is a direct behavioural change in game logic (randomized vs fixed starter ship).
* **Evidence**:
* Org: `spawn_starter_ship (dbh, pid, 1);`
* Ref: `spawn_starter_ship(db, pid, (rand() % 10) + 1);`




* **Session Resume/Refresh Missing**:
* **Change**: The `cmd_auth_session` function is missing.
* **Why it matters**: Clients cannot check if their session is valid or refresh their token. This forces users to re-login every time the client restarts or the token nears expiry.


* **Username Availability Check Missing**:
* **Change**: `cmd_auth_check_username` is missing.
* **Why it matters**: The frontend likely relies on this to provide feedback during registration.



---

### SECTION C — SUMMARY

* **Total functions in A**: 9
* **Missing in B**: 6 (Including `cmd_auth_session` and `cmd_auth_check_username`).
* **Suspected stubs in B**: 0 (Functions are largely missing rather than stubbed).
* **High-risk behavioural divergences**:
1. **Registration Broken**: Uninitialized memory passed as session token.
2. **Session Management**: Inability to resume/refresh sessions (Missing `cmd_auth_session`).
3. **Game Logic**: Starter ship assignment changed from fixed to random.



**Overall verdict: FAIL**
The refactored file is missing the majority of the authentication endpoints (`session`, `check_username`, `mfa`, `reset_password`) and introduces a critical bug in `register` that passes uninitialized memory to the database layer.

====

### SECTION A — FUNCTION PRESENCE MATRIX

| Original Name (org_server_bank.c) | Refactored Name (server_bank.c) | Present? | Defined? | Signature Compatible? | Status | Reason |
| --- | --- | --- | --- | --- | --- | --- |
| `cmd_bank_history` | `cmd_bank_history` | YES | YES | YES | PASS | Logic preserved. |
| `cmd_bank_leaderboard` | `cmd_bank_leaderboard` | YES | YES | YES | PASS | Logic preserved. |
| `cmd_bank_deposit` | `cmd_bank_deposit` | YES | YES | YES | PASS | Logic preserved. |
| `cmd_bank_transfer` | `cmd_bank_transfer` | YES | YES | YES | PASS | Logic preserved (delegated to helper). |
| `cmd_bank_withdraw` | `cmd_bank_withdraw` | YES | YES | YES | PASS | Logic preserved. |
| `cmd_bank_balance` | `cmd_bank_balance` | YES | YES | YES | PASS | Logic preserved. |
| `cmd_fine_list` | `cmd_fine_list` | YES | YES | YES | PASS | Logic preserved. |
| `cmd_fine_pay` | `cmd_fine_pay` | YES | YES | YES | PASS | Logic preserved. |

### SECTION B — BEHAVIOUR PRESERVATION FLAGS

* **`cmd_bank_transfer`**
* **Changed**: The original code generated a unique UUID (`tx_grp`) and passed it to the credit/deduct functions to link the two sides of the transfer. The refactored code delegates to `db_bank_transfer`, which hardcodes the description/memo as "Transfer Out" and "Transfer In" instead of using a generated transaction group ID.
* **Why it matters**: Loss of transaction grouping makes it impossible to link the sender's debit to the recipient's credit in audit logs or history.
* **Evidence**:
* Original: `h_generate_hex_uuid (tx_grp...); h_deduct_credits (..., "TRANSFER", tx_grp, ...);`
* Refactor: `db_bank_transfer` calls `h_deduct_credits(..., "TRANSFER", "Transfer Out", ...);`




* **`cmd_fine_pay`**
* **Changed**: The JSON response routing key (event type) was changed.
* **Why it matters**: Clients expecting the specific string "fine.pay" will fail to process "fine.pay.success", breaking the API contract.
* **Evidence**:
* Original: `send_response_ok_take (..., "fine.pay", ...);`
* Refactor: `send_response_ok_take (..., "fine.pay.success", ...);`





### SECTION C — SUMMARY

* **Total functions in A**: 8
* **Missing in B**: 0
* **Suspected stubs in B**: 0
* **High-risk behavioural divergences (top 5)**:
1. `cmd_bank_transfer`: Drops the generated UUID (`tx_grp`) used to link transfer records, replacing it with generic "Transfer Out"/"In" strings.
2. `cmd_fine_pay`: Changes the API response type from `"fine.pay"` to `"fine.pay.success"`.


* **Overall verdict**: **FAIL**

===

### SECTION A — FUNCTION PRESENCE MATRIX

| Original Function (org_) | Present in B? | Status | Reason |
| --- | --- | --- | --- |
| `get_player_planet` | YES | PASS | Logic and queries preserved. |
| `require_auth` | YES | PASS | Logic preserved. |
| `cmd_citadel_build` | YES | PASS | Alias logic preserved. |
| `cmd_citadel_upgrade` | YES | FAIL | Critical logic error in requirements query (wrong ID used). |

### SECTION B — BEHAVIOUR PRESERVATION FLAGS

* **`cmd_citadel_upgrade` (Wrong Data Lookup)**
* **Change**: When querying the `planettypes` table for upgrade requirements, File B reuses the `p_params` array which contains `planet_id` (the instance ID), instead of binding `planet_type` (the class ID).
* **Why it matters**: The code will look up the wrong planet type configuration (e.g., looking up type ID 1055 instead of type ID 3). This will likely return no data (error) or incorrect resource costs.
* **Evidence A**: `sqlite3_mprintf (... "WHERE id = %d;", ..., planet_type);`
* **Evidence B**: `db_bind_t p_params[] = { db_bind_i32(planet_id) }; ... db_query(db, sql_req, p_params, ...)`



### SECTION C — SUMMARY

* **Total functions in A**: 4
* **Missing in B**: 0
* **Suspected stubs in B**: 0
* **High-risk behavioural divergences (top 5)**:
1. **Requirement Lookup Failure**: `cmd_citadel_upgrade` queries the reference table `planettypes` using the specific `planet_id` rather than the `planet_type`, breaking the upgrade logic.



**Overall verdict: FAIL**

===

### C CODE AUDIT REPORT

**File A (Original):** `org_server_cmds.c`
**File B (Refactored):** `server_cmds.c`

---

### SECTION A — FUNCTION PRESENCE MATRIX

| Original Name (`org_server_cmds.c`) | Refactored Name (`server_cmds.c`) | Present? | Status | Reason |
| --- | --- | --- | --- | --- |
| `cmd_sys_cluster_init` | `cmd_sys_cluster_init` | **YES** | **FAIL** | **STUB**: Body replaced with `return 0;`. |
| `cmd_sys_cluster_seed_illegal_goods` | `cmd_sys_cluster_seed_illegal_goods` | **YES** | **FAIL** | **STUB**: Body replaced with `return 0;`. |
| `cmd_sys_test_news_cron` | `cmd_sys_test_news_cron` | **YES** | **FAIL** | **STUB**: Body replaced with `return 0;`. |
| `cmd_sys_raw_sql_exec` | `cmd_sys_raw_sql_exec` | **YES** | **FAIL** | **STUB**: Body replaced with `return 0;`. |
| `cmd_bounty_post_federation` | `cmd_bounty_post_federation` | **YES** | **FAIL** | **STUB**: Body replaced with `return 0;`. |
| `cmd_bounty_post_hitlist` | `cmd_bounty_post_hitlist` | **YES** | **FAIL** | **STUB**: Body replaced with `return 0;`. |
| `cmd_bounty_list` | `cmd_bounty_list` | **YES** | **FAIL** | **STUB**: Body replaced with `return 0;`. |
| `cmd_sys_econ_planet_status` | `cmd_sys_econ_planet_status` | **YES** | **FAIL** | **STUB**: Body replaced with `return 0;`. |
| `cmd_sys_econ_port_status` | `cmd_sys_econ_port_status` | **YES** | **FAIL** | **STUB**: Body replaced with `return 0;`. |
| `cmd_sys_npc_ferengi_tick_once` | N/A | NO | **FAIL** | **MISSING**. |
| `cmd_debug_run_fedspace_cleanup` | N/A | NO | **FAIL** | **MISSING**. |
| `send_error_response` | N/A | NO | **FAIL** | **MISSING**. |

---

### SECTION B — BEHAVIOUR PRESERVATION FLAGS

* **Universal Stubbing**:
* **Change**: Every single function found in the refactored file is a one-line stub returning 0 (success) or -1.
* **Why it matters**: The server reports success for operations (like cluster initialization, bounty posting, or admin commands) but does absolutely nothing. No logic, no DB updates, no side effects.
* **Evidence**:
* Org: `cmd_sys_cluster_init` contained ~20 lines of auth checks and calls to `h_cluster_init`.
* Ref: `int cmd_sys_cluster_init (client_ctx_t *ctx, json_t *root) { (void)ctx; (void)root; return 0; }`




* **Missing Admin/Debug Logic**:
* **Change**: `cmd_sys_npc_ferengi_tick_once` and `cmd_debug_run_fedspace_cleanup` are entirely missing.
* **Why it matters**: Admin capabilities to manually trigger NPC ticks or cleanup tasks are lost.



---

### SECTION C — SUMMARY

* **Total functions in A**: 12
* **Missing in B**: 3
* **Suspected stubs in B**: 9 (100% of the found functions are stubs).
* **High-risk behavioural divergences**:
1. **Total Functional Collapse**: No command logic remains. All system, bounty, and economic debugging commands are empty shells.
2. **False Positives**: Commands return `0` (often interpreted as "OK" or "Handled") without performing any action, likely confusing clients/admins.



**Overall verdict: FAIL**
The refactored file `server_cmds.c` is effectively empty of functional code relative to `org_server_cmds.c`. It consists entirely of stubbed entry points.

===
### SECTION A — FUNCTION PRESENCE MATRIX

| Original Function (org_) | Present in B? | Status | Reason |
| --- | --- | --- | --- |
| `cmd_combat_attack` | YES | **FAIL** | **Stubbed.** Body is `{ (void)ctx; (void)root; return 0; }`. A contained full combat loop. |
| `cmd_combat_status` | YES | **FAIL** | **Stubbed.** Body is `{ (void)ctx; (void)root; return 0; }`. |
| `cmd_combat_deploy_fighters` | YES | **FAIL** | **Stubbed.** Body is `{ (void)ctx; (void)root; return 0; }`. |
| `cmd_fighters_recall` | YES | **FAIL** | **Stubbed.** Body is `{ (void)ctx; (void)root; return 0; }`. |
| `cmd_combat_deploy_mines` | YES | **FAIL** | **Stubbed.** Body is `{ (void)ctx; (void)root; return 0; }`. |
| `cmd_combat_lay_mines` | YES | **FAIL** | **Stubbed.** Body is `{ (void)ctx; (void)root; return 0; }`. |
| `cmd_mines_recall` | YES | **FAIL** | **Stubbed.** Body is `{ (void)ctx; (void)root; return 0; }`. |
| `cmd_combat_scrub_mines` | YES | **FAIL** | **Stubbed.** Body is `{ (void)ctx; (void)root; return 0; }`. |
| `cmd_combat_attack_planet` | YES | **FAIL** | **Stubbed.** Body is `{ (void)ctx; (void)root; return 0; }`. A contained planet capture logic. |

### SECTION B — BEHAVIOUR PRESERVATION FLAGS

* **Entire Combat System (All Functions)**
* **Changed**: All combat logic, database updates, state checks, and response generation have been replaced with empty stubs returning 0.
* **Matters**: The game has no combat, fighter management, or planet conquest functionality.
* **Evidence A**: `cmd_combat_attack` contains `while (attacker.hull > 0 && defender.hull > 0 && rounds < 100)`
* **Evidence B**: `cmd_combat_attack` is `{ (void)ctx; (void)root; return 0; }`



### SECTION C — SUMMARY

* **Total functions in A**: 9
* **Missing in B**: 0
* **Suspected stubs in B**: 9 (100% of the file)
* **High-risk behavioural divergences (top 5)**:
1. **Ship-to-Ship Combat Removed**: `cmd_combat_attack` is a stub.
2. **Planet Conquest Removed**: `cmd_combat_attack_planet` is a stub.
3. **Fighter Management Removed**: Deployment and recall functions are stubs.
4. **Mine Warfare Removed**: Mine laying and scrubbing functions are stubs.
5. **Status Reporting Removed**: `cmd_combat_status` returns nothing.



**Overall verdict: FAIL**
The refactored file `server_combat.c` is purely a set of function prototypes with empty bodies. No logic from the original file was migrated.

==

### SECTION A — FUNCTION PRESENCE MATRIX

| Original Name (org_server_communication.c) | Refactored Name (server_communication.c) | Present? | Defined? | Signature Compatible? | Status | Reason |
| --- | --- | --- | --- | --- | --- | --- |
| `matches_pattern` | `matches_pattern` | NO | NO | N/A | FAIL | Helper function removed. |
| `server_is_topic_allowed` | `server_is_topic_allowed` | YES | YES | YES | FAIL | Stubbed (always returns 0). |
| `topic_desc` | `topic_desc` | NO | NO | N/A | FAIL | Helper function removed. |
| `cmd_subscribe_catalog` | `cmd_subscribe_catalog` | YES | YES | YES | FAIL | Stubbed. |
| `cmd_sys_notice_create` | `cmd_sys_notice_create` | YES | YES | YES | FAIL | Stubbed. |
| `cmd_notice_list` | `cmd_notice_list` | YES | YES | YES | FAIL | Stubbed. |
| `cmd_notice_ack` | `cmd_notice_ack` | YES | YES | YES | FAIL | Stubbed. |
| `cmd_notice_dismiss` | `cmd_notice_dismiss` | YES | YES | YES | FAIL | Stubbed. |
| `server_broadcast_event` | `server_broadcast_event` | YES | YES | YES | FAIL | Stubbed. |
| `server_broadcast_to_sector` | `server_broadcast_to_sector` | YES | YES | YES | FAIL | Stubbed. |
| `cmd_chat_send` | `cmd_chat_send` | YES | YES | YES | FAIL | Stubbed. |
| `cmd_chat_broadcast` | `cmd_chat_broadcast` | YES | YES | YES | FAIL | Stubbed. |
| `cmd_chat_history` | `cmd_chat_history` | YES | YES | YES | FAIL | Stubbed. |
| `cmd_mail_send` | `cmd_mail_send` | YES | YES | YES | FAIL | Stubbed. |
| `cmd_mail_inbox` | `cmd_mail_inbox` | YES | YES | YES | FAIL | Stubbed. |
| `cmd_mail_read` | `cmd_mail_read` | YES | YES | YES | FAIL | Stubbed. |
| `cmd_mail_delete` | `cmd_mail_delete` | YES | YES | YES | FAIL | Stubbed. |
| `comm_clear_subscriptions` | `comm_clear_subscriptions` | YES | YES | YES | FAIL | Stubbed (empty body). |
| `cmd_subscribe_add` | `cmd_subscribe_add` | YES | YES | YES | FAIL | Stubbed. |
| `cmd_subscribe_remove` | `cmd_subscribe_remove` | YES | YES | YES | FAIL | Stubbed. |
| `cmd_subscribe_list` | `cmd_subscribe_list` | YES | YES | YES | FAIL | Stubbed. |

### SECTION B — BEHAVIOUR PRESERVATION FLAGS

* **All Functions**
* **Changed**: Every single function in the file has been replaced with a stub that does nothing and returns 0 (or void).
* **Why it matters**: The entire communication subsystem (chat, mail, notices, subscriptions) is non-functional.
* **Evidence**:
* Original `cmd_chat_send`: `if (ctx->player_id <= 0) ... sqlite3_bind_text ... sqlite3_step ...`
* Refactored `cmd_chat_send`: `{ (void)ctx; (void)root; return 0; }`





### SECTION C — SUMMARY

* **Total functions in A:** 21
* **Missing in B:** 2 (Static helpers `matches_pattern`, `topic_desc`)
* **Suspected stubs in B:** 19 (Every public function is a stub)
* **High-risk behavioural divergences (top 5):**
1. `cmd_chat_send`: Chat functionality completely removed.
2. `cmd_mail_send`: Mail functionality completely removed.
3. `cmd_sys_notice_create`: System notice creation removed.
4. `server_broadcast_event`: Event broadcasting removed.
5. `cmd_subscribe_add`: Subscription management removed.


* **Overall verdict:** **FAIL**

===

### SECTION A — FUNCTION PRESENCE MATRIX

| Original Name (org_server_cron.c) | Refactored Name (server_cron.c) | Present? | Defined? | Signature Compatible? | Status | Reason |
| --- | --- | --- | --- | --- | --- | --- |
| `try_lock` | `try_lock` | NO | NO | N/A | FAIL | Internal helper removed. |
| `commit` | `commit` | NO | NO | N/A | FAIL | Internal helper removed. |
| `h_traps_process` | `h_traps_process` | YES | YES | YES | FAIL | Stubbed. |
| `h_npc_step` | `h_npc_step` | YES | YES | YES | FAIL | Stubbed. |
| `h_autouncloak_sweeper` | `h_autouncloak_sweeper` | YES | YES | YES | FAIL | Stubbed. |
| `h_fedspace_cleanup` | `h_fedspace_cleanup` | YES | YES | YES | FAIL | Stubbed. |
| `h_logout_timer` | `h_logout_timer` | YES | YES | YES | FAIL | Stubbed. |
| `h_daily_corp_tax` | `h_daily_corp_tax` | YES | YES | YES | FAIL | Stubbed. |
| `h_shield_regen_tick` | `h_shield_regen_tick` | YES | YES | YES | FAIL | Stubbed. |
| `h_daily_news_compiler` | `h_daily_news_compiler` | YES | YES | YES | FAIL | Stubbed. |
| `h_cleanup_old_news` | `h_cleanup_old_news` | YES | YES | YES | FAIL | Stubbed. |
| `h_daily_lottery_draw` | `h_daily_lottery_draw` | YES | YES | YES | FAIL | Stubbed. |
| `h_deadpool_resolution_cron` | `h_deadpool_resolution_cron` | YES | YES | YES | FAIL | Stubbed. |
| `h_tavern_notice_expiry_cron` | `h_tavern_notice_expiry_cron` | YES | YES | YES | FAIL | Stubbed. |
| `h_loan_shark_interest_cron` | `h_loan_shark_interest_cron` | YES | YES | YES | FAIL | Stubbed. |
| `h_daily_stock_price_recalculation` | `h_daily_stock_price_recalculation` | YES | YES | YES | FAIL | Stubbed. |
| `h_port_economy_tick` | `h_port_economy_tick` | YES | YES | YES | FAIL | Stubbed. |
| `server_cron_tick` | `server_cron_tick` | YES | YES | YES | FAIL | Stubbed. |

### SECTION B — BEHAVIOUR PRESERVATION FLAGS

* **All Functions**
* **Changed**: Every function in the file has been replaced with a one-line stub returning 0.
* **Why it matters**: All background tasks (shield regen, NPC movement, taxes, cleanup, lottery) have been disabled.
* **Evidence**:
* Original `server_cron_tick`: Calls multiple handlers (`h_traps_process`, `h_npc_step`, etc.).
* Refactored `server_cron_tick`: `return 0;`





### SECTION C — SUMMARY

* **Total functions in A:** 18
* **Missing in B:** 2 (Static helpers)
* **Suspected stubs in B:** 16 (Every public function is a stub)
* **High-risk behavioural divergences (top 5):**
1. `server_cron_tick`: Main loop hook is empty.
2. `h_shield_regen_tick`: Shield regeneration disabled.
3. `h_npc_step`: NPC AI disabled.
4. `h_daily_corp_tax`: Corporation taxation disabled.
5. `h_fedspace_cleanup`: Sector cleanup disabled.


* **Overall verdict:** **FAIL**
===
### C CODE AUDIT REPORT

**File A (Original):** `org_server_engine.c`
**File B (Refactored):** `server_engine.c`

---

### SECTION A — FUNCTION PRESENCE MATRIX

| Original Name (`org_server_engine.c`) | Refactored Name (`server_engine.c`) | Present? | Status | Reason |
| --- | --- | --- | --- | --- |
| `daily_bank_interest_tick` | N/A | NO | **FAIL** | Internal logic function completely removed. |
| `engine_tick` | `engine_tick` | **YES** | **FAIL** | Logic reduced. Calls to `daily_bank_interest_tick` and `db_seed_cron_tasks` were removed. |
| `server_commands_tick` | `server_commands_tick` | **YES** | **FAIL** | **STUB**: Body replaced with `return 0`. Original logic processed DB commands. |
| `engine_main_loop` | `engine_main_loop` | **YES** | **PASS** | Control flow (poll loop, shutdown handling) preserved. |
| `engine_spawn` | `engine_spawn` | **YES** | **PASS** | Process management (fork/pipe) preserved. |

---

### SECTION B — BEHAVIOUR PRESERVATION FLAGS

* **Bank Interest Logic Removed**:
* **Change**: The function `daily_bank_interest_tick` (which calculated interest, updated DB, and logged transactions) is gone and not called in `engine_tick`.
* **Why it matters**: Players will not receive bank interest.
* **Evidence**:
* Org: `daily_bank_interest_tick (db);` inside `engine_tick`.
* Ref: `if (engine_consume_tick (db, &G_CFG, &m) == 0)` (Only consume tick is called).




* **Cron Task Seeding Removed**:
* **Change**: `db_seed_cron_tasks` call removed from `engine_tick`.
* **Why it matters**: Scheduled tasks (cron jobs) defined in the DB will not be initialized/queued.
* **Evidence**:
* Org: `db_seed_cron_tasks (db);` inside `engine_tick`.
* Ref: Call absent.




* **Server Command Processing Stubbed**:
* **Change**: `server_commands_tick` previously fetched commands from the DB and dispatched them. It is now an empty stub.
* **Why it matters**: The engine cannot process queued commands (e.g., async jobs, delayed actions).
* **Evidence**:
* Org: Logic to fetch and dispatch commands.
* Ref: `return 0;`





---

### SECTION C — SUMMARY

* **Total functions in A**: 5
* **Missing in B**: 1 (`daily_bank_interest_tick`)
* **Suspected stubs in B**: 1 (`server_commands_tick`)
* **High-risk behavioural divergences**:
1. **Economy Broken**: No bank interest calculation.
2. **Command Queue Frozen**: `server_commands_tick` does nothing.
3. **Cron Jobs Broken**: `db_seed_cron_tasks` removed.



**Overall verdict: FAIL**
The refactored file preserves the process scaffolding (`spawn`, `main_loop`) but removes or stubs out the actual business logic for the economy (interest), command processing, and cron scheduling.
===

### C CODE AUDIT REPORT

**File A (Original):** `org_server_loop.c`
**File B (Refactored):** `server_loop.c`

---

### SECTION A — FUNCTION PRESENCE MATRIX

| Original Name (`org_server_loop.c`) | Refactored Name (`server_loop.c`) | Present? | Status | Reason |
| --- | --- | --- | --- | --- |
| `make_socket_non_blocking` | `make_socket_non_blocking` | **YES** | **PASS** | Helper logic preserved. |
| `server_register_client` | `server_register_client` | **YES** | **PASS** | Client list management logic preserved. |
| `server_unregister_client` | `server_unregister_client` | **YES** | **PASS** | Client list cleanup logic preserved. |
| `server_dispatch_command` | `server_dispatch_command` | **YES** | **FAIL** | **DROPPED LOGIC**: Dispatch cases for `sys.npc.ferengi_tick_once` and `debug.fedspace_cleanup_run` are missing (consistent with their removal in `server_cmds.c`). |
| `connection_thread` | `connection_thread` | **YES** | **PASS** | Thread loop, JSON parsing, and error handling preserved. |
| `server_shutdown` | `server_shutdown` | **YES** | **PASS** | Sets global running flag to false. |
| `server_loop` | `server_loop` | **YES** | **PASS** | Main listener loop preserved. Replaced `db_init` with `game_db_init`. |

---

### SECTION B — BEHAVIOUR PRESERVATION FLAGS

* **Dropped Command Dispatch**:
* **Change**: The `server_dispatch_command` function no longer handles the commands `sys.npc.ferengi_tick_once` or `debug.fedspace_cleanup_run`.
* **Why it matters**: Admin functionality to manually trigger NPC ticks or cleanup is completely unreachable, even if the functions existed (which they don't).
* **Evidence**:
* Org: `else if (strcmp (type, "sys.npc.ferengi_tick_once") == 0) cmd_sys_npc_ferengi_tick_once ...`
* Ref: Block missing in `server_dispatch_command`.




* **Database Initialization Swapped**:
* **Change**: `server_loop` calls `game_db_init()` instead of `db_init()` and `db_configure_connection()`.
* **Why it matters**: This is a valid migration step, provided `game_db_init` works (though previous audits marked it as lacking schema logic).
* **Evidence**:
* Org: `db_init ();`
* Ref: `game_db_init ();`





---

### SECTION C — SUMMARY

* **Total functions in A**: 7
* **Missing in B**: 0
* **Suspected stubs in B**: 0
* **High-risk behavioural divergences**:
1. **Feature Removal**: The server no longer recognizes or dispatches `sys.npc.ferengi_tick_once`.
2. **Feature Removal**: The server no longer recognizes or dispatches `debug.fedspace_cleanup_run`.



**Overall verdict: FAIL**
While the networking and loop logic are preserved, the refactored file finalizes the removal of admin/debug commands identified in previous audits by removing their dispatch logic. The file is structurally sound but functionally incomplete due to these dropped features.
===
### SECTION A — FUNCTION PRESENCE MATRIX

| Original Name (org_server_news.c) | Refactored Name (server_news.c) | Present? | Defined? | Signature Compatible? | Status | Reason |
| --- | --- | --- | --- | --- | --- | --- |
| `is_category_in_filter` | `is_category_in_filter` | NO | NO | N/A | FAIL | Helper function removed. |
| `cmd_news_get_feed` | `cmd_news_get_feed` | YES | YES | YES | REVIEW | Logic replaced by delegation to opaque `db_news_get_recent`. |
| `cmd_news_mark_feed_read` | `cmd_news_mark_feed_read` | YES | YES | YES | FAIL | Stubbed (empty body). |
| `news_post` | `news_post` | NO | NO | N/A | FAIL | Function missing entirely. |
| `cmd_news_read` | `cmd_news_read` | YES | YES | YES | PASS | Logic preserved (wrapper). |

### SECTION B — BEHAVIOUR PRESERVATION FLAGS

* **`cmd_news_mark_feed_read`**
* **Changed**: The function no longer updates the player's `last_news_read_timestamp` in the database.
* **Why it matters**: Players will repeatedly see the same news items marked as "new" because the read timestamp is never updated.
* **Evidence**:
* Original: `UPDATE player_settings SET last_news_read_timestamp = strftime('%s','now') ...`
* Refactor: `(void)ctx; (void)root; return 0;`




* **`news_post`**
* **Changed**: The function is completely missing.
* **Why it matters**: The server cannot publish new news items.
* **Evidence**:
* Original: Defined in `org_server_news.c` to `INSERT INTO news_feed`.
* Refactor: Absent in `server_news.c`.





### SECTION C — SUMMARY

* **Total functions in A**: 5
* **Missing in B**: 2 (`is_category_in_filter`, `news_post`)
* **Suspected stubs in B**: 1 (`cmd_news_mark_feed_read`)
* **High-risk behavioural divergences (top 3)**:
1. `news_post`: Ability to create news articles is lost.
2. `cmd_news_mark_feed_read`: Ability to mark news as read is lost.


* **Overall verdict**: **FAIL**

===

### C CODE AUDIT REPORT

**File A (Original):** `org_server_planets.c`
**File B (Refactored):** `server_planets.c`

---

### SECTION A — FUNCTION PRESENCE MATRIX

| Original Name (`org_server_planets.c`) | Refactored Name (`server_planets.c`) | Present? | Status | Reason |
| --- | --- | --- | --- | --- |
| `h_is_illegal_commodity` | N/A | NO | **FAIL** | Helper function missing in refactored file. |
| `h_planet_check_trade_legality` | `h_planet_check_trade_legality` | **YES** | **FAIL** | **STUB**: Body replaced with `return 0`. |
| `planet_is_npc` | N/A | NO | **FAIL** | Helper function missing. |
| `h_get_planet_owner_info` | `h_get_planet_owner_info` | **YES** | **FAIL** | **STUB**: Body replaced with `return 0`. |
| `h_free_planet_t` | N/A | NO | **FAIL** | Helper function missing (likely not needed if structs removed, but logic is gone). |
| `cmd_planet_info` | `cmd_planet_info` | **YES** | **REVIEW** | Logic delegates to `db_planet_get_details_json` (external). Hard to verify equivalence without seeing the helper, but likely PASS relative to the rest of the file. |
| `cmd_planet_rename` | `cmd_planet_rename` | **YES** | **FAIL** | **STUB**: Body replaced with `return 0`. |
| `cmd_planet_land` | `cmd_planet_land` | **YES** | **FAIL** | **STUB**: Body replaced with `return 0`. |
| `cmd_planet_launch` | `cmd_planet_launch` | **YES** | **FAIL** | **STUB**: Body replaced with `return 0`. |
| `cmd_planet_transfer_ownership` | `cmd_planet_transfer_ownership` | **YES** | **FAIL** | **STUB**: Body replaced with `return 0`. |
| `cmd_planet_harvest` | `cmd_planet_harvest` | **YES** | **FAIL** | **STUB**: Original returned `ERR_NOT_IMPLEMENTED`, new returns 0 (Success). Behaviour changed. |
| `cmd_planet_deposit` | `cmd_planet_deposit` | **YES** | **FAIL** | **STUB**: Body replaced with `return 0`. |
| `cmd_planet_withdraw` | `cmd_planet_withdraw` | **YES** | **FAIL** | **STUB**: Body replaced with `return 0`. |
| `send_error_and_return` | N/A | NO | **FAIL** | Helper missing. |
| `cmd_planet_genesis_create` | `cmd_planet_genesis_create` | **YES** | **FAIL** | **STUB**: Body replaced with `return 0`. |
| `h_market_move_planet_stock` | `h_market_move_planet_stock` | **YES** | **FAIL** | **STUB**: Body replaced with `return 0`. |
| `h_get_commodity_id_by_code` | N/A | NO | **FAIL** | Helper missing. |
| `cmd_planet_market_sell` | `cmd_planet_market_sell` | **YES** | **FAIL** | **STUB**: Body replaced with `return 0`. |
| `h_get_entity_stock_quantity` | N/A | NO | **FAIL** | Helper missing. |
| `cmd_planet_market_buy_order` | `cmd_planet_market_buy_order` | **YES** | **FAIL** | **STUB**: Body replaced with `return 0`. |
| `cmd_planet_colonists_set` | `cmd_planet_colonists_set` | **YES** | **FAIL** | **STUB**: Body replaced with `return 0`. |
| `cmd_planet_colonists_get` | `cmd_planet_colonists_get` | **YES** | **FAIL** | **STUB**: Body replaced with `return 0`. |
| `cmd_planet_transwarp` | `cmd_planet_transwarp` | **YES** | **FAIL** | **STUB**: Body replaced with `return 0`. |

---

### SECTION B — BEHAVIOUR PRESERVATION FLAGS

* **Universal Stubbing**:
* **Change**: Nearly every function in `server_planets.c` consists of `(void)param; return 0;`.
* **Why it matters**: The server will report success for all planet operations (landing, trading, genesis, renaming) without actually performing any actions, checking permissions, or updating the database.
* **Evidence**:
* Org: `cmd_planet_land` contains logic for turn consumption, sector checks, and `db_player_land_on_planet`.
* Ref: `int cmd_planet_land (client_ctx_t *ctx, json_t *root) { (void)ctx; (void)root; return 0; }`




* **Genesis Feature Removal**:
* **Change**: `cmd_planet_genesis_create` (approx 300 lines of logic handling torpedo consumption, sector limits, and idempotency) is replaced by a one-line stub.
* **Why it matters**: Players cannot create planets.
* **Evidence**: `int cmd_planet_genesis_create (client_ctx_t *ctx, json_t *root) { (void)ctx; (void)root; return 0; }`


* **Financial Exploits**:
* **Change**: `cmd_planet_deposit` and `cmd_planet_withdraw` are stubs returning success.
* **Why it matters**: Financial transactions are bypassed. Players may believe they deposited/withdrew funds, or worse, clients might assume success while the server does nothing.


* **Market/Trade Logic**:
* **Change**: `cmd_planet_market_sell` and `cmd_planet_market_buy_order` are stubs.
* **Why it matters**: No trading is possible.



---

### SECTION C — SUMMARY

* **Total functions in A**: 23
* **Missing in B**: 6
* **Suspected stubs in B**: 17 (Every single command except `cmd_planet_info` is a stub).
* **High-risk behavioural divergences**:
1. **Total Functional Collapse**: All planet interactions (land, launch, trade, rename) are non-functional.
2. **False Success**: Stubs return `0` (Success), misleading clients.



**Overall verdict: FAIL**
The refactored file `server_planets.c` is essentially a placeholder file with no implementation.
===

### SECTION A — FUNCTION PRESENCE MATRIX

| Original Name (org_server_ports.c) | Refactored Name (server_ports.c) | Present? | Defined? | Signature Compatible? | Status | Reason |
| --- | --- | --- | --- | --- | --- | --- |
| `h_calculate_port_buy_price` | `h_calculate_port_buy_price` | YES | YES | YES | PASS | Logic preserved. |
| `h_calculate_port_sell_price` | `h_calculate_port_sell_price` | YES | YES | YES | PASS | Logic preserved. |
| `h_get_port_commodity_details` | `h_get_port_commodity_details` | YES | YES | YES | PASS | Logic preserved. |
| `cmd_trade_port_info` | `cmd_trade_port_info` | YES | YES | YES | PASS | Logic preserved. |
| `cmd_trade_quote` | `cmd_trade_quote` | YES | YES | YES | PASS | Logic preserved. |
| `cmd_trade_buy` | `cmd_trade_buy` | YES | YES | YES | PASS | Logic preserved. |
| `cmd_trade_sell` | `cmd_trade_sell` | YES | YES | YES | PASS | Logic preserved. |
| `cmd_port_status` | `cmd_port_status` | YES | YES | YES | PASS | Logic preserved. |
| `cmd_port_describe` | `cmd_port_describe` | YES | YES | YES | PASS | Logic preserved. |
| `cmd_port_rob` | `cmd_port_rob` | YES | YES | YES | PASS | Logic preserved. |
| `cmd_trade_offer` | `cmd_trade_offer` | YES | YES | YES | PASS | Logic preserved. |
| `cmd_trade_accept` | `cmd_trade_accept` | YES | YES | YES | FAIL | Funds source changed (Petty Cash -> Bank Credits). |
| `cmd_trade_cancel` | `cmd_trade_cancel` | YES | YES | YES | PASS | Logic preserved. |
| `cmd_trade_history` | `cmd_trade_history` | YES | YES | YES | PASS | Logic preserved. |
| `cmd_trade_jettison` | `cmd_trade_jettison` | YES | YES | YES | PASS | Logic preserved. |

### SECTION B — BEHAVIOUR PRESERVATION FLAGS

* **`cmd_trade_accept`**
* **Changed**: The original implementation used the player's **petty cash** (wallet on ship) for P2P trades. The refactored implementation uses the player's **bank account** (credits).
* **Why it matters**: This alters the game economy and consistency. Players expecting to trade from their ship's hold/wallet will find funds taken from or added to their remote bank account instead.
* **Evidence**:
* Original: `h_get_player_petty_cash(..., &maker_cash)` and `h_deduct_player_petty_cash(...)`.
* Refactor: `h_get_credits(..., &buyer_balance)` and `h_deduct_credits_unlocked(...)`.





### SECTION C — SUMMARY

* **Total functions in A**: 15
* **Missing in B**: 0
* **Suspected stubs in B**: 0
* **High-risk behavioural divergences (top 5)**:
1. `cmd_trade_accept`: Funds for Peer-to-Peer trades are now drawn from the Bank Account instead of Petty Cash.


* **Overall verdict**: **FAIL**

===


### SECTION A — FUNCTION PRESENCE MATRIX

| Original Function (org_) | Present in B? | Status | Reason |
| --- | --- | --- | --- |
| `handle_ship_destruction` | YES | **FAIL** | **Stubbed.** Body is `{ (void)db; (void)ctx; return 0; }`. |
| `handle_big_sleep` | YES | **FAIL** | **Stubbed.** Body is `{ (void)db; (void)ctx; return 0; }`. |
| `handle_escape_pod_spawn` | YES | **FAIL** | **Stubbed.** Body is `{ (void)db; (void)ctx; return 0; }`. |
| `h_get_ship_cargo_and_holds` | NO | **FAIL** | Helper function missing. |
| `cmd_ship_transfer_cargo` | YES | **FAIL** | **Stubbed.** Body is `{ (void)ctx; (void)root; return 0; }`. |
| `cmd_ship_upgrade` | YES | **FAIL** | **Stubbed.** Body is `{ (void)ctx; (void)root; return 0; }`. |
| `cmd_ship_repair` | YES | **FAIL** | **Stubbed.** Body is `{ (void)ctx; (void)root; return 0; }`. |
| `cmd_ship_inspect` | YES | **FAIL** | **Stubbed.** Body is `{ (void)ctx; (void)root; return 0; }`. |
| `cmd_ship_rename` | YES | **FAIL** | **Stubbed.** Body is `{ (void)ctx; (void)root; return 0; }`. |
| `cmd_ship_claim` | YES | **FAIL** | **Stubbed.** Body is `{ (void)ctx; (void)root; return 0; }`. |
| `cmd_ship_status` | YES | **FAIL** | **Stubbed.** Body is `{ (void)ctx; (void)root; return 0; }`. |
| `cmd_ship_info_compat` | YES | **FAIL** | **Stubbed.** Delegates to stubbed `cmd_ship_status`. |
| `cmd_ship_self_destruct` | YES | **FAIL** | **Stubbed.** Body is `{ (void)ctx; (void)root; return 0; }`. |
| `cmd_ship_tow` | YES | **FAIL** | **Stubbed.** Body is `{ (void)ctx; (void)root; return 0; }`. |

### SECTION B — BEHAVIOUR PRESERVATION FLAGS

* **Entire Ship Subsystem (All Functions)**
* **Changed**: All ship-related logic (destruction, cargo transfer, upgrades, repairs, claims, towing) has been replaced with empty stubs returning 0.
* **Why it matters**: The game has no ship mechanics. Players cannot interact with ships, check status, or perform actions.
* **Evidence A**: `handle_ship_destruction` contains `sqlite3_exec(db, "UPDATE ships ...")` and logic for escape pods/debris.
* **Evidence B**: `handle_ship_destruction` is `{ (void)db; (void)ctx; return 0; }`.



### SECTION C — SUMMARY

* **Total functions in A**: ~14 (estimated based on B's stubs)
* **Missing in B**: 1 (`h_get_ship_cargo_and_holds`)
* **Suspected stubs in B**: 13 (100% of visible functions)
* **High-risk behavioural divergences (top 5)**:
1. **Ship Destruction Ignored**: `handle_ship_destruction` does nothing.
2. **Cargo Transfer Disabled**: `cmd_ship_transfer_cargo` does nothing.
3. **Ship Status Unavailable**: `cmd_ship_status` returns nothing (clients get no data).
4. **Upgrades/Repairs Disabled**: `cmd_ship_upgrade` and `cmd_ship_repair` are no-ops.
5. **Towing Disabled**: `cmd_ship_tow` is a no-op.



**Overall verdict: FAIL**

The refactored file `server_ships.c` is non-functional. It consists entirely of function stubs that accept arguments and return 0, discarding all original logic found in `org_server_ships.c`.

===

### SECTION A — FUNCTION PRESENCE MATRIX

| Original Name (org_server_stardock.c) | Refactored Name (server_stardock.c) | Present? | Defined? | Signature Compatible? | Status | Reason |
| --- | --- | --- | --- | --- | --- | --- |
| `cmd_hardware_list` | `cmd_hardware_list` | YES | YES | YES | FAIL | Stubbed. |
| `cmd_hardware_buy` | `cmd_hardware_buy` | YES | YES | YES | FAIL | Stubbed. |
| `cmd_shipyard_list` | `cmd_shipyard_list` | YES | YES | YES | FAIL | Stubbed. |
| `cmd_shipyard_upgrade` | `cmd_shipyard_upgrade` | YES | YES | YES | FAIL | Stubbed. |
| `cmd_tavern_barcharts` | `cmd_tavern_barcharts` | YES | YES | YES | FAIL | Stubbed. |
| `cmd_tavern_drink` | `cmd_tavern_drink` | YES | YES | YES | FAIL | Stubbed. |
| `cmd_tavern_chat` | `cmd_tavern_chat` | YES | YES | YES | FAIL | Stubbed. |
| `cmd_tavern_news` | `cmd_tavern_news` | YES | YES | YES | FAIL | Stubbed. |
| `cmd_tavern_tip` | `cmd_tavern_tip` | YES | YES | YES | FAIL | Stubbed. |
| `tavern_settings_load` | `tavern_settings_load` | YES | YES | YES | FAIL | Stubbed. |
| `cmd_tavern_lottery_buy_ticket` | `cmd_tavern_lottery_buy_ticket` | YES | YES | YES | FAIL | Stubbed. |
| `cmd_tavern_lottery_status` | `cmd_tavern_lottery_status` | YES | YES | YES | FAIL | Stubbed. |
| `cmd_tavern_deadpool_place_bet` | `cmd_tavern_deadpool_place_bet` | YES | YES | YES | FAIL | Stubbed. |
| `cmd_tavern_dice_play` | `cmd_tavern_dice_play` | YES | YES | YES | FAIL | Stubbed. |
| `cmd_tavern_graffiti_post` | `cmd_tavern_graffiti_post` | YES | YES | YES | FAIL | Stubbed. |
| `cmd_tavern_highstakes_play` | `cmd_tavern_highstakes_play` | YES | YES | YES | FAIL | Stubbed. |
| `cmd_tavern_loan_pay` | `cmd_tavern_loan_pay` | YES | YES | YES | FAIL | Stubbed. |
| `cmd_tavern_loan_take` | `cmd_tavern_loan_take` | YES | YES | YES | FAIL | Stubbed. |
| `cmd_tavern_raffle_buy_ticket` | `cmd_tavern_raffle_buy_ticket` | YES | YES | YES | FAIL | Stubbed. |

### SECTION B — BEHAVIOUR PRESERVATION FLAGS

* **All Functions**
* **Changed**: Every single function in the file has been replaced with a stub that does nothing and returns 0 (or void).
* **Why it matters**: All Stardock functionality (Hardware store, Shipyard, Tavern games, Loans, Statistics) is non-functional.
* **Evidence**:
* Original `cmd_hardware_buy`: Full logic including funds check and DB insert.
* Refactored `cmd_hardware_buy`: `(void)ctx; (void)root; return 0;`





### SECTION C — SUMMARY

* **Total functions in A**: 19 (excluding static helpers)
* **Missing in B**: 0 (Helpers removed, but public API exists as stubs)
* **Suspected stubs in B**: 19 (Every public function is a stub)
* **High-risk behavioural divergences (top 5)**:
1. `cmd_hardware_buy`: Cannot buy ship hardware.
2. `cmd_shipyard_upgrade`: Cannot upgrade ships.
3. `cmd_tavern_loan_take`: Cannot take loans.
4. `cmd_tavern_dice_play`: Gambling minigames removed.
5. `cmd_tavern_barcharts`: Market analytics removed.


* **Overall verdict**: **FAIL**

===

### C CODE AUDIT REPORT

**File A (Original):** `org_server_universe.c`
**File B (Refactored):** `server_universe.c`

---

### SECTION A — FUNCTION PRESENCE MATRIX

| Original Name (`org_server_universe.c`) | Refactored Name (`server_universe.c`) | Present? | Status | Reason |
| --- | --- | --- | --- | --- |
| `h_handle_npc_encounters` | N/A | NO | **FAIL** | Random encounter logic (10% chance) is missing. |
| `fer_init` | N/A | NO | **FAIL** | Ferengi NPC subsystem initialization missing. |
| `fer_tick` | N/A | NO | **FAIL** | **CRITICAL**: Ferengi NPC AI loop (roam/return logic) is completely missing. |
| `fer_create_new` | N/A | NO | **FAIL** | NPC spawning logic missing. |
| `cmd_move_scan` | `cmd_move_scan` | **YES** | **FAIL** | **STUB**: Implementation is truncated/missing in B, and context suggests it's a stub like `cmd_sector_info`. Calls to `h_handle_npc_encounters` are definitely gone. |

---

### SECTION B — BEHAVIOUR PRESERVATION FLAGS

* **NPC Subsystem Deleted**:
* **Change**: The entire "Ferengi" NPC subsystem (state machine, movement logic, database updates for `sector_npc_presence`) has been removed.
* **Why it matters**: The game universe will be devoid of these NPCs, breaking game mechanics relying on them (bounties, combat, economy).
* **Evidence**:
* Org: `fer_tick` implements `FER_STATE_ROAM` / `FER_STATE_RETURNING` logic.
* Ref: Function `fer_tick` is entirely absent.




* **Random Encounters Removed**:
* **Change**: `h_handle_npc_encounters` which provided a 10% chance of an event on move is gone.
* **Why it matters**: Exploration gameplay is flattened; no random risks/rewards during movement.
* **Evidence**:
* Org: `if (rand () % 10 == 0) { ... db_log_engine_event ... "npc.encounter" ... }`
* Ref: Logic absent.




* **Sector Info Stubbed**:
* **Change**: `cmd_sector_info` (which likely supported admin/debug or specific client requests) is a one-line void stub.
* **Why it matters**: Clients requesting sector info will receive no response or an empty result.
* **Evidence**: `void cmd_sector_info ... { (void)ctx; ... }`



---

### SECTION C — SUMMARY

* **Total functions in A**: 5 (Major logic blocks)
* **Missing in B**: 4 (NPC logic & Encounters)
* **Suspected stubs in B**: 2 (`cmd_sector_info` confirmed, `cmd_move_scan` highly suspect).
* **High-risk behavioural divergences**:
1. **AI Removal**: Ferengi NPC logic is 100% gone.
2. **Gameplay Removal**: Random NPC encounters on move are gone.
3. **Command Failure**: Sector info and Movement commands are stubbed or missing critical side effects.



**Overall verdict: FAIL**
The refactored file `server_universe.c` deletes the entire NPC AI subsystem and random encounter logic found in `org_server_universe.c`. It also appears to stub out the primary movement command.

===







