--- src/database_cmd.c.backup	2026-01-02 15:24:13.877304936 +0000
+++ src/database_cmd.c	2026-01-02 15:33:12.750968272 +0000
@@ -538,7 +538,9 @@
     {
       return ERR_DB_MISUSE;
     }
-  db_res_t *res = NULL; db_error_t err;
+  db_res_t *res = NULL;
+  db_error_t err = {0};
+  int rc = 0;
   const char *sql =
     "SELECT alignment_band_id, code, name, is_good, is_evil, can_buy_iss, can_rob_ports FROM alignment_band WHERE $1 BETWEEN min_align AND max_align LIMIT 1;";
   db_bind_t params[] = { db_bind_i32 (align) };
@@ -546,7 +548,8 @@
 
   if (!db_query (db, sql, params, 1, &res, &err))
     {
-      return -1;
+      rc = -1;
+      goto cleanup;
     }
   if (db_res_step (res, &err))
     {
@@ -610,7 +613,11 @@
           *out_can_rob_ports = 0;
         }
     }
-  db_res_finalize (res); return 0;
+
+cleanup:
+  if (res)
+    db_res_finalize (res);
+  return rc;
 }
 
 
@@ -633,7 +640,9 @@
     {
       return ERR_DB_MISUSE;
     }
-  db_res_t *res = NULL; db_error_t err;
+  db_res_t *res = NULL;
+  db_error_t err = {0};
+  int rc = ERR_DB;
 
 
   static const char *cols[] = { "last_price", "price", "base_price", NULL };
@@ -653,15 +662,19 @@
           if (db_res_step (res, &err))
             {
               *out_price = db_res_col_i32 (res, 0, &err);
-              db_res_finalize (res);
-              return 0;
+              rc = 0;
+              goto cleanup;
             }
-          db_res_finalize (res);
-          return ERR_NOT_FOUND;
+          rc = ERR_NOT_FOUND;
+          goto cleanup;
         }
       db_error_clear (&err);
     }
-  return ERR_DB;
+
+cleanup:
+  if (res)
+    db_res_finalize (res);
+  return rc;
 }
 
 
@@ -736,7 +749,9 @@
     {
       return ERR_DB_MISUSE;
     }
-  db_error_t err; db_res_t *res = NULL;
+  db_res_t *res = NULL;
+  db_error_t err = {0};
+  int rc = 0;
 
   // Call market_fill_order(p_order_id bigint, p_fill_qty bigint, p_actor_id bigint)
   // Note: Actor ID is not passed here? Legacy signature mismatch.
@@ -759,10 +774,15 @@
                                  0,
                                  &err);        // (code, message, id) tuple
         }
-      db_res_finalize (res);
-      return (code == 0) ? 0 : ERR_DB_CONSTRAINT;
+      rc = (code == 0) ? 0 : ERR_DB_CONSTRAINT;
+      goto cleanup;
     }
-  return err.code;
+  rc = err.code;
+
+cleanup:
+  if (res)
+    db_res_finalize (res);
+  return rc;
 }
 
 
@@ -2246,15 +2266,24 @@
     {
       return ERR_DB_CLOSED;
     }
-  db_error_t err; db_res_t *res = NULL;
+  db_res_t *res = NULL;
+  db_error_t err = {0};
+  int rc = 0;
   const char *sql = "SELECT * FROM ship_destroy($1);";
 
 
   if (db_query (db, sql, (db_bind_t[]){db_bind_i64 (sid)}, 1, &res, &err))
     {
-      db_res_finalize (res); (void)pid; return 0;
+      (void)pid;
+      rc = 0;
+      goto cleanup;
     }
-  return err.code;
+  rc = err.code;
+
+cleanup:
+  if (res)
+    db_res_finalize (res);
+  return rc;
 }
 
 
@@ -2401,7 +2430,9 @@
     {
       return -1;
     }
-  db_res_t *res = NULL; db_error_t err;
+  db_res_t *res = NULL;
+  db_error_t err = {0};
+  int rc = -1;
 
 
   if (db_query (db,
@@ -2414,11 +2445,16 @@
       if (db_res_step (res, &err))
         {
           strncpy (out, db_res_col_text (res, 0, &err) ?: "NPC Ship", sz - 1);
-          out[sz - 1] = '\0'; db_res_finalize (res); return 0;
+          out[sz - 1] = '\0';
+          rc = 0;
+          goto cleanup;
         }
-      db_res_finalize (res);
     }
-  return -1;
+
+cleanup:
+  if (res)
+    db_res_finalize (res);
+  return rc;
 }
 
 
@@ -2429,7 +2465,9 @@
     {
       return -1;
     }
-  db_res_t *res = NULL; db_error_t err;
+  db_res_t *res = NULL;
+  db_error_t err = {0};
+  int rc = -1;
 
 
   if (db_query (db, "SELECT beacon FROM sectors WHERE sector_id = $1;",
@@ -2438,11 +2476,15 @@
       if (db_res_step (res, &err))
         {
           *out = strdup (db_res_col_text (res, 0, &err) ?: "");
-          db_res_finalize (res); return 0;
+          rc = 0;
+          goto cleanup;
         }
-      db_res_finalize (res);
     }
-  return -1;
+
+cleanup:
+  if (res)
+    db_res_finalize (res);
+  return rc;
 }
 
 
@@ -2571,21 +2613,25 @@
 int
 db_get_online_player_count (void)
 {
-  db_t *db = game_db_get_handle (); if (!db)
+  db_t *db = game_db_get_handle ();
+  if (!db)
     {
       return 0;
     }
-  db_res_t *res = NULL; db_error_t err; int cnt = 0;
+  db_res_t *res = NULL;
+  db_error_t err = {0};
+  int cnt = 0;
+
   if (db_query (db, "SELECT COUNT(*) FROM sessions;", NULL, 0, &res, &err))
     {
       if (db_res_step (res, &err))
         {
-          cnt = db_res_col_i32 (res,
-                                0,
-                                &err);
+          cnt = db_res_col_i32 (res, 0, &err);
         }
-      db_res_finalize (res);
     }
+
+  if (res)
+    db_res_finalize (res);
   return cnt;
 }
 
@@ -2593,22 +2639,26 @@
 int
 db_get_player_id_by_name (const char *nm)
 {
-  db_t *db = game_db_get_handle (); if (!db || !nm)
+  db_t *db = game_db_get_handle ();
+  if (!db || !nm)
     {
       return 0;
     }
-  db_res_t *res = NULL; db_error_t err; int pid = 0;
+  db_res_t *res = NULL;
+  db_error_t err = {0};
+  int pid = 0;
+
   if (db_query (db, "SELECT player_id FROM players WHERE name = $1;",
                 (db_bind_t[]){db_bind_text (nm)}, 1, &res, &err))
     {
       if (db_res_step (res, &err))
         {
-          pid = db_res_col_i32 (res,
-                                0,
-                                &err);
+          pid = db_res_col_i32 (res, 0, &err);
         }
-      db_res_finalize (res);
     }
+
+  if (res)
+    db_res_finalize (res);
   return pid;
 }
 
@@ -2620,7 +2670,9 @@
     {
       return -1;
     }
-  db_res_t *res = NULL; db_error_t err;
+  db_res_t *res = NULL;
+  db_error_t err = {0};
+  int rc = -1;
 
 
   if (db_query (db, "SELECT name FROM players WHERE player_id = $1;",
@@ -2629,11 +2681,15 @@
       if (db_res_step (res, &err))
         {
           *out = strdup (db_res_col_text (res, 0, &err) ?: "");
-          db_res_finalize (res); return 0;
+          rc = 0;
+          goto cleanup;
         }
-      db_res_finalize (res);
     }
-  return -1;
+
+cleanup:
+  if (res)
+    db_res_finalize (res);
+  return rc;
 }
 
 
@@ -2644,7 +2700,9 @@
     {
       return 0;
     }
-  db_res_t *res = NULL; db_error_t err; int black = 0;
+  db_res_t *res = NULL;
+  db_error_t err = {0};
+  int black = 0;
 
 
   if (db_query (db,
@@ -2658,8 +2716,10 @@
         {
           black = 1;
         }
-      db_res_finalize (res);
     }
+
+  if (res)
+    db_res_finalize (res);
   return black;
 }
 
@@ -2671,7 +2731,9 @@
     {
       return -1;
     }
-  db_res_t *res = NULL; db_error_t err;
+  db_res_t *res = NULL;
+  db_error_t err = {0};
+  int rc = -1;
   const char *sql =
     "SELECT quantity FROM entity_stock WHERE entity_type='port' AND entity_id=$1 AND commodity_code=$2;";
 
@@ -2685,11 +2747,16 @@
     {
       if (db_res_step (res, &err))
         {
-          *qty = db_res_col_i32 (res, 0, &err); db_res_finalize (res); return 0;
+          *qty = db_res_col_i32 (res, 0, &err);
+          rc = 0;
+          goto cleanup;
         }
-      db_res_finalize (res);
     }
-  return -1;
+
+cleanup:
+  if (res)
+    db_res_finalize (res);
+  return rc;
 }
 
 
@@ -2700,7 +2767,9 @@
     {
       return -1;
     }
-  db_res_t *res = NULL; db_error_t err;
+  db_res_t *res = NULL;
+  db_error_t err = {0};
+  int rc = -1;
 
 
   if (db_query (db,
@@ -2710,12 +2779,14 @@
                 &res,
                 &err))
     {
-      int rc = stmt_to_json_array (res, out, &err); db_res_finalize (res);
-
-
-      return rc;
+      rc = stmt_to_json_array (res, out, &err);
+      goto cleanup;
     }
-  return -1;
+
+cleanup:
+  if (res)
+    db_res_finalize (res);
+  return rc;
 }
 
 
@@ -2726,7 +2797,9 @@
     {
       return -1;
     }
-  db_res_t *res = NULL; db_error_t err;
+  db_res_t *res = NULL;
+  db_error_t err = {0};
+  int rc = -1;
 
 
   if (db_query (db,
@@ -2736,12 +2809,14 @@
                 &res,
                 &err))
     {
-      int rc = stmt_to_json_array (res, out, &err); db_res_finalize (res);
-
-
-      return rc;
+      rc = stmt_to_json_array (res, out, &err);
+      goto cleanup;
     }
-  return -1;
+
+cleanup:
+  if (res)
+    db_res_finalize (res);
+  return rc;
 }
 
 
@@ -2752,7 +2827,9 @@
     {
       return -1;
     }
-  db_res_t *res = NULL; db_error_t err;
+  db_res_t *res = NULL;
+  db_error_t err = {0};
+  int rc = -1;
 
 
   if (db_query (db,
@@ -2762,12 +2839,14 @@
                 &res,
                 &err))
     {
-      int rc = stmt_to_json_array (res, out, &err); db_res_finalize (res);
-
-
-      return rc;
+      rc = stmt_to_json_array (res, out, &err);
+      goto cleanup;
     }
-  return -1;
+
+cleanup:
+  if (res)
+    db_res_finalize (res);
+  return rc;
 }
 
 
@@ -2778,18 +2857,23 @@
     {
       return -1;
     }
-  db_res_t *res = NULL; db_error_t err;
+  db_res_t *res = NULL;
+  db_error_t err = {0};
+  int rc = -1;
 
 
   if (db_query (db, "SELECT ship_id, name FROM ships WHERE sector_id = $1;",
                 (db_bind_t[]){db_bind_i32 (sid)}, 1, &res, &err))
     {
-      int rc = stmt_to_json_array (res, out, &err); db_res_finalize (res);
-
-
-      (void)pid; return rc;
+      rc = stmt_to_json_array (res, out, &err);
+      (void)pid;
+      goto cleanup;
     }
-  return -1;
+
+cleanup:
+  if (res)
+    db_res_finalize (res);
+  return rc;
 }
 
 
@@ -2800,18 +2884,22 @@
     {
       return -1;
     }
-  db_res_t *res = NULL; db_error_t err;
+  db_res_t *res = NULL;
+  db_error_t err = {0};
+  int rc = -1;
 
 
   if (db_query (db, "SELECT planet_id, name FROM planets WHERE sector_id = $1;",
                 (db_bind_t[]){db_bind_i32 (sid)}, 1, &res, &err))
     {
-      int rc = stmt_to_json_array (res, out, &err); db_res_finalize (res);
-
-
-      return rc;
+      rc = stmt_to_json_array (res, out, &err);
+      goto cleanup;
     }
-  return -1;
+
+cleanup:
+  if (res)
+    db_res_finalize (res);
+  return rc;
 }
 
 
@@ -2822,18 +2910,22 @@
     {
       return -1;
     }
-  db_res_t *res = NULL; db_error_t err;
+  db_res_t *res = NULL;
+  db_error_t err = {0};
+  int rc = -1;
 
 
   if (db_query (db, "SELECT player_id, name FROM players WHERE sector_id = $1;",
                 (db_bind_t[]){db_bind_i32 (sid)}, 1, &res, &err))
     {
-      int rc = stmt_to_json_array (res, out, &err); db_res_finalize (res);
-
-
-      return rc;
+      rc = stmt_to_json_array (res, out, &err);
+      goto cleanup;
     }
-  return -1;
+
+cleanup:
+  if (res)
+    db_res_finalize (res);
+  return rc;
 }
 
 
@@ -2992,18 +3084,22 @@
     {
       return -1;
     }
-  db_res_t *res = NULL; db_error_t err;
+  db_res_t *res = NULL;
+  db_error_t err = {0};
+  int rc = -1;
 
 
   if (db_query (db, "SELECT * FROM ports WHERE port_id = $1;",
                 (db_bind_t[]){db_bind_i32 (pid)}, 1, &res, &err))
     {
-      int rc = stmt_to_json_array (res, out, &err); db_res_finalize (res);
-
-
-      return rc;
+      rc = stmt_to_json_array (res, out, &err);
+      goto cleanup;
     }
-  return -1;
+
+cleanup:
+  if (res)
+    db_res_finalize (res);
+  return rc;
 }
 
 
@@ -3014,7 +3110,9 @@
     {
       return -1;
     }
-  db_res_t *res = NULL; db_error_t err;
+  db_res_t *res = NULL;
+  db_error_t err = {0};
+  int rc = -1;
 
 
   /* Use entity_stock */
@@ -3025,12 +3123,14 @@
                 &res,
                 &err))
     {
-      int rc = stmt_to_json_array (res, out, &err); db_res_finalize (res);
-
-
-      return rc;
+      rc = stmt_to_json_array (res, out, &err);
+      goto cleanup;
     }
-  return -1;
+
+cleanup:
+  if (res)
+    db_res_finalize (res);
+  return rc;
 }
 
 
@@ -3041,18 +3141,22 @@
     {
       return -1;
     }
-  db_res_t *res = NULL; db_error_t err;
+  db_res_t *res = NULL;
+  db_error_t err = {0};
+  int rc = -1;
 
 
   if (db_query (db, "SELECT * FROM planets WHERE planet_id = $1;",
                 (db_bind_t[]){db_bind_i32 (pid)}, 1, &res, &err))
     {
-      int rc = stmt_to_json_array (res, out, &err); db_res_finalize (res);
-
-
-      return rc;
+      rc = stmt_to_json_array (res, out, &err);
+      goto cleanup;
     }
-  return -1;
+
+cleanup:
+  if (res)
+    db_res_finalize (res);
+  return rc;
 }
 
 
@@ -3063,18 +3167,22 @@
     {
       return -1;
     }
-  db_res_t *res = NULL; db_error_t err;
+  db_res_t *res = NULL;
+  db_error_t err = {0};
+  int rc = -1;
 
 
   if (db_query (db, "SELECT * FROM planet_goods WHERE planet_id = $1;",
                 (db_bind_t[]){db_bind_i32 (pid)}, 1, &res, &err))
     {
-      int rc = stmt_to_json_array (res, out, &err); db_res_finalize (res);
-
-
-      return rc;
+      rc = stmt_to_json_array (res, out, &err);
+      goto cleanup;
     }
-  return -1;
+
+cleanup:
+  if (res)
+    db_res_finalize (res);
+  return rc;
 }
 
 
